<?xml version="1.0"?>

<!--
  NOTE: This copyright does *not* cover user programs that use HQ
  program services by normal system calls through the application
  program interfaces provided as part of the Hyperic Plug-in Development
  Kit or the Hyperic Client Development Kit - this is merely considered
  normal use of the program, and does *not* fall under the heading of
  "derived work".
  
  Copyright (C) [2004, 2005, 2006], Hyperic, Inc.
  This file is part of HQ.
  
  HQ is free software; you can redistribute it and/or modify
  it under the terms version 2 of the GNU General Public License as
  published by the Free Software Foundation. This program is distributed
  in the hope that it will be useful, but WITHOUT ANY WARRANTY; without
  even the implied warranty of MERCHANTABILITY or FITNESS FOR A
  PARTICULAR PURPOSE. See the GNU General Public License for more
  details.
  
  You should have received a copy of the GNU General Public License
  along with this program; if not, write to the Free Software
  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307
  USA.
 -->

<plugin package="org.hyperic.hq.plugin.postgresql">
  <!-- we use a dummy jmx object name -->
  <filter name="domain" value="postgresql"/>

  <!-- appended to each template by MeasurementInfoXML -->
  <property name="template-config"
            value="jdbcUrl=%jdbcUrl%,jdbcUser=%jdbcUser%,jdbcPassword=%jdbcPassword%"/>

  <metrics name="pg-server">
    <metric name="Availability"
            alias="Availability"
            template="${domain}:Type=Server:availability"
            category="AVAILABILITY"
            indicator="true"
            units="percentage"
            collectionType="dynamic"/>
    <metric name="Backends"
            alias="NumBackends"
            template="${domain}:Type=Server:numbackends"
            category="UTILIZATION"
            indicator="true"
            units="none"
            collectionType="dynamic"/>
    <metric name="Locks Held"
            alias="LocksHeld"
            template="${domain}:Type=Server:${alias}"
            category="UTILIZATION"
            units="none"
            collectionType="dynamic"/>
    <metric name="Data Space Used"
            alias="DataSpaceUsed"
            template="${domain}:Type=Server:${alias}"
            category="UTILIZATION"
            indicator="true"
            units="KB"
            collectionType="dynamic"/>
    <metric name="Index Space Used"
            alias="IndexSpaceUsed"
            template="${domain}:Type=Server:${alias}"
            category="UTILIZATION"
            units="KB"
            collectionType="dynamic"/>
    <metric name="Commits"
            alias="Commits"
            template="${domain}:Type=Server:xact_commit"
            category="THROUGHPUT"
            indicator="true"
            units="none"
            collectionType="trendsup"/>
    <metric name="Rollbacks"
            alias="Rollbacks"
            template="${domain}:Type=Server:xact_rollback"
            category="THROUGHPUT"
            units="none"
            collectionType="trendsup"/>
    <metric name="Blocks Read"
            alias="BlocksRead"
            template="${domain}:Type=Server:blks_read"
            category="THROUGHPUT"
            indicator="true"
            units="none"
            collectionType="trendsup"/>
    <metric name="Buffer Hits"
            alias="BufferHits"
            template="${domain}:Type=Server:blks_hit"
            category="THROUGHPUT"
            units="none"
            collectionType="trendsup"/>
  </metrics>

  <metrics name="pg-table">
    <metric name="Availability"
            alias="Availability"
            template="${domain}:Type=Table,table=%table%:availability"
            category="AVAILABILITY"
            indicator="true"
            units="percentage"
            collectionType="dynamic"/>
    <metric name="Sequential Scans"
            alias="SequentialScans"
            template="${domain}:Type=Table,table=%table%:seq_scan"
            category="UTILIZATION"
            indicator="true"
            units="none"
            collectionType="trendsup"/>
    <metric name="Index Scans"
            alias="IndexScans"
            template="${domain}:Type=Table,table=%table%:idx_scan"
            category="UTILIZATION"
            units="none"
            collectionType="trendsup"/>
    <metric name="Sequential Scan Rows Read"
            alias="SeqScanRowsRead"
            template="${domain}:Type=Table,table=%table%:seq_tup_read"
            category="UTILIZATION"
            units="none"
            collectionType="trendsup"/>
    <metric name="Index Scan Rows Read"
            alias="IdxScanRowsRead"
            template="${domain}:Type=Table,table=%table%:idx_tup_fetch"
            category="UTILIZATION"
            units="none"
            collectionType="trendsup"/>
    <metric name="Data Space Used"
            alias="DataSpaceUsed"
            template="${domain}:Type=Table,table=%table%:${alias}"
            category="UTILIZATION"
            indicator="true"
            units="KB"
            collectionType="dynamic"/>
    <metric name="Index Space Used"
            alias="IndexSpaceUsed"
            template="${domain}:Type=Table,table=%table%:${alias}"
            category="UTILIZATION"
            indicator="true"
            units="KB"
            collectionType="dynamic"/>
    <metric name="Number Of Row Inserts"
            alias="NumRowInserts"
            template="${domain}:Type=Table,table=%table%:n_tup_ins"
            category="THROUGHPUT"
            indicator="true"
            units="none"
            collectionType="trendsup"/>
    <metric name="Number Of Row Updates"
            alias="NumRowUpdates"
            template="${domain}:Type=Table,table=%table%:n_tup_upd"
            category="THROUGHPUT"
            units="none"
            collectionType="trendsup"/>
    <metric name="Number Of Row Deletes"
            alias="NumRowDeletes"
            template="${domain}:Type=Table,table=%table%:n_tup_del"
            category="THROUGHPUT"
            units="none"
            collectionType="trendsup"/>
  </metrics>

  <metrics name="pg-index">
    <metric name="Availability"
            alias="Availability"
            template="${domain}:Type=Index,index=%index%:availability"
            category="AVAILABILITY"
            indicator="true"
            units="percentage"
            collectionType="dynamic"/>
    <metric name="Index Scans"
            alias="IndexScans"
            template="${domain}:Type=Index,index=%index%:idx_scan"
            category="UTILIZATION"
            indicator="true"
            units="none"
            collectionType="trendsup"/>
    <metric name="Index Reads"
            alias="IndexReads"
            template="${domain}:Type=Index,index=%index%:idx_tup_read"
            category="UTILIZATION"
            indicator="true"
            units="none"
            collectionType="trendsup"/>
    <metric name="Index Fetches"
            alias="IndexFetches"
            template="${domain}:Type=Index,index=%index%:idx_tup_fetch"
            category="UTILIZATION"
            indicator="false"
            units="none"
            collectionType="trendsup"/>
  </metrics>

  <!-- ==================== Plugin Help =========================== -->

  <help name="PostgreSQL">
    <![CDATA[
    <p>
    <h3>Configure PostgreSQL ${product.version} for Monitoring</h3>
    </p>
    <p>
    Monitoring of PostgreSQL is done through the statistics collector.  For
    PostgreSQL to collect these metrics, they must be enabled by modifying
    the statistics parameters in postgresql.conf.
    </p>
    <p>
    The parameters required for monitoring are as follows:<br>
    </p>
    <ul>
      <li><b>stats_start_collector = true</b></li>
      <li><b>stats_block_level = true</b></li>
      <li><b>stats_row_level = true</b></li>
    </ul>
    <p>
    An optional setting is to set <b>stats_reset_on_server_start = 
    false</b> so that a database restart will not cause gaps in the
    monitoring data.</p>

    <p>
    Make sure to restart PostgreSQL after making the changes to
    postgresql.conf.</p>

    <p>
    Also note that some metrics like 'Index Space Used' and 'Database
    Space Used' will only be incremented after vacuum or analyze is
    run.</p>

    <p>
    For more information see the <a href="http://www.postgresql.org/docs/">
    PostgreSQL Documentation</a>
    </p>
    ]]>
  </help>  

  <help name="PostgreSQL 7.4" include="PostgreSQL"/>
  <help name="PostgreSQL 8.0" include="PostgreSQL"/>
  <help name="PostgreSQL 8.1" include="PostgreSQL"/>

  <server name="PostgreSQL" 
          version="7.4">

    <plugin type="measurement"
            class="PostgreSQLMeasurementPlugin"/>

    <plugin type="autoinventory"
            class="PostgreSQLServerDetector"/>

    <plugin type="control"
            class="PostgreSQLControlPlugin"/>

    <actions include="Analyze,ResetStatistics,Vacuum,VacuumAnalyze"/>

    <metrics include="pg-server"/>

    <scan registry="SYSTEM\CurrentControlSet\Services\pgsql-*">
      <include name="ImagePath"/>
    </scan>

    <scan registry="SYSTEM\CurrentControlSet\Services\hyperic-hq-database"/>

    <scan type="file">
      <include name="/**/bin/postgres"/>
    </scan>

    <properties>
       <property name="version"
                 description="PostgreSQL Version"/>
    </properties>

    <config>
      <option name="jdbcUrl"
              description="JDBC Connection URL"
              default="jdbc:postgresql://localhost/hq"/>
      <option name="jdbcUser"
              description="JDBC User"
              default="postgres"/>
      <option name="jdbcPassword" type="secret"
              optional="true"
              description="JDBC Password"/>
    </config>

    <service name="Table">
      <plugin type="control"
              class="PostgreSQLControlPlugin"/>

      <actions include="Analyze,Vacuum,VacuumAnalyze,Reindex"/>

      <config>
        <option name="table"
                description="Table Name"/>
      </config>

      <metrics include="pg-table"/>
    </service>

    <service name="Index">
      <plugin type="control"
              class="PostgreSQLControlPlugin"/>

      <actions include="Reindex"/>

      <config>
        <option name="index"
                description="Index Name"/>
      </config>

      <metrics include="pg-index"/>
    </service>
  </server>

  <!-- Define 8.0 server type -->
  <server name="PostgreSQL"
          version="8.0"
          include="7.4"/>

  <!-- Define 8.1 server type -->
  <server name="PostgreSQL"
          version="8.1"
          include="8.0"/>

</plugin>
