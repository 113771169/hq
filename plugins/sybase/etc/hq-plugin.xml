<?xml version="1.0"?>

<!--
  NOTE: This copyright does *not* cover user programs that use HQ
  program services by normal system calls through the application
  program interfaces provided as part of the Hyperic Plug-in Development
  Kit or the Hyperic Client Development Kit - this is merely considered
  normal use of the program, and does *not* fall under the heading of
  "derived work".
  
  Copyright (C) [2004, 2005, 2006], Hyperic, Inc.
  This file is part of HQ.
  
  HQ is free software; you can redistribute it and/or modify
  it under the terms version 2 of the GNU General Public License as
  published by the Free Software Foundation. This program is distributed
  in the hope that it will be useful, but WITHOUT ANY WARRANTY; without
  even the implied warranty of MERCHANTABILITY or FITNESS FOR A
  PARTICULAR PURPOSE. See the GNU General Public License for more
  details.
  
  You should have received a copy of the GNU General Public License
  along with this program; if not, write to the Free Software
  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307
  USA.
 -->

<plugin package="org.hyperic.hq.plugin.sybase">
  <classpath>
    <include name="pdk/lib/jdbc/jconn3.jar"/>
  </classpath>

  <!-- we use a dummy jmx object name -->
  <filter name="domain" value="sybase"/>

  <!-- appended to each template by MeasurementInfoXML -->
  <property name="template-config"
            value="jdbcUrl=%jdbcUrl%,jdbcUser=%jdbcUser%,jdbcPassword=%jdbcPassword%"/>

  <filter name="sysmon_script"
          value="pdk/work/scripts/sybase/get_sysmon_stats.pl"/>

  <filter name="template"
          value="${domain}:Type=Server:${alias}"/>
  <metrics name="ServerMetrics">
    <metric name="Availability"
            category="AVAILABILITY"
            indicator="true"
            units="percentage"
            collectionType="dynamic"/>

  </metrics>

  <filter name="template"
          value="${domain}:Type=Service,instance=%instance%:${alias}"/>
  <metrics name="Sybase 12.x Instance">
    <metric name="Availability"
            category="AVAILABILITY"
            indicator="true"
            units="percentage"
            collectionType="dynamic"/>

    <metric name="Number of Transactions"
            category="THROUGHPUT"
            indicator="true"
            units="none"
            collectionType="trendsup"/>

    <metric name="Number of User Tables"
            category="UTILIZATION"
            units="none"
            collectionType="trendsup"/>

    <metric name="Number of Active Locks"
            category="UTILIZATION"
            units="none"
            collectionType="dynamic"/>

    <metric name="Number of Active Page Locks"
            category="UTILIZATION"
            units="none"
            collectionType="dynamic"/>

    <metric name="Number of Active Table Locks"
            category="UTILIZATION"
            units="none"
            collectionType="dynamic"/>

    <metric name="Number of Servers"
            category="UTILIZATION"
            units="none"
            collectionType="dynamic"/>

    <metric name="Number of Active Users"
            category="UTILIZATION"
            units="none"
            collectionType="dynamic"/>

    <metric name="Number of Local Transactions"
            category="THROUGHPUT"
            units="none"
            collectionType="trendsup"/>

    <metric name="Number of External Transactions"
            category="THROUGHPUT"
            units="none"
            collectionType="trendsup"/>

    <metric name="Instance Used Space"
            category="UTILIZATION"
            units="B"
            collectionType="dynamic"/>

    <metric name="Instance Free Space"
            category="UTILIZATION"
            units="B"
            collectionType="dynamic"/>

    <metric name="Instance Total Space"
            category="UTILIZATION"
            units="B"
            collectionType="dynamic"/>

    <metric name="Up Time"
            category="AVAILABILITY"
            units="ms"
            collectionType="static"/>

    <metric name="Number of Indexes"
            category="UTILIZATION"
            units="none"
            collectionType="dynamic"/>

    <metric name="Number of Tx Logs"
            category="UTILIZATION"
            units="none"
            collectionType="dynamic"/>
  </metrics>

  <filter name="template">
    exec:timeout=%timeout%,file=${sysmon_script},args=-s %serverName% -i %interval% -u %jdbcUser% -p '%jdbcPassword%':${alias}
  </filter>
  <metrics name="SybaseAvailability">
    <metric name="Availability"
            category="AVAILABILITY"
            units="percentage"
            indicator="true"
            collectionType="dynamic"/>
  </metrics>

  <metrics name="sp_sysmon">
    <metric name="Deadlocks"
            category="THROUGHPUT"
            indicator="true"
            collectionType="dynamic"/>
    <metric name="Avg Lock Contention"
            category="THROUGHPUT"
            indicator="true"
            collectionType="dynamic"/>
    <metric name="TDS Packets Sent"
            category="THROUGHPUT"
            indicator="true"
            collectionType="dynamic"/>
    <metric name="TDS Packets Received"
            category="THROUGHPUT"
            indicator="true"
            collectionType="dynamic"/>
    <metric name="Total Cache Misses Ratio"
            category="THROUGHPUT"
            indicator="true"
            units="percentage"
            collectionType="dynamic"/>
    <metric name="Total Cache Hits Ratio"
            category="THROUGHPUT"
            indicator="true"
            units="percentage"
            collectionType="dynamic"/>
  </metrics>

  <server name="Sybase"
          version="12.5.x">
    <plugin type="measurement"
            class="SybaseMeasurementPlugin"/>
    <plugin type="autoinventory"
            class="SybaseServerDetector"/>
    <metrics include="SybaseAvailability"/>
    <metrics include="ServerMetrics"/>
    <metrics include="sp_sysmon"/>

    <config>
      <option name="jdbcUrl"
              description="JDBC Url"
              default="jdbc:sybase:Tds:localhost:4100/master"/>
      <option name="jdbcUser"
              description="JDBC User"
              default="sa"/>
      <option name="jdbcPassword" type="secret"
              optional="true"
              description="JDBC Password"/>
      <option name="serverName"
              description="Sybase Server Name"
              default="LOCALHOST"/>
      <option name="interval"
              description="sp_sysmon interval"
              default="00:05:00"/>
      <option name="timeout"
              description="Timeout for sp_sysmon, must be greater than the interval"
              default="3500"/>
    </config>

    <service name="sp_sysmonEngine">
      <config>
        <option name="engine"
                description="Sybase Engine Stats"/>
      </config>
      <metrics include="SybaseAvailability"/>
      <filter name="template">
        exec:timeout=%timeout%,file=${sysmon_script},args=-s %serverName% -i %interval% -u %jdbcUser% -p '%jdbcPassword%':%engine%.${alias}
      </filter>
      <metrics>
        <metric name="Engine Utilization"
                category="THROUGHPUT"
                indicator="true"
                units="percentage"
                collectionType="dynamic"/>
      </metrics>
    </service>

    <service name="storage">
      <plugin type="autoinventory"
              class="SybaseServerDetector"/>
      <plugin type="measurement"
              class="SybaseMeasurementPlugin"/>
      <config>
        <option name="database"
                description="Sybase Database"/>
        <option name="segment"
                description="Sybase Segment"/>
        <option name="pagesize"
                description="Sybase Server Pagesize"/>
      </config>
      <metrics include="SybaseAvailability"/>
      <filter name="template">
        ${domain}:Type=storage,database=%database%,segment=%segment%,pagesize=%pagesize%:${alias}
      </filter>
      <metrics>
        <metric name="Storage Used"
                category="UTILIZATION"
                indicator="true"
                units="MB"
                collectionType="dynamic"/>
        <metric name="Percent Used"
                category="UTILIZATION"
                indicator="true"
                units="percentage"
                collectionType="dynamic"/>
      </metrics>
    </service>

    <service name="sp_sysmonCache">
      <plugin type="autoinventory"
              class="SybaseServerDetector"/>
      <plugin type="measurement"
              class="SybaseMeasurementPlugin"/>
      <config>
        <option name="cachename"
                description="Name of Cache"/>
      </config>
      <metrics include="SybaseAvailability"/>
      <filter name="template">
        exec:timeout=%timeout%,file=${sysmon_script},args=-s %serverName% -i %interval% -u %jdbcUser% -p '%jdbcPassword%':%cachename%.${alias}
      </filter>
      <metrics>
        <metric name="Cache Hits Ratio"
                category="THROUGHPUT"
                indicator="true"
                units="percentage"
                collectionType="dynamic"/>
        <metric name="Cache Misses Ratio"
                category="THROUGHPUT"
                indicator="true"
                units="percentage"
                collectionType="dynamic"/>
      </metrics>
    </service>

    <service name="sp_monitorconfig">
      <plugin type="autoinventory"
              class="SybaseServerDetector"/>
      <plugin type="measurement"
              class="SybaseMeasurementPlugin"/>
      <config>
        <option name="configoption"
                description="Config Option"/>
      </config>
      <metrics include="SybaseAvailability"/>
      <filter name="template">
        ${domain}:Type=sp_monitorconfig,configoption=%configoption%:${alias}
      </filter>
      <metrics>
        <metric name="Resource Utilization Ratio"
                category="UTILIZATION"
                indicator="true"
                units="percentage"
                collectionType="dynamic"/>
      </metrics>
    </service>
  </server>

  <server name="Sybase"
          version="15.x">
          include="12.5.x"/>
  </server>

  <!-- ==================== Plugin Help =========================== -->
  <help name="Sybase">
    <![CDATA[
    <p>
    <h3>Configure Sybase ${product.version} for Monitoring</h3>
    </p>
    <p>
      Please run the HQ agent on the local Sybase server as the sybase user.
      This is neccessary to get the proper ENV vars setup in order to execute
      the sp_sysmon procedure.
    </p>
    ]]>
  </help>
</plugin>
