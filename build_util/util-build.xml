<?xml version="1.0"?>

<project name="util-build" basedir="..">
  <!-- Build file for common utility targets -->

  <target name="chmod-exec">
    <chmod perm="a+rx">
      <fileset dir="${chmod.dir}">
        <include name="**/bin/*"/>
        <include name="**/sbin/*"/>	
        <include name="**/*.sh"/>
        <include name="**/*.exe"/>
        <include name="**/*.dll"/>
        <include name="**/*.bat"/>
        <include name="**/*.cmd"/>
      </fileset>
    </chmod>
  </target>

  <target name="write-version-file">
    <fail unless="version-file">
        You must define the version-file property before calling the
        write-version-file target.
    </fail>

    <propertyfile file="${version-file}">
      <entry key="version" value="${version}"/>
      <entry key="build.number" value="${build}"/>
      <entry key="build.date" type="date" pattern="MMM dd, yyyy" value="now"/>
      <entry key="build.comment" value="${release.comment}"/>
    </propertyfile>
  </target>

  <target name="default-mode" unless="compress-mode">
    <property name="compress-mode" value="tgz"/>
  </target>

  <target name="compress-dir" depends="init-taskdefs,default-mode">
    <property name="compress-dir" value="${build.dir}/tmp/compress-dir"/>
    <basename file="${archive-dir}" property="archive-base"/>
    <delete dir="${compress-dir}"/>
    <mkdir dir="${compress-dir}/${archive-base}"/>
    <copy todir="${compress-dir}/${archive-base}">
      <fileset dir="${archive-dir}"/>
    </copy>

    <if>
      <equals arg1="${compress-mode}" arg2="zip"/>
      <then>
        <zip destfile="${archive-file}"
             basedir="${compress-dir}"/>
      </then>
      <else>
        <!-- ant tar task doesn't preserve file permissions
             without making you jump through some hoops -->
        <tar tarfile="${archive-file}"
             longfile="gnu"
             compression="gzip">
          <tarfileset dir="${compress-dir}" mode="755">
            <include name="**/bin/*"/>
            <include name="**/*.sh"/>
            <include name="**/*.bat"/>
            <include name="**/*.cmd"/>
            <include name="**/*.sl"/>
            <include name="**/*.dll"/>
          </tarfileset>
          <tarfileset dir="${compress-dir}">
            <exclude name="**/bin/*"/>
            <exclude name="**/*.sh"/>
            <exclude name="**/*.bat"/>
            <exclude name="**/*.cmd"/>
            <exclude name="**/*.sl"/>
            <exclude name="**/*.dll"/>
            <include name="**"/>
          </tarfileset>
        </tar>
      </else>
    </if>

    <if>
      <equals arg1="${remove-archive-dir}" arg2="true"/>
      <then><delete dir="${archive-dir}"/></then>
    </if>
  </target>

</project>
