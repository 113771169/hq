<?xml version="1.0"?>

<project name="test-build" basedir="..">

<property file="${hq.home}/build_util/clover.properties"/>

<target name="init-tests">
  <delete dir="${junitResults.dir}"/>
  <mkdir dir="${junitResults.dir}"/>
</target>

<target name="single-test">
  <fail message="Must specify a test case system property: -Dtestcase=org.hyperic.My_test" unless="testcase"/>
    <echo message="Running Single Test: ${testcase}"/>
    <antcall target="test">
    <param name="single.test" value="true" />
    </antcall>
</target>

<macrodef name="compile-tests">
	<attribute name="classpath.id" />
	<attribute name="src.dir" />
	<attribute name="output.dir" />
	<sequential>
		<mkdir dir="@{output.dir}" />
		<hq-javac destdir="@{output.dir}">
			<classpath refid="@{classpath.id}" />
			<src>
				<dirset dir="@{src.dir}">
					<include name="src/test/java" />
				</dirset>
			</src>
		</hq-javac>
		<copy toDir="@{output.dir}">
			<fileset dir="@{src.dir}/src/test/resources" includes="**/*" erroronmissingdir="false"/>
		</copy>
	</sequential>
</macrodef>


<target name="test" depends="init,init-taskdefs,init-tests">
   <condition property="test.halt" value="false" else="true">
	    <istrue value="${ci.build}"/>
   </condition>
   <echo message="Halt on error or failure: ${test.halt}"/>
   <test.do module.dir="${hq.agent}" compile.classpath.id="agent.compile.classpath"/>
   <test.do module.dir="${hq.agent.handlers}/hq-agent-handler-autoinventory" compile.classpath.id="agent.handler.compile.classpath"/>
   <test.do module.dir="${hq.agent.handlers}/hq-agent-handler-bizapp" compile.classpath.id="agent.handler.compile.classpath"/>
   <test.do module.dir="${hq.agent.handlers}/hq-agent-handler-commands" compile.classpath.id="agent.handler.compile.classpath"/>
   <test.do module.dir="${hq.agent.handlers}/hq-agent-handler-control" compile.classpath.id="agent.handler.compile.classpath"/>
   <test.do module.dir="${hq.agent.handlers}/hq-agent-handler-livedata" compile.classpath.id="agent.handler.compile.classpath"/>
   <test.do module.dir="${hq.agent.handlers}/hq-agent-handler-measurement" compile.classpath.id="agent.handler.compile.classpath"/>
   <test.do module.dir="${hq.pdk.agent}" compile.classpath.id="agent.pdk.compile.classpath"/>
   <test.do module.dir="${hq.common}" compile.classpath.id="shared.compile.classpath"/>
   <test.do module.dir="${hq.util}" compile.classpath.id="shared.compile.classpath"/>
	<test.do module.dir="${hq.pdk.shared}" compile.classpath.id="shared.compile.classpath"/>
	<test.do module.dir="${hq.web}" compile.classpath.id="web.compile.classpath"/>
</target>

<macrodef name="test.do">
	<attribute name="module.dir"/>
	<attribute name="compile.classpath.id"/>
	<sequential>
	<path id="test.compile.classpath">
		<path refid="@{compile.classpath.id}" />
		<path location="@{module.dir}/target/classes" />
	</path>
  	<compile-tests classpath.id="test.compile.classpath" src.dir="@{module.dir}" output.dir="@{module.dir}/target/test-classes" />
	<path id="test.run.classpath">
	    <path refid="test.compile.classpath" />
	 	<path location="@{module.dir}/target/test-classes" />
	</path>
    <test-run classpath.id="test.run.classpath" test.output.dir="@{module.dir}/target/test-classes"/>
</sequential>
</macrodef>

<macrodef name="test-run">
    <attribute name="classpath.id"/>
    <attribute name="test.output.dir"/>
    <sequential>

    <junit reloading="no" fork="true" forkmode="once" printsummary="yes" haltOnError="${test.halt}" haltOnFailure="${test.halt}">
       
    <jvmarg value="-Dtest.halt=${test.halt}"/>
    <classpath refid="@{classpath.id}"/>

       <formatter type="xml"/>

       <test name="${testcase}" todir="${junitResults.dir}" if="single.test" />

       <batchtest todir="${junitResults.dir}" unless="single.test">
           <fileset dir="@{test.output.dir}">
				<include name="**/*Test.class"/>
           </fileset>
      </batchtest>
    </junit>
  </sequential>
  </macrodef>

  

  <target name="clover" depends="clover.pre, clover.instrument, clover.compile, clover.testdb.setup, clover.do, clover.post" description="Executes all tests resulting from a compilation of the test tree returning test coverage metrics."/>

  <target name="clover.pre">
    <delete dir="${clover.output.dir}" quiet="true"/>
    <mkdir dir="${clover.output.dir}"/>
  </target>

  <target name="clover.testdb.setup">
      <property name="unittest-lib" location="${hq.home}/unittest/lib" />
     <antcall target="test-dbsetup">
        <param name="unittest.lib" value="${unittest-lib}"/>
      </antcall>
  </target>

   <target name="clover.do" depends="clover.init, init-tests">
    <path id="clover.run.classpath">
      <pathelement location="${build.dir}/classes"/>
        <path refid="clover.classpath"/>
        <path refid="testjars"/>
    </path>
    <test-run classpath.id="clover.run.classpath" input.dir="${test.clover.dir}"/>
  </target>

    <target name="clover.instrument" depends="clover.init">
      <property name="unittest-lib" location="${hq.home}/unittest/lib" />
      <antcall target="hibernate-prep">
        <param name="unittest.lib" value="${unittest-lib}"/>
      </antcall>
      <antcall target="copy-resources"/>
    <instrument input.dir="${basedir}/src" output.dir="${main.clover.dir}"/>
    <instrument input.dir="${basedir}/unittest/src" output.dir="${test.clover.dir}"/>
  </target>

  <target name="clover.compile" depends="clover.pre,clover.instrument">
    <path id="clover.compile.classpath">
        <path refid="clover.classpath"/>
        <path refid="testjars"/>
        <pathelement location="${build.dir}/tools/txsnatch/classes"/>
    </path>
    <path id="main.src.path">
      <path location="${basedir}/generated-src" />
      <path location="${main.clover.dir}" />
    </path>
    <path id="test.src.path">
	  <path location="${test.clover.dir}" />
	</path>
    <path id="compile.classpath">
      <path refid="alljars" />
      <path refid="testjars" />
    </path>
    <compile-app classpath.id="clover.compile.classpath" srcpath.id="main.src.path" output.dir="${build.dir}/classes"/>
	<compile-test-sources classpath.id="clover.compile.classpath" srcpath.id="test.src.path" output.dir="${build.dir}/classes"/>
  </target>

  <target name="clover.init" depends="init">
    <taskdef resource="cloverlib.xml" classpathref="clover.classpath"/>
  </target>

  <target name="clover.post" depends="clover.init">
    <clover-report initstring="${clover.db.file}">
      <current outfile="${clover.output.dir}/clover.xml">
        <format type="xml"/>
        <testsources dir="${basedir}/unittest/src">
          <include name="**/*.java"/>
          <include name="*.java"/>
        </testsources>
      </current>
    </clover-report>
    <clover-report initstring="${clover.db.file}">
      <current outfile="${clover.output.dir}/html">
        <format type="html"/>
        <testsources dir="${basedir}/unittest/src">
          <include name="**/*.java"/>
          <include name="*.java"/>
        </testsources>
      </current>
    </clover-report>
    <clover-report initstring="${clover.db.file}">
      <current outfile="${clover.output.dir}/clover.pdf" summary="true">
        <format type="pdf"/>
        <testsources dir="${basedir}/unittest/src">
          <include name="**/*.java"/>
          <include name="*.java"/>
        </testsources>
      </current>
    </clover-report>
    <clover-check initstring="${clover.db.file}" target="${clover.coverage}" haltOnFailure="${clover.enforce}">
      <testsources dir="${basedir}/unittest/src">
        <include name="**/*.java"/>
        <include name="*.java"/>
      </testsources>
    </clover-check>
  </target>

  <macrodef name="instrument">
    <attribute name="input.dir"/>
    <attribute name="output.dir"/>
    <sequential>
      <clover-instr initstring="${clover.db.file}" destdir="@{output.dir}" source="1.5">
        <fileset dir="@{input.dir}">
          <include name="**/*.java"/>
        </fileset>
      </clover-instr>
      <copy todir="@{output.dir}">
        <fileset dir="@{input.dir}">
          <exclude name="**/*.java"/>
          <exclude name="*.java"/>
        </fileset>
      </copy>
    </sequential>
  </macrodef>


</project>
