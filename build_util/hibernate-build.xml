<?xml version="1.0"?>

<project name="hibernate-build" basedir="..">

   <!-- Hibernate common targets -->

  <property name="hibernate-static-properties" location="${hq.home}/hq-web/src/main/resources/hibernate.properties" />
  <property name="hibernate-properties" location="${build.dir}/sql/hibernate.properties" />
  <property name="hibernate-hq-config" location="${hq.home}/hq-web/src/main/resources/hibernate/hibernate.hq-cfg-xml" />
  <property name="hibernate-mapping.xslt" location="${hq.home}/hq-web/src/main/resources/hibernate/hibernate-mapping.xsl" /> 
  <property name="hibernate-config.xslt" location="${hq.home}/hq-web/src/main/resources/hibernate/hibernate-config.xsl" />
  <property name="hibernate-jar" location="${hq.home}/thirdparty/lib/hibernate/hibernate3.jar" />
  
  <path id="hibernate-classpath">
    <path refid="alljars" />
    <fileset dir="${thirdparty.lib}/xslt" includes="*.jar" />
  </path>

  <target name="hibernate-check">
    <uptodate property="hibernate.notrequired"
              targetfile="${build.dir}/sql/hibernate/tstamp">
      <srcfiles dir="${hq.home}/hq-web/src/main/resources/sql">
        <include name="**/*.hbm.xml"/>
      </srcfiles>
      <srcfiles dir="${hq.home}/hq-web/src/main/resources">
        <include name="hibernate/**/*.hq-cfg-xml"/>
        <include name="hibernate/**/*.ftl"/>
      </srcfiles>
      <srcfiles dir="${hq.home}">
	    <include name="build.properties" />
	  </srcfiles>
    </uptodate>
  </target>

   <target name="hibernate-clean">
     <delete failonerror="false">
       <fileset dir="${build.dir}/sql">
         <include name="hibernate-*.sql" />
       </fileset>
    </delete>
  </target>

  <target name="common-taskdefs" unless="init-taskdefs.notrequired">
    <taskdef resource="net/sf/antcontrib/antcontrib.properties"
             classpathref="antjars"/>
    <taskdef name="for" classname="net.sf.antcontrib.logic.For"
             classpathref="antjars"/>
  </target>

  <target name="hibernate-init-taskdefs" depends="common-taskdefs"
          unless="hibernate-init-taskdefs.notrequired">
    <taskdef name="hibernatetool"
             classname="org.hibernate.tool.ant.HibernateToolTask"
             classpathref="hibernate-classpath" />
    <property name="hibernate-init-taskdefs.notrequired" value="true"/>
  </target>

  <target name="hibernate-taskdefs" depends="hibernate-init-taskdefs">
    <switch value="${hq.server.ds-mapping}">
      <case value="Oracle8">
        <property name="hyperic.dialect" value="Oracle" />
      </case>
      <case value="Oracle9i">
        <property name="hyperic.dialect" value="Oracle9" />
        <property name="hibernate.dialect" value="org.hyperic.hibernate.dialect.${hyperic.dialect}Dialect" />
      </case>
      <case value="Oracle10g">
        <property name="hyperic.dialect" value="Oracle9" />
        <property name="hibernate.dialect" value="org.hyperic.hibernate.dialect.${hyperic.dialect}Dialect" />
      </case>
      <case value="PostgreSQL">
        <property name="hyperic.dialect" value="PostgreSQL" />
        <property name="hibernate.dialect" value="org.hyperic.hibernate.dialect.${hyperic.dialect}Dialect" />
      </case>
      <case value="MySQL">
		<property name="include.hq.sequence.table" value="true" />
        <property name="hyperic.dialect" value="MySQL5InnoDB" />
        <property name="hibernate.dialect" value="org.hyperic.hibernate.dialect.${hyperic.dialect}Dialect" />
      </case>
      <default>
        <property name="hibernate.dialect" value="org.hibernate.dialect.${hyperic.dialect}Dialect" />
        <fail>
        Unrecognized datasource mapping name: ${hq.server.ds-mapping}
        </fail>
      </default>
    </switch>
  </target>

  <target name="hibernate-prep" depends="hibernate-taskdefs,hibernate-check" unless="hibernate.notrequired">
	 	<property name="hibernate.connection.url" value="${hq.jdbc.url}" />
	    <property name="hibernate.connection.driver_class" value="${hq.jdbc.driver}" />
	    <property name="hibernate.connection.username" value="${hq.jdbc.user}" />
	    <property name="hibernate.connection.password" value="${hq.jdbc.password}" />
		<property name="hq.schema.statement.delimiter" value=";"/>
		<property name="hq.schema.export" value="true"/>
	   

	    <echoproperties destfile="${hibernate-properties}" format="text">
	      <propertyset>
	        <propertyref name="hibernate.dialect"/>
	        <propertyref name="hibernate.connection.url"/>
	        <propertyref name="hibernate.connection.driver_class"/>
	        <propertyref name="hibernate.connection.username"/>
	        <propertyref name="hibernate.connection.password"/>
	        <propertyref name="hibernate.connection.password"/>
	 		<propertyref name="hq.schema.statement.delimiter"/>
			<propertyref name="hq.schema.export"/>
	      </propertyset>
	    </echoproperties>
  </target>

  <target name="hibernate-schema-create-init">
    <delete failonerror="false" file="${build.dir}/sql/hibernate-create.sql" />
    <mkdir dir="${build.dir}/sql" />
  </target>

  <target name="hibernate-schema-create" depends="hibernate-prep">
    <!-- the second pass.  all tables will be created -->
    <hibernatetool>
      <classpath>
          <path location="${hq.home}/hq-web/target/classes" />
	        <path location="${hq.home}/hq-util/target/classes" />
	        <path location="${hq.home}/hq-common/target/classes" />
      </classpath>
      <configuration propertyFile="${hibernate-properties}">
        <fileset dir="${hq.home}/hq-web/target/classes">
          <include name="**/*.hbm.xml" />
        </fileset>
      </configuration>

      <hbm2ddl
          destdir="${build.dir}/sql"
          outputFileName="hibernate-create.sql"
          drop="false"
          create="true"
          update="false"
          format="true"
          console="false"
          export="${hq.schema.export}"
          delimiter="${hq.schema.statement.delimiter}"
          haltOnError="true"
          />
    </hibernatetool>
  </target>

 <!-- This target used to depend on hibernate-prep -->
  <target name="hibernate-schema-drop" depends="hibernate-prep">

    <delete failonerror="false" file="${build.dir}/sql/hibernate-drop.sql" />
    <mkdir dir="${build.dir}/sql" />
    <hibernatetool>
      <classpath>
        <path location="${hq.home}/hq-web/target/classes" />
        <path location="${hq.home}/hq-util/target/classes" />
        <path location="${hq.home}/hq-common/target/classes" />
      </classpath>
      <configuration propertyFile="${hibernate-properties}">
        <fileset dir="${hq.home}/hq-web/target/classes">
          <include name="**/*.hbm.xml" />
        </fileset>
      </configuration>

      <hbm2ddl
          destdir="${build.dir}/sql"
          outputFileName="hibernate-drop.sql"
          drop="true"
          create="false"
          update="false"
          format="true"
          console="false"
          export="${hq.schema.export}"
          delimiter="${hq.schema.statement.delimiter}"
          />
    </hibernatetool>
  </target>

  <target name="hibernate-schema-validation" depends="hibernate-prep">
    <taskdef name="validate-schema"
             classname="org.hibernate.tool.hbm2ddl.SchemaValidatorTask">
      <classpath>
         <path location="${hq.home}/hq-web/target/classes" />
	      <path location="${hq.home}/hq-util/target/classes" />
	       <path location="${hq.home}/hq-common/target/classes" />
        <path refid="hibernate-classpath" />
      </classpath>
    </taskdef>
    <validate-schema properties="${hibernate-properties}">
      <fileset dir="${hq.home}/hq-web/src/main/resources/hibernate">
        <include name="**/*.hbm.xml" />
      </fileset>
    </validate-schema>
  </target>

  <target name="hibernate-setup" depends="hibernate-schema-drop,hibernate-schema-create" />

  <target name="hibernate-create" depends="hibernate-schema-create" />
  <target name="hibernate-drop" depends="hibernate-schema-drop" />
  <target name="hibernate-validate" depends="hibernate-schema-validation" />

</project>
