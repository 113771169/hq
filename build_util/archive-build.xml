<?xml version="1.0"?>

<project name="archive-build" basedir="..">

	<!-- Common targets for rolling release archives -->
	<target name="roll-nojre-archives">
		<property name="archive-dir" location="${archive.build.dir}/${archive.basename}" />

		<antcall target="roll-agent-bundle">
			<param name="archive-suffix" value="noJRE" />
			<param name="compress-mode" value="zip" />
		</antcall>
		<antcall target="roll-platform-specific-archive">
			<param name="jre-file" value="" />
			<param name="archive-suffix" value="noJRE" />
			<param name="compress-mode" value="zip" />
		</antcall>
		<antcall target="roll-agent-bundle">
			<param name="archive-suffix" value="noJRE" />
			<param name="compress-mode" value="tgz" />
		</antcall>
		<antcall target="roll-platform-specific-archive">
			<param name="jre-file" value="" />
			<param name="archive-suffix" value="noJRE" />
			<param name="compress-mode" value="tgz" />
		</antcall>
	</target>

	<target name="roll-archives" depends="roll-nojre-archives">
		<!-- Roll platform specific tarballs -->
		<antcall target="roll-platform-specific-archive">
			<param name="jre-file" value="amd64-linux-jre-1_*.tar.gz" />
			<param name="archive-suffix" value="x86_64-linux" />
			<param name="compress-mode" value="tgz" />
		</antcall>
		<antcall target="roll-platform-specific-archive">
			<param name="jre-file" value="" />
			<param name="archive-suffix" value="apple-osx" />
			<param name="compress-mode" value="tgz" />
		</antcall>
		<antcall target="roll-platform-specific-archive">
			<param name="jre-file" value="x86-linux-glibc2-jre-1_*.tar.gz" />
			<param name="archive-suffix" value="x86-linux" />
			<param name="compress-mode" value="tgz" />
		</antcall>
		<antcall target="roll-platform-specific-archive">
			<param name="jre-file" value="sparc-sun-solaris-jre-1_*.tar.gz" />
			<param name="archive-suffix" value="sparc-solaris" />
			<param name="compress-mode" value="tgz" />
		</antcall>
		<antcall target="roll-platform-specific-archive">
			<param name="jre-file" value="x86-win32-jre-1_*.exe" />
			<param name="archive-suffix" value="win32" />
			<param name="compress-mode" value="zip" />
		</antcall>
		<antcall target="roll-pdk-bundle" />
	</target>

	<target name="roll-agent-bundle">
		<copy todir="${build.dir}/${archive.basename}-agent-${version}">
			<fileset dir="${agent.dir}" />
		</copy>

		<property name="connectors.dir" location="${build.dir}/${archive.basename}-agent-${version}/product_connectors" />


		<!-- Copy SNMP and RT packages -->
		<copy toDir="${connectors.dir}">
			<fileset dir="${hq.bin}/product_connectors">
				<include name="**" />
			</fileset>
		</copy>

		<antcall target="compress-dir">
			<param name="archive-dir" value="${build.dir}/${archive.basename}-agent-${version}" />
			<param name="archive-file" value="${build.dir}/${archive.basename}-agent-${version}-${build}-${archive-suffix}.${compress-mode}" />
			<param name="compress-mode" value="${compress-mode}" />
		</antcall>

		<delete dir="${build.dir}/${archive.basename}-agent-${version}" />
	</target>

	<target name="roll-platform-specific-archive">
		<!-- Is there a postgresql bundle available for this platform? -->
		<available property="pgsql.available" file="${pgsql.dir}/${archive-suffix}" />
		<delete dir="${archive-dir}/installer-${version}/data/hqdb" />
		<antcall target="bundle-pgsql" />

		<!-- include the license-info file -->
		<copy file="${hq.home}/LICENSES.txt" toFile="${archive-dir}/LICENSES.txt" />

		<!-- Packup the whole thing -->
		<antcall target="compress-dir">
			<param name="archive-dir" value="${archive-dir}" />
			<param name="archive-file" value="${build.dir}/${archive.basename}-installer-${version}-${build}-${archive-suffix}.${compress-mode}" />
			<param name="compress-mode" value="${compress-mode}" />
		</antcall>
	</target>

	<target name="roll-pdk-bundle">
		<antcall target="compress-dir">
			<param name="archive-dir" value="${agent.dir}/bundles/${agent.bundle.dir}/pdk" />
			<param name="archive-file" value="${build.dir}/hyperic-pdk-${version}-${build}.zip" />
			<param name="compress-mode" value="zip" />
		</antcall>
	</target>

	<target name="roll-upgrade-agent-bundle" description="Rolls the bundle required for the agent auto upgrade">

		<delete dir="${build.dir}/agent-upgrade" />
		<mkdir dir="${build.dir}/agent-upgrade" />

		<antcall target="compress-dir">
			<param name="archive-dir" value="${agent.dir}/bundles/${agent.bundle.dir}" />
			<param name="archive-file" value="${build.dir}/agent-upgrade/${agent.bundle.dir}.tgz" />
			<param name="compress-mode" value="tgz" />
		</antcall>
	</target>

	<target name="bundle-pgsql" if="pgsql.available">
		<mkdir dir="${archive-dir}/installer-${version}/data/hqdb" />
		<copy todir="${archive-dir}/installer-${version}/data/hqdb">
			<fileset dir="${pgsql.dir}/${archive-suffix}">
				<include name="*.sh" />
				<include name="*.bat" />
				<include name="pgsql.tar.gz" />
				<include name="pgsql.zip" />
			</fileset>
		</copy>
		<mkdir dir="${archive-dir}/installer-${version}/data/hqdb/conf" />
		<copy todir="${archive-dir}/installer-${version}/data/hqdb/conf">
			<fileset dir="${pgsql.dir}/${archive-suffix}/conf" includes="**" />
		</copy>
	</target>

	<target name="prepare-ssl" unless="available.keystore">
		<!-- Server key for ssl -->
		<echo message="Generating a SSL key for https" />
		<genkey alias="HQ" keystore="${tomcat.home}/conf/hyperic.keystore" keyalg="rsa" storepass="hyperic" dname="CN=Hyperic HQ, OU=HQ, O=hyperic.net, C=US" />
	</target>

</project>
