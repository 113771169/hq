<?xml version="1.0"?>
<!--
  NOTE: This copyright does *not* cover user programs that use HQ
  program services by normal system calls through the application
  program interfaces provided as part of the Hyperic Plug-in Development
  Kit or the Hyperic Client Development Kit - this is merely considered
  normal use of the program, and does *not* fall under the heading of
  "derived work".
  
  Copyright (C) [2004, 2005, 2006], Hyperic, Inc.
  This file is part of HQ.
  
  HQ is free software; you can redistribute it and/or modify
  it under the terms version 2 of the GNU General Public License as
  published by the Free Software Foundation. This program is distributed
  in the hope that it will be useful, but WITHOUT ANY WARRANTY; without
  even the implied warranty of MERCHANTABILITY or FITNESS FOR A
  PARTICULAR PURPOSE. See the GNU General Public License for more
  details.
  
  You should have received a copy of the GNU General Public License
  along with this program; if not, write to the Free Software
  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307
  USA.
 -->

<plugin name="mssql">
  <property name="PLUGIN_VERSION" value="@project.version@"/>
  <script name="MDF_FreeSpacePct2005.sql">
	<![CDATA[
set ANSI_NULLS ON 
set QUOTED_IDENTIFIER ON 
IF OBJECT_ID('tempdb..#tTables') IS NOT NULL DROP TABLE #tTables 
create table #tTables 
( 
numID INTEGER IDENTITY(1,1), 
strTableName sysname, 
db_sizes bigint, 
unalloc_sizes bigint 
) 

EXEC sp_MSforeachdb 
'USE [?] 
declare @dbname sysname 
declare @bytesperpage dec(15,0) 
declare @pagesperMB dec(15,0) 
declare @dbmaxsize dec(15,0)
declare @reservedpages  bigint

SET @dbname = db_name() 

select @bytesperpage = low from master.dbo.spt_values where number = 1 
and type = ''E'' 

select @pagesperMB = 1048576 / @bytesperpage 

select @dbmaxsize = min(maxsize) from dbo.sysfiles where (status & 64 = 0)

if @dbmaxsize <> -1
begin 
	select @dbmaxsize = sum(convert(dec(15),maxsize)) from dbo.sysfiles 
	where (status & 64 = 0)
end

select	@reservedpages = sum(total_pages) from sys.allocation_units

insert into #tTables( strTableName, db_sizes, unalloc_sizes) 
select 
db_name(), 
database_size =  (case @dbmaxsize 
                              when -1 then -1 
                              else  
                              cast( ((@dbmaxsize / @pagesperMB)*1024) as bigint ) 
                              end), 
unallocated_space = (case when @dbmaxsize >= @reservedpages then
						cast(((convert (dec (15,2),@dbmaxsize) - convert (dec (15,2),@reservedpages)) / @pagesperMB*1024) as bigint )
					else 0 
					end)'

select strTableName "DBName", 
(case db_sizes when -1 then 100 else cast(round(100.00*unalloc_sizes/db_sizes, 2) as decimal(5,2)) end) "DatabaseFreePct" from #tTables 
              
drop table #tTables 
	]]>
	</script>
	
	<!-- Script for version 2000 -->
	<script name="MDF_FreeSpacePct2000.sql">
	<![CDATA[
set ANSI_NULLS ON 
set QUOTED_IDENTIFIER ON 
IF OBJECT_ID('tempdb..#tTables') IS NOT NULL DROP TABLE #tTables 
create table #tTables 
( 
numID INTEGER IDENTITY(1,1), 
strTableName sysname, 
db_sizes bigint, 
unalloc_sizes bigint 
) 
EXEC sp_MSforeachdb 
'USE [?] 
declare @dbname sysname 
declare @bytesperpage dec(15,0) 
declare @pagesperMB dec(15,0) 
declare @dbmaxsize dec(15,0)
SET @dbname = db_name() 
select @bytesperpage = low from master.dbo.spt_values where number = 1 and type = ''E'' 
select @pagesperMB = 1048576 / @bytesperpage 
select @dbmaxsize = min(maxsize) from dbo.sysfiles where (status & 64 = 0)
if @dbmaxsize <> -1
begin 
select @dbmaxsize = sum(convert(dec(15),maxsize)) from dbo.sysfiles where (status & 64 = 0)
end

insert into #tTables( strTableName, db_sizes, unalloc_sizes) 
select 
db_name(), 
database_size =  (case @dbmaxsize when -1 then -1 else	cast( ((@dbmaxsize / @pagesperMB)*1024) as bigint ) end), 
unallocated_space =  cast((((@dbmaxsize - (select sum(convert(dec(15),reserved) )	
from sysindexes where indid in (0, 1, 255))) / @pagesperMB )*1024) as bigint )'	

select strTableName "DBName", 
(case db_sizes when -1 then 100 else CAST(ROUND(100.0*unalloc_sizes/db_sizes, 0) AS INT) end) "DatabaseFreePct" from #tTables 			

drop table #tTables
	]]>
	</script>
	
  <!-- appended to each template by the hq-plugin.xml parser -->
    <property name="template-config"
            value="service_name=%service_name%"/>

    <filter name="db.domain"
          value="Databases(${db.name})"/>

    <filter name="lock.domain"
          value="Locks(${lock.name})"/>

    <filter name="cache.domain"
          value="Cache Manager(${cache.name})"/>

<!-- NUEVOS -->
    <filter name="buffer.manager" value="Buffer Manager:Platform=Win32:${name}"/>

    <metrics name="Buffer-Manager_2012">
        <metric name="Page life expectancy"
            template="${buffer.manager}"
            category="UTILIZATION"
            group="Reliability"
            collectionType="dynamic"
            units="sec"/>
        <metric name="Lazy Writes"
            template="Buffer Manager:Platform=Win32:Lazy Writes/Sec"
            category="UTILIZATION"
            group="Reliability"
            collectionType="trendsup"
            units="none"/>
        <metric name="Checkpoint Pages"
            template="Buffer Manager:Platform=Win32:Checkpoint Pages/Sec"
            category="UTILIZATION"
            group="Reliability"
            collectionType="trendsup"
            units="none"/>
        <metric name="Page reads"
            template="Buffer Manager:Platform=Win32:Page reads/sec"
            category="UTILIZATION"
            group="Reliability"
            collectionType="trendsup"
            units="none"/>
        <metric name="Page writes"
            template="Buffer Manager:Platform=Win32:Page writes/sec"
            category="UTILIZATION"
            group="Reliability"
            collectionType="trendsup"
            units="none"/>
        <metric name="Buffer Cache hit ratio"
            template="Buffer Manager:Type=Formatted:${name}"
            category="UTILIZATION"
            group="Reliability"
            collectionType="dynamic"
            units="percent"/>
    </metrics>
    
    <metrics name="Buffer-Manager">
        <include name="Buffer-Manager_2012"/>
        <metric name="Free pages"
                template="${buffer.manager}"
                category="UTILIZATION"
                group="Reliability"
                collectionType="dynamic"
                units="none"/>
        <metric name="Stolen pages"
                template="${buffer.manager}"
                category="UTILIZATION"
                group="Reliability"
                collectionType="dynamic"
                units="none"/>
    </metrics>

<!-- FIN NUEVOS -->

    <metrics name="mssql-avail">
        <metric name="Availability"
            alias="Availability"
            template="${db.domain}:Type=Availability:Active Transactions"
            category="AVAILABILITY"
            group="Reliability"
            indicator="true"
            collectionType="dynamic"
            units="percentage"/>
    </metrics>

    <metrics name="mssql-database">
        <metric name="Data File Size"
            alias="DataFileSize"
            template="${db.domain}:Platform=Win32:Data File(s) Size (KB)"
            category="UTILIZATION"
            group="Resource Utilization"
            indicator="true"
            collectionType="dynamic"
            units="KB"/>

        <metric name="Log File Size"
            alias="LogFileSize"
            template="${db.domain}:Platform=Win32:Log File(s) Size (KB)"
            category="UTILIZATION"
            group="Log"
            collectionType="dynamic"
            units="KB"/>

        <metric name="Log File Used Size"
            alias="LogFileUsedSize"
            template="${db.domain}:Platform=Win32:Log File(s) Used Size (KB)"
            category="UTILIZATION"
            group="Log"
            collectionType="dynamic"
            units="KB"/>

        <metric name="Percent Log Used"
            alias="PercentLogUsed"
            template="${db.domain}:Platform=Win32:Percent Log Used"
            category="UTILIZATION"
            group="Log"
            collectionType="dynamic"
            units="percentage"/>

        <metric name="Active Transactions"
            alias="ActiveTransactions"
            template="${db.domain}:Platform=Win32:Active Transactions"
            category="THROUGHPUT"
            group="Throughput"
            indicator="true"
            collectionType="dynamic"
            units="none"/>

        <metric name="Transactions"
            alias="Transactions"
            template="${db.domain}:Platform=Win32:Transactions/sec"
            category="THROUGHPUT"
            group="Throughput"
            indicator="true"
            collectionType="trendsup"
            units="none"/>

        <metric name="Transactions"
            alias="Transactions"
            template="${db.domain}:Type=Formatted:Transactions/sec"
            category="THROUGHPUT"
            group="Throughput"
            collectionType="dynamic"
            units="none"/>

        <metric name="Replication Pending Transactions"
            alias="ReplPendingTx"
            template="${db.domain}:Platform=Win32:Repl. Pending Xacts"
            category="UTILIZATION"
            group="Resource Utilization"
            collectionType="dynamic"
            units="none"/>

        <metric name="Replication Transaction Rate"
            alias="ReplTransRate"
            template="${db.domain}:Type=Formatted:Repl. Trans. Rate"
            category="UTILIZATION"
            group="Resource Utilization"
            collectionType="dynamic"
            units="none"/>

        <metric name="Log Cache Hit Ratio"
            alias="LogCacheHitRatio"
            template="${db.domain}:Type=Formatted:Log Cache Hit Ratio"
            category="UTILIZATION"
            group="Log"
            collectionType="dynamic"
            units="none"/>

        <metric name="Log Flush Wait Time"
            alias="LogFlushWaitTime"
            template="${db.domain}:Platform=Win32:Log Flush Wait Time"
            category="UTILIZATION"
            group="Log"
            collectionType="dynamic"
            units="none"/>

        <metric name="Log Truncations"
            alias="LogTruncations"
            template="${db.domain}:Platform=Win32:Log Truncations"
            category="UTILIZATION"
            group="Log"
            collectionType="dynamic"
            units="none"/>

        <metric name="Log Growths"
            alias="LogGrowths"
            template="${db.domain}:Platform=Win32:Log Growths"
            category="UTILIZATION"
            group="Log"
            collectionType="dynamic"
            units="none"/>

        <metric name="Log Shrinks"
            alias="LogShrinks"
            template="${db.domain}:Platform=Win32:Log Shrinks"
            category="UTILIZATION"
            group="Log"
            collectionType="dynamic"
            units="none"/>

    </metrics>

    <metrics name="mssql-access">
    <metric name="Full Scans"
            alias="FullScans"
            template="Access Methods:Platform=Win32:Full Scans/Sec"
            category="UTILIZATION"
            group="Resource Utilization"
            collectionType="trendsup"
            units="none"/>
    <metric name="Worktables Created"
            template="Access Methods:Platform=Win32:Worktables Created/Sec"
            category="UTILIZATION"
            group="Resource Utilization"
            collectionType="trendsup"
            units="none"/>

    <metric name="Workfiles Created"
            alias="WorkfilesCreatedSec"
            template="Access Methods:Platform=Win32:Workfiles Created/Sec"
            category="UTILIZATION"
            group="Resource Utilization"
            collectionType="trendsup"
            units="none"/>


        <metric name="Worktables From Cache Ratio"
            alias="WorktablesFromCacheRatio"
            template="Access Methods:Type=Formatted:Worktables From Cache Ratio"
            category="UTILIZATION"
            group="Cache"
            collectionType="dynamic"
            units="none"/>

    <metric name="Page Splits"
            alias="PageSplitsSec"
            template="Access Methods:Platform=Win32:Page Splits/Sec"
            category="UTILIZATION"
            group="Resource Utilization"
            collectionType="trendsup"
            units="none"/>

    </metrics>

    <metrics name="mssql-general">
    <metric name="Logins"
            alias="Logins"
            template="General Statistics:Platform=Win32:Logins/Sec"
            category="UTILIZATION"
            group="Resource Utilization"
            collectionType="trendsup"
            units="none"/>

    <metric name="Logouts"
            alias="Logouts"
            template="General Statistics:Platform=Win32:Logouts/Sec"
            category="UTILIZATION"
            group="Resource Utilization"
            collectionType="trendsup"
            units="none"/>

        <metric name="User Connections"
            alias="UserConnections"
            template="General Statistics:Platform=Win32:User Connections"
            category="UTILIZATION"
            group="Resource Utilization"
            collectionType="dynamic"
            units="none"/>
    </metrics>

    <metrics name="mssql-memory">
        <metric name="Connection Memory"
            alias="ConnectionMemory"
            template="Memory Manager:Platform=Win32:Connection Memory (KB)"
            category="UTILIZATION"
            group="Memory"
            collectionType="dynamic"
            units="KB"/>

        <metric name="Granted Workspace Memory"
            alias="GrantedWorkspaceMemory"
            template="Memory Manager:Platform=Win32:Granted Workspace Memory (KB)"
            category="UTILIZATION"
            group="Memory"
            collectionType="dynamic"
            units="KB"/>

        <metric name="Lock Memory"
            alias="LockMemory"
            template="Memory Manager:Platform=Win32:Lock Memory (KB)"
            category="UTILIZATION"
            group="Memory"
            collectionType="dynamic"
            units="KB"/>

        <metric name="Lock Blocks Allocated"
            alias="LockBlocksAllocated"
            template="Memory Manager:Platform=Win32:Lock Blocks Allocated"
            category="UTILIZATION"
            group="Memory"
            collectionType="dynamic"
            units="none"/>

        <metric name="Lock Owner Blocks Allocated"
            alias="LockOwnerBlocksAllocated"
            template="Memory Manager:Platform=Win32:Lock Owner Blocks Allocated"
            category="UTILIZATION"
            group="Memory"
            collectionType="dynamic"
            units="none"/>

        <metric name="Lock Blocks"
            alias="LockBlocks"
            template="Memory Manager:Platform=Win32:Lock Blocks"
            category="UTILIZATION"
            group="Memory"
            collectionType="dynamic"
            units="none"/>

        <metric name="Lock Owner Blocks"
            alias="LockOwnerBlocks"
            template="Memory Manager:Platform=Win32:Lock Owner Blocks"
            category="UTILIZATION"
            group="Memory"
            collectionType="dynamic"
            units="none"/>

        <metric name="Maximum Workspace Memory"
            alias="MaximumWorkspaceMemory"
            template="Memory Manager:Platform=Win32:Maximum Workspace Memory (KB)"
            category="UTILIZATION"
            group="Memory"
            collectionType="dynamic"
            units="KB"/>

        <metric name="Memory Grants Outstanding"
            alias="MemoryGrantsOutstanding"
            template="Memory Manager:Platform=Win32:Memory Grants Outstanding"
            category="UTILIZATION"
            group="Memory"
            collectionType="dynamic"
            units="none"/>

        <metric name="Memory Grants Pending"
            alias="MemoryGrantsPending"
            template="Memory Manager:Platform=Win32:Memory Grants Pending"
            category="UTILIZATION"
            group="Memory"
            collectionType="dynamic"
            units="none"/>

        <metric name="Optimizer Memory"
            alias="OptimizerMemory"
            template="Memory Manager:Platform=Win32:Optimizer Memory (KB)"
            category="UTILIZATION"
            group="Memory"
            collectionType="dynamic"
            units="KB"/>

        <metric name="SQL Cache Memory"
            alias="SQLCacheMemory"
            template="Memory Manager:Platform=Win32:SQL Cache Memory (KB)"
            category="UTILIZATION"
            group="Memory"
            collectionType="dynamic"
            units="KB"/>

        <metric name="Total Server Memory"
            alias="TotalServerMemory"
            template="Memory Manager:Platform=Win32:Total Server Memory (KB)"
            category="UTILIZATION"
            group="Memory"
            collectionType="dynamic"
            units="KB"/>
    </metrics>

    <metrics name="mssql-stats">
    
    <metric name="Batch Requests"
            alias="BatchRequests"
            template="SQL Statistics:Platform=Win32:Batch Requests/Sec"
            category="UTILIZATION"
            group="Resource Utilization"
            collectionType="trendsup"
            units="none"/>
   
    <metric name="SQL Compilations"
            alias="SQLCompilations"
            template="SQL Statistics:Platform=Win32:SQL Compilations/Sec"
            category="UTILIZATION"
            group="Resource Utilization"
            collectionType="trendsup"
            units="none"/>
    <metric name="SQL Re-Compilations"
            alias="SQLReCompilations"
            template="SQL Statistics:Platform=Win32:SQL Re-Compilations/Sec"
            category="UTILIZATION"
            group="Resource Utilization"
            collectionType="trendsup"
            units="none"/>
    </metrics>

  <!-- XXX define Lock service?  breaks down into:
       Database, Extent, Key, Page, RID, Table
  -->
    <metrics name="mssql-locks">
        <metric name="Lock Requests"
            alias="LockRequests"
            template="${lock.domain}:Platform=Win32:Lock Requests/Sec"
            category="UTILIZATION"
            group="Lock"
            indicator="true"
            collectionType="trendsup"
            units="none"/>

        <metric name="Lock Timeouts"
            alias="LockTimeouts"
            template="${lock.domain}:Platform=Win32:Lock Timeouts/Sec"
            category="UTILIZATION"
            group="Lock"
            collectionType="trendsup"
            units="none"/>

        <metric name="Number of Deadlocks"
            alias="NumDeadlocks"
            template="${lock.domain}:Platform=Win32:Number of Deadlocks/Sec"
            category="UTILIZATION"
            group="Resource Utilization"
            collectionType="trendsup"
            units="none"/>

        <metric name="Lock Waits"
            alias="LockWaits"
            template="${lock.domain}:Platform=Win32:Lock Waits/Sec"
            category="UTILIZATION"
            group="Lock"
            indicator="true"
            collectionType="trendsup"
            units="none"/>

        <metric name="Lock Wait Time"
            alias="LockWaitTime"
            template="${lock.domain}:Platform=Win32:Lock Wait Time (ms)"
            category="UTILIZATION"
            group="Lock"
            collectionType="dynamic"
            units="ms"/>

        <metric name="Average Wait Time"
            alias="AverageWaitTime"
            template="${lock.domain}:Platform=Win32:Average Wait Time (ms)"
            category="UTILIZATION"
            group="Resource Utilization"
            collectionType="dynamic"
            units="ms"/>
    </metrics>

    <metrics name="mssql-latches">

        <metric name="Average Latch Wait Time"
            alias="AverageLatchWaitTime"
            template="Latches:Platform=Win32:Average Latch Wait Time (ms)"
            category="UTILIZATION"
            group="Resource Utilization"
            collectionType="dynamic"
            units="ms"/>

        <metric name="Total Latch Wait Time"
            alias="TotalLatchWaitTime"
            template="Latches:Platform=Win32:Total Latch Wait Time (ms)"
            category="UTILIZATION"
            group="Resource Utilization"
            collectionType="dynamic"
            units="ms"/>
    </metrics>

  <!-- XXX define Cache service?  breaks down into:
       Adhoc Sql Plans, Cursors, Execution Contexts,
       Misc. Normalized Trees, Prepared Sql Plans,
       Procedure Plans, Replication Procedure Plans,
       Trigger Plans.
  -->

    <metrics name="mssql-cache"/>
    
    <server name="MsSQL"
          version="2000"
          platforms="Win32">

        <plugin type="measurement"
            class="MsSQLMeasurementPlugin"/>

        <plugin type="autoinventory"
            class="MsSQLDetector"/>

        <plugin type="log_track"
            class="org.hyperic.hq.product.Win32EventLogTrackPlugin"/>

        <plugin type="control"
            class="org.hyperic.hq.product.Win32ControlPlugin"/>

    <!-- just an example.  Win32ControlPlugin overrides this -->
        <actions include="start,stop,restart"/>

        <property name="mssql.version" value="8"/>
        <property name="mssql.version.file" value="sqlctr80.dll"/>

        <metrics>
            <include name="mssql-avail"/>
            <include name="mssql-database"/>
      <!-- server only -->
            <include name="mssql-access"/>
            <include name="mssql-general"/>
            <include name="mssql-memory"/>
            <include name="mssql-locks"/>
            <include name="mssql-latches"/>
            <include name="mssql-cache"/>
            <include name="Buffer-Manager"/>
        </metrics>

        <config>
            <option name="service_name"
              description="Service Name"
              default="MSSQLSERVER"/>
            <option name="sqlserver_name"
              description="Server Name"
              default="localhost"/>
          <option name="user"
              description="Username"
              optional="true"
              default="%user%"/>
            <option name="password"
              description="Password"
              optional="true"
              type="secret"
              default="%password%"/> 
        </config>

        <properties>
            <property name="version"
                 description="SQL Server Version"/>
        </properties>

        <service name="Database">
            <metrics>
                <include name="mssql-avail"/>
                <include name="mssql-database"/>
                <!-- Metric for 2000 only -->
                <metric name="Database Free Percent" category="UTILIZATION"
             		units="percent"
             		template="${db.name}:ServerName=%sqlserver_name%,User=%user%,Password=%password%:Database Free Percent 2000"
             		collectionType="dynamic" />
            </metrics>

            <config>
                <option name="db.name"
                description="Database name"
                default="Northwind"/>
            </config>
        </service>
    </server>

    <server name="MsSQL"
          version="2005"
          include="2000">

        <property name="mssql.version" value="9"/>
        <property name="mssql.version.file" value="sqlsvc90.dll"/>
        
        <service name="Database">
            <metrics>
                <include name="mssql-avail"/>
                <include name="mssql-database"/>
                <!-- Metric for 2005 and 2008 only -->
                <metric name="Database Free Percent" category="UTILIZATION"
             		units="percent"
             		template="${db.name}:ServerName=%sqlserver_name%,User=%user%,Password=%password%:Database Free Percent"
             		collectionType="dynamic" />
            </metrics>

            <config>
                <option name="db.name"
                description="Database name"
                default="Northwind"/>
            </config>
        </service>

    </server>
    <server name="MsSQL"
          version="2008"
          include="2005">
        <property name="mssql.version.file" value="sqlsvc.dll"/>
        <property name="regKey" value="SOFTWARE\Microsoft\Microsoft SQL Server\MSSQL10.%NAME%\MSSQLServer\CurrentVersion"/>
        <property name="version" value="10.00"/>
    </server>
    <server name="MsSQL"
          version="2008 R2"
          include="2008">
        <property name="mssql.version.file" value="sqlsvc.dll"/>
        <property name="regKey" value="SOFTWARE\Microsoft\Microsoft SQL Server\MSSQL10_50.%NAME%\MSSQLServer\CurrentVersion"/>
        <property name="version" value="10.5"/>
    </server>
    <server name="MsSQL"
          version="2012"
          include="2008">
        <property name="mssql.version.file" value="sqlsvc.dll"/>
        <property name="regKey" value="SOFTWARE\Microsoft\Microsoft SQL Server\MSSQL11.%NAME%\MSSQLServer\CurrentVersion"/>
        <property name="version" value="11.0.\d*\.\d*"/>
        <metrics>
            <include name="mssql-avail"/>
            <include name="mssql-database"/>
      <!-- server only -->
            <include name="mssql-access"/>
            <include name="mssql-general"/>
            <include name="mssql-memory"/>
            <include name="mssql-locks"/>
            <include name="mssql-latches"/>
            <include name="mssql-cache"/>
            <include name="Buffer-Manager_2012"/>
        </metrics>
    </server>
</plugin>
