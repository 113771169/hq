<?xml version="1.0"?>
<!--
  NOTE: This copyright does *not* cover user programs that use HQ
  program services by normal system calls through the application
  program interfaces provided as part of the Hyperic Plug-in Development
  Kit or the Hyperic Client Development Kit - this is merely considered
  normal use of the program, and does *not* fall under the heading of
  "derived work".
  
  Copyright (C) [2004, 2005, 2006], Hyperic, Inc.
  This file is part of HQ.
  
  HQ is free software; you can redistribute it and/or modify
  it under the terms version 2 of the GNU General Public License as
  published by the Free Software Foundation. This program is distributed
  in the hope that it will be useful, but WITHOUT ANY WARRANTY; without
  even the implied warranty of MERCHANTABILITY or FITNESS FOR A
  PARTICULAR PURPOSE. See the GNU General Public License for more
  details.
  
  You should have received a copy of the GNU General Public License
  along with this program; if not, write to the Free Software
  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307
  USA.
 -->

<plugin name="hyper_v">
  <property name="PLUGIN_VERSION" value="@project.version@"/>

  <server name="Hyper-V"
          platforms="Win32">

    <plugin type="measurement" class="org.hyperic.hq.product.Win32MeasurementPlugin"/>
    <plugin type="log_track" class="org.hyperic.hq.product.Win32EventLogTrackPlugin"/>
    <plugin type="autoinventory" class="HyperVDetector"/>
    <!--plugin type="collector" class="HyperVCollector"/-->

    <scan registry="SYSTEM\CurrentControlSet\Services\vmms">
      <include name="ImagePath"/>
    </scan>
    
    <filter name="hyper-v_hypervisor" value="Hyper-V Hypervisor"/>
    <filter name="hyper-v_virtual_machine_health_summary" value="Hyper-V Virtual Machine Health Summary"/>
    <filter name="hyper-v_hypervisor_logical-processor" value="Hyper-V Hypervisor Logical Processor(%instance.name%)"/>
    <filter name="Hyper-V_VM_Vid_Partition" value="Hyper-V VM Vid Partition(%instance.name%)"/>
    <filter name="memory" value="Memory"/>
    <filter name="network_interface" value="Network Interface(%instance.name%)"/>
    <filter name="physical_disk" value="PhysicalDisk(%instance.name%)"/>
    <metric name="Availability"
            template="ServiceAvail:Platform=Win32:vmms"
            category="AVAILABILITY"
            indicator="true"
			defaultOn="true"
            collectionType="dynamic"
            units="percentage"/>
	<metric name="Health Ok"
			template="${hyper-v_virtual_machine_health_summary}:${name}"
			indicator="true"
			defaultOn="true"
		    collectionType="dynamic"/>
	<metric name="Health Critical"
			template="${hyper-v_virtual_machine_health_summary}:${name}"
			indicator="true"
			defaultOn="true"
		    collectionType="dynamic"/>
	<metric name="Logical Processors"
			template="${hyper-v_hypervisor}:${name}"
			indicator="true"
			defaultOn="true"
		    collectionType="dynamic"/>
	<metric name="Partitions"
			template="${hyper-v_hypervisor}:${name}"
			indicator="true"
			defaultOn="true"
		    collectionType="dynamic"/>
	<metric name="Total Pages"
			template="${hyper-v_hypervisor}:${name}"
			indicator="true"
			defaultOn="true"
		    collectionType="dynamic"/>
	
	<service name="Memory">
	    <plugin type="autoinventory" class="HyperVDetector"/>
		<plugin type="log_track" class="org.hyperic.hq.product.Win32EventLogTrackPlugin"/>
	    <plugin type="measurement" class="org.hyperic.hq.product.Win32MeasurementPlugin"/>

		<metric name="Availability"
            template="ServiceAvail:Platform=Win32:vmms"
            category="AVAILABILITY"
            indicator="true"
			defaultOn="true"
            collectionType="dynamic"
            units="percentage"/>
		<metric name="Available Bytes"
				template="${memory}:Available Bytes"
				indicator="true"
				defaultOn="true"
			    collectionType="dynamic"/>
		<metric name="Pages/sec"
				template="${memory}:Pages/sec"
				indicator="true"
				defaultOn="true"
			    collectionType="dynamic"/>
	</service>
	
	<service name="Logical Processor">
	    <plugin type="autoinventory" class="HyperVDetector"/>
		<plugin type="log_track" class="org.hyperic.hq.product.Win32EventLogTrackPlugin"/>
	    <plugin type="measurement" class="org.hyperic.hq.product.Win32MeasurementPlugin"/>

		<metric name="Availability"
            template="ServiceAvail:Platform=Win32:vmms"
            category="AVAILABILITY"
            indicator="true"
			defaultOn="true"
            collectionType="dynamic"
            units="percentage"/>
		<metric name="% Guest Run Time"
				template="${hyper-v_hypervisor_logical-processor}:% Guest Run Time"
				indicator="true"
				defaultOn="true"
			    collectionType="dynamic"/>
		<metric name="% Hypervisor Run Time"
				template="${hyper-v_hypervisor_logical-processor}:% Hypervisor Run Time"
				indicator="true"
				defaultOn="true"
			    collectionType="dynamic"/>
		<metric name="% Idle Time"
				template="${hyper-v_hypervisor_logical-processor}:% Idle Time"
				indicator="true"
				defaultOn="true"
			    collectionType="dynamic"/>
		<metric name="% Total Run Time"
				template="${hyper-v_hypervisor_logical-processor}:% Total Run Time"
				indicator="true"
				defaultOn="true"
			    collectionType="dynamic"/>
	</service>
	
	<service name="Network Interface">
	    <plugin type="autoinventory" class="HyperVDetector"/>
		<plugin type="log_track" class="org.hyperic.hq.product.Win32EventLogTrackPlugin"/>
	    <plugin type="measurement" class="org.hyperic.hq.product.Win32MeasurementPlugin"/>
	    
	    <metric name="Availability"
	            template="ServiceAvail:Platform=Win32:vmms"
	            category="AVAILABILITY"
	            indicator="true"
				defaultOn="true"
	            collectionType="dynamic"
	            units="percentage"/>
		<metric name="Network - Bytes Total/sec"
				template="${network_interface}:Bytes Total/sec"
				indicator="true"
				defaultOn="true"
			    collectionType="dynamic"/>
		<metric name="Network - Offloaded Connections"
				template="${network_interface}:Offloaded Connections"
				indicator="true"
				defaultOn="true"
			    collectionType="dynamic"/>
		<metric name="Network - Packets/sec"
				template="${network_interface}:Packets/sec"
				indicator="true"
				defaultOn="true"
			    collectionType="dynamic"/>
		<metric name="Network - Packet Outbound Errors"
				template="${network_interface}:Packets Outbound Errors"
				indicator="true"
				defaultOn="true"
			    collectionType="dynamic"/>
		<metric name="Network - Packet Receive Errors"
				template="${network_interface}:Packets Received Errors"
				indicator="true"
				defaultOn="true"
			    collectionType="dynamic"/>
	</service>
		    
	<service name="PhysicalDisk">
		<plugin type="autoinventory" class="HyperVDetector"/>
		<plugin type="log_track" class="org.hyperic.hq.product.Win32EventLogTrackPlugin"/>
		<plugin type="measurement" class="HyperVMeasurementPlugin"/>
		
		<metric name="Availability"
            template="ServiceAvail:Platform=Win32:vmms"
            category="AVAILABILITY"
            indicator="true"
			defaultOn="true"
            collectionType="dynamic"
            units="percentage"/>
		<metric name="Current Disk Queue Length"
				template="pdh:${physical_disk}:Current Disk Queue Length"
				indicator="true"
				defaultOn="true"
			    collectionType="dynamic"/>
		<metric name="Disk Bytes/sec"
				template="pdh:${physical_disk}:Disk Bytes/sec"
				indicator="true"
				defaultOn="true"
			    collectionType="dynamic"/>
		<metric name="Disk Transfers/sec"
				template="pdh:${physical_disk}:Disk Transfers/sec"
				indicator="true"
				defaultOn="true"
			    collectionType="dynamic"/>
	</service>

	<service name="Hyper-V VM">
	    <plugin type="measurement" class="HyperVMeasurementPlugin"/>
        <plugin type="log_track" class="org.hyperic.hq.product.Win32EventLogTrackPlugin"/>
    	<plugin type="autoinventory" class="HyperVDetector"/>
            
		<metric name="Availability"
            template="wmic:object=Msvm_ComputerSystem,column=enabledstate:ElementName-%instance.name%"
            category="AVAILABILITY"
            indicator="true"
			defaultOn="true"
            collectionType="dynamic"
            units="percentage"/>
		<metric name="Memory - Physical Pages Allocated"
				template="${Hyper-V_VM_Vid_Partition}:Physical Pages Allocated"
				indicator="true"
				defaultOn="true"
			    collectionType="dynamic"/>
		<metric name="Memory - Remote Physical Pages"
				template="${Hyper-V_VM_Vid_Partition}:Remote Physical Pages"
				indicator="true"
				defaultOn="true"
			    collectionType="dynamic"/>
	</service>
  </server>


</plugin>