<?xml version="1.0"?>

<project name="setup" default="all" basedir=".">

  <!-- true for text based installs -->
  <available property="server.pgsql.available" 
             file="${install.dir}/data/hqdb/pgsql.tar.gz"/>

  <target name="load-basics">
    <property file="${install.dir}/data/version.properties"/>
    <echo>^^^INFO: Initializing Hyperic HQ ${version} Installation...</echo>
    <property name="common-resources" value="${install.dir}/lib"/>

    <path id="alljars">
      <fileset dir="${install.dir}/lib" includes="*.jar"/>
    </path>

    <available property="use.builtin.jre" file="${install.dir}/jres"/>

    <condition property="isWin32">
      <os family="windows"/>
    </condition>

    <echo>^^^DEBUG: Loading taskdefs...</echo>
    <taskdef resource="net/sf/antcontrib/antcontrib.properties"
             classpathref="alljars"/>
    <taskdef resource="org/hyperic/tools/ant/ant-tools.properties"
             classpathref="alljars"/>
    <echo>^^^DEBUG: Taskdefs loaded</echo>


    <if>
      <equals arg1="${install.mode}" arg2="upgrade"/>
      <then>
        <property name="setup.upgrade" value="true"/>
      </then>
    </if>

    <absolutePath property="base"
                  path="${install.dir}/.."
                  failOnMissing="true"/>

  </target>

  <target name="pick-jre" if="use.builtin.jre">
    <condition property="jre.tar.name" value="hppa2.0-hp-hpux-11.x-jre.tar.gz">
        <available file="${install.dir}/jres/hppa2.0-hp-hpux-11.x-jre.tar.gz"/>
    </condition>
    <condition property="jre.tar.name" value="amd64-linux-jre.tar.gz">
        <available file="${install.dir}/jres/amd64-linux-jre.tar.gz"/>
    </condition>
    <condition property="jre.tar.name" value="x86-linux-glibc2-jre.tar.gz">
        <available file="${install.dir}/jres/x86-linux-glibc2-jre.tar.gz"/>
    </condition>
    <condition property="jre.tar.name" value="sparc-sun-solaris-jre.tar.gz">
        <available file="${install.dir}/jres/sparc-sun-solaris-jre.tar.gz"/>
    </condition>
    <condition property="jre.exe.name" value="x86-win32-jre.exe">
        <available file="${install.dir}/jres/x86-win32-jre.exe"/>
    </condition>
  </target>

  <target name="chmod-jre" if="jre.chmod.java">
    <echo>^^^INFO:
      Setting permissions on jre binaries...
    </echo>
    <chmod perm="a+rx">
      <!-- there are 4 java binaries here, bin/java and 3 arch
           specific.  only two have the x bit set, make sure it is set
           for all of em -->
      <fileset dir="${destination}/jre">
        <include name="bin/java"/>
        <include name="bin/**/java"/>
      </fileset>
    </chmod>
  </target>

  <target name="install-jre-tar" if="jre.tar.name">
    <echo>^^^INFO:
      Unpacking JRE ${jre.tar.name} to: ${destination}...
    </echo>
    <untar src="${install.dir}/jres/${jre.tar.name}"
           dest="${destination}"
           compression="gzip"/>
    <condition property="jre.chmod.java">
        <os name="HP-UX"/>
    </condition>
    <antcall target="chmod-jre"/>
  </target> 

  <target name="install-jre-exe" if="jre.exe.name">
    <echo>^^^INFO:
      Unpacking JRE ${jre.exe.name} to: ${destination}...
    </echo>
    <exec executable="${install.dir}/jres/${jre.exe.name}">
      <arg line="-d '${destination}'"/>
    </exec>
  </target> 

  <target name="install-jre" depends="pick-jre" if="use.builtin.jre">
    <echo>^^^INFO: Installing the JRE ...</echo>
    <antcall target="install-jre-tar"/>
    <antcall target="install-jre-exe"/>
  </target>

  <target name="load-user-setup-properties" if="setup">
    <echo>^^^DEBUG:
      Checking for existence of install configuration file (${setup})
    </echo>

    <absolutePath property="setup.absolute" 
                  path="${setup}" 
                  pwd="${install.dir}/.."
                  failOnMissing="false"/>
    <dirname file="${setup.absolute}" property="data.dir"/>
    <available property="user-setup-properties.available"
               file="${setup.absolute}"/>
    <msgfail unless="user-setup-properties.available">^^^ERROR:\
       The specified Hyperic HQ install configuration file does not exist:
         ${setup.absolute}
       Make sure that the setup property is set to the correct file and 
       try running the installer again.
    </msgfail>

    <echo>^^^INFO: Loading install configuration...</echo>
    <echo>^^^DEBUG: Loading from ${setup}...</echo>
    <property file="${setup.absolute}"/>
    <ant antfile="setup-noninteractive.xml" target="generate-props"/>
    <echo>^^^DEBUG: Install configuration loaded.</echo>
  </target>

  <target name="load-default-setup-properties" unless="setup">

    <findWritable property="setup" 
                  preferredDir="${install.dir}"
                  filename="data/setup.properties"
                  altDirPrefix="HQ_tmp">^^^INFO:
WARNING: Setup properties file can't be written to %ORIGINALFILE%
Setup properties will be written to %WRITABLEFILE% instead.
    </findWritable>
    <delete file="${setup}"/>
    <ant antfile="setup-interactive.xml" target="generate-props"/>
    <echo>^^^INFO: Loading install configuration...</echo>
    <property file="${setup}"/>
    <absolutePath property="setup.absolute" 
                  path="${setup}" 
                  failOnMissing="true"/>
    <dirname file="${setup.absolute}" property="data.dir"/>
    <echo>^^^DEBUG: Install configuration loaded.</echo>
  </target>

  <target name="init" 
          depends="load-basics,load-user-setup-properties,load-default-setup-properties">

    <!-- Parameterized names of things to deploy -->
    <echo>^^^INFO: Preparing to install...</echo>
    <property name="hyperic.db-service.tag" value="hq-ds.xml" />
    <property name="hq.ear.tag" value="hq.ear" />
    <property name="covalent.tc-service.tag" value="tomcat41-service.xml" />
    <property name="covalent.jboss-service.tag" value="jboss-service.xml" />
	<property name="jboss.server" value="server/default"/>
	<property name="jboss.home" value="${server.installdir}/server-${version}/hq-engine"/>
	<property name="embedded-tomcat.home" 
		value="${jboss.home}/${jboss.server}/deploy/jbossweb-tomcat41.sar"/>
    <condition property="script-ext" value=".bat">
      <os family="windows"/>
    </condition>
    <condition property="exe-ext" value=".exe">
      <os family="windows"/>
    </condition>
    <condition property="script-ext" value=".sh">
      <os family="unix"/>
    </condition>
    <condition property="exe-ext" value="">
      <os family="unix"/>
    </condition>

    <condition property="server.dont-check-for-overwrite">
      <equals arg1="${server.overwrite}" arg2="Yes"/>
    </condition>
  </target>

  <target name="validate-any" depends="init">
    <if>
      <and>
        <not><isset property="server.installdir"/></not>
        <not><isset property="agent.installdir"/></not>
        <not><isset property="shell.installdir"/></not>
      </and>
      <then>
        <property name="nothing-to-install" value="true"/>
      </then>
    </if>
    <msgfail if="nothing-to-install">^^^ERROR:
      No software was chosen to install.
    </msgfail>
  </target>

  <target name="all"
          depends="validate-any,agent.valid-props,shell.valid-props,server.valid-props,agent,shell,server">
    <echo>^^^INFO:
__ll__
Setup completed.
A copy of the output shown above has been saved to:
  ${install.dir}/hq-install.log
__ll__
    </echo>
    <antcall target="pause-before-exit"/>
  </target>

  <!-- If the installer was started by someone double-clicking on the
       setup.bat file, we don't want to make the DOS window just
       disappear on them when the install is done -->
  <target name="pause-before-exit" if="isWin32">
    <if>
      <istrue value="${server.pgsql.available}" />
      <then>
        <input message="Press the Enter key to exit setup."/>
      </then>
    </if>
  </target>

  <target name="agent.valid-props" if="agent.installdir">
    <echo>^^^DEBUG: Validating agent install configuration...</echo>
  </target>

  <target name="validate-os-install">
  </target>

  <target name="agent" 
          depends="agent.valid-props"
          if="agent.installdir"
          description="Install the HQ agent.">
    <echo>^^^INFO: Installing the agent...</echo>
    <echo>^^^DEBUG: Looking for previous installation</echo>
    <echo>^^^INFO:
      Unpacking agent to: ${agent.installdir}/agent-${version}...
    </echo>
    <untar src="${base}/agent-${version}.tgz"
           dest="${agent.installdir}"
           compression="gzip"/>

    <antcall target="install-jre">
      <param name="destination" value="${agent.installdir}/agent-${version}" />
    </antcall>
    <echo>^^^INFO: Setting permissions on agent binaries...</echo>
    <antcall target="chmod-exec">
      <param name="chmod.dir" value="${agent.installdir}/agent-${version}"/>
    </antcall>
    <echo>^^^INFO: Fixing line endings on text files...</echo>
    <antcall target="fix-text-files">
      <param name="crlf.dir" value="${agent.installdir}/agent-${version}"/>
    </antcall>
    <echo>^^^COMPLETION:
      Agent successfully installed to: ${agent.installdir}/agent-${version}
    </echo>
    <concatWithPrefix failOnMissing="false" file="${setup}.agent-summary.txt" prefix="^^^INFO:"/>
  </target>
  
  <target name="shell.valid-props" if="shell.installdir">
    <echo>^^^DEBUG: Validating shell install configuration...</echo>
  </target>

  <target name="shell" 
          depends="shell.valid-props"
          if="shell.installdir"
          description="Install the HQ command shell.">
    <echo>^^^INFO: Installing the shell...</echo>
    <echo>
      ^^^INFO: Unpacking shell to: ${shell.installdir}/shell-${version}...
    </echo>
    <untar src="${base}/shell-${version}.tgz"
           dest="${shell.installdir}"
           compression="gzip"/>
    
    <antcall target="install-jre">
      <param name="destination" value="${shell.installdir}/shell-${version}" />
    </antcall>
    <echo>^^^INFO: Setting permissions on shell binaries...</echo>
    <antcall target="chmod-exec">
      <param name="chmod.dir" value="${shell.installdir}/shell-${version}"/>
    </antcall>
    <echo>^^^INFO: Fixing line endings on text files...</echo>
    <antcall target="fix-text-files">
      <param name="crlf.dir" value="${shell.installdir}/shell-${version}"/>
    </antcall>
    <echo>^^^COMPLETION:
      Command shell successfully installed to: ${shell.installdir}/shell-${version}
    </echo>
    <concatWithPrefix failOnMissing="false" file="${setup}.shell-summary.txt" prefix="^^^INFO:"/>
  </target>

  <target name="validate-user-privs"
          if="server.database-url"
          unless="using.builtin.db">
    <!-- Do a sanity check - does the user have the perms required on the DB -->
    <echo>^^^DEBUG: Checking database permissions...</echo>
    <dbprivcheck jdbcUrl="${server.database-url}" 
                 jdbcUser="${server.database-user}" 
                 jdbcPassword="${server.database-password}" 
                 property="server.db.user.permission"
                 errMsgProperty="errMsg"/>
    <antcall target="fail-if-no-permission">
      <param name="errMsg" value="${errMsg}"/>
    </antcall>
  </target>

  <target name="load-upgrade-conf" if="setup.upgrade">
    <!-- Source the existing consolidated config as properties -->
    <property file="${server.upgradedir}/conf/hq-server.conf"/>
  </target>

  <target name="server.valid-props" depends="load-upgrade-conf" if="server.installdir">
    <echo>^^^DEBUG: Validating server install configuration...</echo>
    <msgfail unless="server.database">^^^ERROR:
      No server.database property specified.
    </msgfail>
    <msgfail unless="server.webapp.port">^^^ERROR:
      No server.webapp.port property specified.
    </msgfail>
    <msgfail unless="server.webapp.secure.port">^^^ERROR:
      No server.webapp.secure.port property specified.
    </msgfail>
    <msgfail unless="server.mail.host">^^^ERROR:
      No server.mail.host property specified.
    </msgfail>
    <if>
      <istrue value="${server.database.create}" />
      <then>
        <msgfail unless="server.webapp.baseurl">^^^ERROR:
          No server.webapp.baseurl property specified.
        </msgfail>
      </then>
    </if>

    <!-- Do a sanity check - is anything listening on the server port now? -->
    <echo>^^^DEBUG: Checking server webapp port...</echo>
    <condition property="server.webapp.port.isAlreadyUsed">
      <socket server="127.0.0.1" port="${server.webapp.port}"/>
    </condition>
    <antcall target="fail-if-webapp-port-used"/>

    <!-- Do a sanity check - is anything listening on the server's secure port now? -->
    <echo>^^^DEBUG: Checking server secure webapp port...</echo>
    <condition property="server.webapp.secure.port.isAlreadyUsed">
      <socket server="127.0.0.1" port="${server.webapp.secure.port}"/>
    </condition>
    <antcall target="fail-if-webapp-secure-port-used"/>
    
    <!-- Do a sanity check - is anything listening on the server port now? -->
    <echo>^^^DEBUG: Checking server JRMP port...</echo>
    <condition property="server.jboss.server.port.isAlreadyUsed">
      <socket server="127.0.0.1" port="${hq-engine.server.port}"/>
    </condition>
    <antcall target="fail-if-mbean-port-used"/>
    
    <!-- Do a sanity check - is anything listening on the JNP port now? -->
    <echo>^^^DEBUG: Checking server JNP port...</echo>
    <condition property="server.jnp.port.isAlreadyUsed">
      <socket server="127.0.0.1" port="${hq-engine.jnp.port}"/>
    </condition>
    <antcall target="fail-if-jnp-port-used"/>

    <!-- Hack to set the builtin flag if hqdb exists in previous install -->
    <available file="${server.upgradedir}/hqdb" property="using.builtin.db"/>

    <!-- Do a sanity check - does the user have the perms required on the DB -->
    <antcall target="validate-user-privs" />

    <if>
      <istrue value="${server.database.create}" />
      <then>
        <echo>^^^DEBUG: Verifying admin user properties</echo>
        <msgfail unless="server.admin.username">^^^ERROR:\
          No server.admin.username property was specified.
        </msgfail>
        <msgfail unless="server.admin.password">^^^ERROR:\
          No server.admin.password property was specified.
        </msgfail>
        <msgfail unless="server.admin.email">^^^ERROR:\
          No server.admin.email property was specified.
        </msgfail>

        <condition property="server.admin.username.illegal">
          <equals arg1="${server.admin.username}" arg2="admin" trim="true"/>
        </condition>
        <msgfail if="server.admin.username.illegal">^^^ERROR:\
          The server.admin.username property has an illegal or reserved value.
        </msgfail>
      </then>
    </if>

    <!-- Do DB-specific validation stuff -->
    <echo>^^^DEBUG: Validating server DB configuration...</echo>
    <ant antfile="setup-db-${server.database}.xml" 
         target="validate"/>
  </target>

  <target name="fail-if-webapp-port-used" if="server.webapp.port.isAlreadyUsed">
    <msgfail>^^^ERROR:\
      There is already a program using port ${server.webapp.port}.
      Please choose a different value for the server.webapp.port property.
    </msgfail>
  </target>
  <target name="fail-if-webapp-secure-port-used" if="server.webapp.secure.port.isAlreadyUsed">
    <msgfail>^^^ERROR:\
      There is already a program using port ${server.webapp.secure.port}.
      Please choose a different value for the server.webapp.secure.port property.
    </msgfail>
  </target>
  <target name="fail-if-jnp-port-used" if="server.jnp.port.isAlreadyUsed">
    <msgfail>^^^ERROR:\
      There is already a program using port ${hq-engine.jnp.port}.
      Please choose a different value for the hq-engine.jnp.port property.
    </msgfail>
  </target>
  <target name="fail-if-mbean-port-used" if="server.jboss.server.port.isAlreadyUsed">
    <msgfail>^^^ERROR:\
      There is already a program using port ${hq-engine.server.port}.
      Please choose a different value for the hq-engine.server.port property.
    </msgfail>
  </target>
  <target name="fail-if-no-permission" unless="server.db.user.permission">
    <msgfail>^^^ERROR:\
${errMsg}
    </msgfail>
  </target>

  <target name="server" 
          depends="validate-os-install,server.valid-props,fail-if--server.alreadyInstalled"
          if="server.installdir"
          description="Install or upgrade the HQ server.">
    <antcall target="server-install"/>
    <antcall target="server-upgrade"/>
  </target>

  <target name="server-install" depends="setup-server-init" unless="setup.upgrade">
    <echo>^^^INFO: Installing the server...</echo>
    <antcall target="setup-server"/>
    <echo>^^^COMPLETION:
      Server successfully installed to: ${server.product.dir}
    </echo>
    <concatWithPrefix failOnMissing="false" file="${setup}.server-summary.txt" prefix="^^^INFO:"/>
  </target>

  <target name="server-upgrade" depends="setup-server-init" if="setup.upgrade">
    <echo>^^^INFO: Upgrading the server...</echo>
    <antcall target="setup-server"/>
    <!-- Copy the existing consolidated config -->
    <copy file="${server.upgradedir}/conf/hq-server.conf" 
          todir="${server.installdir}/server-${version}/conf"/>
    <!-- Copy the existing license file, if there is one -->
    <copy file="${server.upgradedir}/conf/license.xml" 
          todir="${server.installdir}/server-${version}/conf"
          failonerror="false"/>
    <echo>^^^COMPLETION:
      Server successfully upgraded to: ${server.product.dir}
    </echo>
    <concatWithPrefix failOnMissing="false" file="${setup}.server-summary.txt" prefix="^^^INFO:"/>
  </target>

  <target name="setup-server-init">
    <property name="server.vname" value="server-${version}"/>
    <property name="server.product.dir" 
              value="${server.installdir}/${server.vname}"/>
  </target>

  <target name="generate-hq-server-conf" unless="setup.upgrade">
    <substProps src="${install.dir}/data/hq-server.conf"
                dest="${conf-dir}/hq-server.conf"/>
  </target>

  <target name="setup-server">
    <echo>
      ^^^INFO: Unpacking server to: ${server.installdir}/server-${version}...
    </echo>
    <untar src="${base}/${server.vname}.tgz"
           dest="${server.installdir}"
           compression="gzip"/>

    <!-- Setup conf directory -->
    <echo>^^^INFO: Creating server configuration files...</echo>
    <property name="conf-dir" value="${server.product.dir}/conf"/>
    <mkdir dir="${conf-dir}/templates"/>
    <copy todir="${conf-dir}/templates">
      <fileset dir="${install.dir}/data/hq-engine" includes="**"/>
    </copy>
    <antcall target="copy-license"/>
    <antcall target="generate-hq-server-conf"/>

    <property name="jboss.home"
              value="${server.product.dir}/hq-engine"/>
    <property name="deploy-dir"
              value="${jboss.home}/server/default/deploy"/>

    <echo>^^^INFO: Copying binaries and libraries to server installation...</echo>

    <!-- We only keep this file around for debugging, in case we need
         to know what settings the user used when they originally
         installed the server -->
    <echo>^^^DEBUG: Copying server configuration file...</echo>
    <copy tofile="${server.product.dir}/data/hq-server-install.conf"
          file="${setup.absolute}"/>
    <chmod file="${server.product.dir}/data/hq-server-install.conf" perm="go-rwx"/>
              
    <!-- Copy server control file to server's data dir -->
    <mkdir dir="${server.product.dir}/data"/>
    <echo>^^^DEBUG: Copying server control file...</echo>
    <copy todir="${server.product.dir}/data"
          file="${install.dir}/data/server.xml"/>

    <!-- Copy common utils to server's bin dir -->
    <echo>^^^DEBUG: Copying server binaries...</echo>
    <copy todir="${server.product.dir}/bin">
      <fileset dir="${install.dir}/bin">
        <include name="server*${script-ext}"/>
        <include name="ant*"/>
        <include name="lcp${script-ext}"/>
      </fileset>
    </copy>

    <!-- Copy lib jars to server's lib dir -->
    <echo>^^^DEBUG: Copying server libs...</echo>
    <mkdir dir="${server.product.dir}/lib"/>
    <copy todir="${server.product.dir}/lib">
      <fileset dir="${install.dir}/lib">
        <include name="ant-contrib.jar"/>
        <include name="ant.jar"/>
        <include name="ant-launcher.jar"/>
        <include name="commons-logging.jar"/>
        <include name="hq-installer.jar"/>
        <include name="hq-boot.jar"/>
        <include name="jakarta-oro-2.0.7.jar"/>
        <include name="sigar-x86-winnt.dll"/>
        <include name="libsigar-hppa2.0-hp-hpux-11.x.sl"/>
        <include name="libsigar-powerpc-ibm-aix-4.3.x.so"/>
        <include name="libsigar-sparc-sun-solaris-2.x.so"/>
        <include name="libsigar-x86-linux.so"/>
        <include name="libsigar-x86-sun-solaris-2.x.so"/>
        <include name="libreadline-java.jar"/>
        <include name="ojdbc14.jar"/>
        <include name="postgresql-7.4.3.jar"/>
        <include name="optional.jar"/>
        <include name="sigar.jar"/>
        <include name="xercesImpl.jar"/>
        <include name="xml-apis.jar"/>
      </fileset>
    </copy>

    <!-- Do DB-specific stuff -->
    <echo>^^^INFO: Setting up server database...</echo>
    <ant antfile="setup-db-${server.database}.xml" target="setup"/>

    <antcall target="install-jre">
      <param name="destination" value="${server.product.dir}" />
    </antcall>

    <!-- Mark executables as executable -->
    <echo>^^^INFO: Setting permissions on server binaries...</echo>
    <antcall target="chmod-exec">
      <param name="chmod.dir" value="${server.product.dir}"/>
    </antcall>
    <echo>^^^INFO: Fixing line endings on text files...</echo>
    <antcall target="fix-text-files">
      <param name="crlf.dir" value="${server.product.dir}"/>
    </antcall>

    <delete dir="${server.product.dir}/data/conf"/>

    <antcall target="debug-setup"/>
  </target>

  <target name="copy-license" unless="setup.upgrade">
    <copy file="${install.dir}/data/license.xml" todir="${conf-dir}"
          failonerror="false"/>
  </target>

  <!-- If server.overwrite is not set or is false, check for an
       existing HQ server installation -->
  <target name="fail-if--server.alreadyInstalled"
		  if="server.installdir"
          unless="server.dont-check-for-overwrite">
    <condition property="server.isInstalled">
      <or>
        <available file="${server.installdir}/server-${version}"/>
        <available file="${server.installdir}/data/server.xml"/>
        <available file="${server.installdir}/conf/hq-server.conf"/>
      </or>
    </condition>
    <msgfail if="server.isInstalled">^^^ERROR:\
      The installer detected that a Hyperic HQ server is already
      installed in ${server.installdir}/server-${version}
    </msgfail>
  </target>

  <!-- Only fix line endings on windows.  Line endings will not contain CR's
       so there should be no reason to run this on unix platforms.  This
       task is also broken on Darwin with Ant 1.5 -->
  <target name="fix-text-files" if="isWin32">
    <fixcrlf srcdir="${crlf.dir}"
        includes="**/*.bat **/*.properties **/*.txt **/ReadMe* **/*.conf **/*.xml"/>
  </target>

  <target name="chmod-exec">
    <chmod perm="a+rx">
      <fileset dir="${chmod.dir}">
        <include name="**/bin/*"/>
        <include name="**/*.sh"/>
        <include name="**/*.bat"/>
        <include name="**/*.cmd"/>
        <include name="**/*.sl"/>
      </fileset>
    </chmod>
  </target>

  <target name="debug-check">
    <condition property="debug.enabled">
      <available file="${install.dir}/data/debug"/>
    </condition>
  </target>
  <target name="debug-setup" depends="debug-check" if="debug.enabled">
    <echo>^^^INFO: Setting up debugging code...</echo>
    <ant antfile="${install.dir}/data/debug/install-build.xml"
         target="install">
      <property name="debug.home" value="${install.dir}/data/debug"/>
      <property name="jboss.home" value="${jboss.home}"/>
    </ant>
  </target>

</project>
