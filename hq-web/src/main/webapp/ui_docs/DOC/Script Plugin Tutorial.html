<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
    <head>
        <title>Hyperic 4.6 Documentation : Script Plugin Tutorial</title>
	    <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">	    
    </head>

    <body>
	    <table class="pagecontent" border="0" cellpadding="0" cellspacing="0" width="100%" bgcolor="#ffffff">
		    <tr>
			    <td valign="top" class="pagebody">
				    <div class="pageheader">
					    <span class="pagetitle">
                            Hyperic 4.6 Documentation : Script Plugin Tutorial
                                                    </span>
				    </div>
				    <div class="pagesubheading">
					    This page last changed on Jun 07, 2011 by <font color="#0050B2">mmcgarry</font>.
				    </div>

				    <style type='text/css'>/*<![CDATA[*/
div.rbtoc1307466541641 {margin-left: 1.5em;padding: 0px;}
div.rbtoc1307466541641 ul {list-style: disc;margin-left: 0px;padding-left: 20px;}
div.rbtoc1307466541641 li {margin-left: 0px;padding-left: 0px;}

/*]] >*/</style><div class='rbtoc1307466541641'>
<ul>
    <li><a href='#ScriptPluginTutorial-ScriptMeasurementPlugin'> Script Measurement Plugin</a></li>
    <li><a href='#ScriptPluginTutorial-HowthePluginFitsIntoHQ%27sInventoryModel'>How the Plugin Fits Into HQ's Inventory Model</a></li>
    <li><a href='#ScriptPluginTutorial-StepbyStepInstructions'>Step-by-Step Instructions</a></li>
<ul>
    <li><a href='#ScriptPluginTutorial-Step1Writeascript'>Step 1 - Write a script</a></li>
    <li><a href='#ScriptPluginTutorial-Step2ReviewtheSampleScriptMeasurementPluginDescriptor'>Step 2 - Review the Sample Script Measurement Plugin Descriptor</a></li>
    <li><a href='#ScriptPluginTutorial-Step3.WhatThisPluginWillShowintheHQUI'>Step 3. What This Plugin Will Show in the HQ UI</a></li>
    <li><a href='#ScriptPluginTutorial-Step4UnderstandandModifyEachPieceoftheSamplePluginXMLDescriptor'>Step 4 - Understand and Modify Each Piece of the Sample Plugin XML Descriptor</a></li>
<ul>
    <li><a href='#ScriptPluginTutorial-IncludeorReferencetheScript'>Include or Reference the Script</a></li>
    <li><a href='#ScriptPluginTutorial-IdentifytheExactProcessesYouWanttoMonitor'>Identify the Exact Processes You Want to Monitor</a></li>
    <li><a href='#ScriptPluginTutorial-AutoDiscovertheServerandServices'>Auto-Discover the Server and Services</a></li>
    <li><a href='#ScriptPluginTutorial-DefineandGatherServerMetrics'>Define and Gather Server Metrics</a></li>
    <li><a href='#ScriptPluginTutorial-IdentifyandGatherMetricsfromtheServer%27sHostedServices'>Identify and Gather Metrics from the Server's Hosted Services</a></li>
    <li><a href='#ScriptPluginTutorial-ProvideConfigurationInstructions'>Provide Configuration Instructions</a></li>
</ul>
    <li><a href='#ScriptPluginTutorial-Step5TestthePlugin'>Step 5 - Test the Plugin</a></li>
    <li><a href='#ScriptPluginTutorial-Step6DeploythePlugin'>Step 6 - Deploy the Plugin</a></li>
</ul>
</ul></div>

<h1><a name="ScriptPluginTutorial-ScriptMeasurementPlugin"></a><a name="ScriptPluginTutorial-top"></a>Script Measurement Plugin</h1>

<p>This tutorial will lead you through writing, testing, and deploying a simple script measurement plugin that auto-discovers and collects several metrics from Sendmail and its processes. The Sendmail plugin is one of the simplest script measurement plugins in HQ. </p>

<h1><a name="ScriptPluginTutorial-HowthePluginFitsIntoHQ%27sInventoryModel"></a>How the Plugin Fits Into HQ's Inventory Model</h1>

<p>This plugin fits into the HQ inventory model by starting at the server level and organizing several services under it. Other plugins targeting only a service could bypass the server and be organized directly under the platform  on which it is run.</p>

<h1><a name="ScriptPluginTutorial-StepbyStepInstructions"></a>Step-by-Step Instructions</h1>

<h2><a name="ScriptPluginTutorial-Step1Writeascript"></a>Step 1 - Write a script</h2>

<p>This you can do on your own, but keep the following things in mind:</p>

<ul>
	<li>The script must retrieve the metrics you want to see in HQ, and it must output them in a specific format: <tt>name=value</tt> pairs. These name-value pairs will also be the output of the plugin. For a simple example:
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">$ ${HQ_HOME}/plugins/scripts/script.pl
Availability=0
Metric=8192</pre>
		</div>
</div></div></li>
	<li>Place the script in <tt>AgentBundleDir/pdk/scripts/</tt>, for reference from within the plugin's XML descriptor. You can also place the script directly in the XML descriptor.</li>
	<li>Note the name of your script.</li>
</ul>



<h2><a name="ScriptPluginTutorial-Step2ReviewtheSampleScriptMeasurementPluginDescriptor"></a>Step 2 - Review the Sample Script Measurement Plugin Descriptor</h2>

<p>The sample script plugin XML descriptor below &#8212; Sendmail Script Meaurement Plugin &#8212; autodiscovers and collects several metrics from a Sendmail server and its hosted services. The sample provides the structure of the plugin, and you should start with it when writing your own plugin. You will need to change certain values &#8212; which we'll point out &#8212; within the descriptor.</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">&lt;plugin&gt;

&lt;script name="hq-sendmail-stat"&gt;
&lt;![CDATA[
#!/bin/sh
# linux
[ -d "/var/spool/mqueue" ] &amp;&amp;
    msgdir="/var/spool/mqueue" &amp;&amp;
    premsgdir="/var/spool/clientmqueue"
# solaris
[ -d "/usr/spool/mqueue" ] &amp;&amp;
    msgdir="/usr/spool/mqueue" &amp;&amp;
    premsgdir="/usr/spool/clientmqueue"
[ -z "$msgdir" ] &amp;&amp;
    exit 1
cd $msgdir
[ $? != 0 ] &amp;&amp;
    exit 1
messfiles=`find * -print 2&gt;/dev/null | wc -w`
cd $premsgdir
[ $? != 0 ] &amp;&amp;
    exit 1
premessfiles=`find * -print 2&gt;/dev/null | wc -w`
echo MessagesInQueue=$messfiles
echo MessagesAwaitingPreprocessing=$premessfiles
]]&gt;
&lt;/script&gt;

&lt;server name="SendMail"&gt;

&lt;config&gt;
&lt;option name="process.query" description="Process Query"
default="State.Name.eq=sendmail,CredName.User.eq=root"/&gt;
&lt;option name="exec"
description="Type &amp;quot;sudo$quot; To Avoid Having Agent As Root"
default=""/&gt;
&lt;/config&gt;

&lt;property name="HAS_BUILTIN_SERVICES" value="true"/&gt;
&lt;property name="PROC_QUERY" value="State.Name.eq=sendmail"/&gt;
&lt;plugin type="autoinventory" class="org.hyperic.hq.product.DaemonDetector"/&gt;
&lt;plugin type="measurement" class="org.hyperic.hq.product.MeasurementPlugin"/&gt;

&lt;metric name="Availability"
alias="Availability"
template="sigar:Type=ProcState,Arg=%process.query%:State"
category="AVAILABILITY" indicator="true" units="percentage" collectionType="dynamic"/&gt;

&lt;service name="SendMail Message Submission Process"&gt;

&lt;config&gt;
&lt;option name="process.query"
default="State.Name.eq=sendmail,CredName.User.ne=root"
description="PTQL for SendMail Message Submission Process"/&gt;
&lt;/config&gt;

&lt;metric name="Availability"
template="sigar:Type=ProcState,Arg=%process.query%:State" indicator="true"/&gt;

&lt;/service&gt;

&lt;service name="SendMail Root Daemon Process"&gt;

&lt;config&gt;
&lt;option name="process.query"
default="State.Name.eq=sendmail,CredName.User.eq=root"
description="PTQL for SendMail Root Daemon Process"/&gt;
&lt;/config&gt;

&lt;metric name="Availability"
template="sigar:Type=ProcState,Arg=%process.query%:State"
indicator="true"/&gt;
&lt;/service&gt;

&lt;filter name="template"
value="exec:timeout=10,file=pdk/work/scripts/sendmail/hq-sendmail-stat,exec=%exec%:${alias}"/&gt;

&lt;metric name="Messages In Queue" indicator="true"/&gt;

&lt;metric name="Messages Awaiting Preprocessing" indicator="true"/&gt;

&lt;service name="SMTP"&gt;

&lt;config&gt;
&lt;option name="hostname" description="SMTP Hostname" default="localhost"/&gt;
&lt;/config&gt;

&lt;filter name="template" value="SMTP:hostname=%hostname%:${alias}"/&gt;

&lt;metric name="Availability" indicator="true"/&gt;

&lt;metric name="Inbound Connections" indicator="true"/&gt;

&lt;metric name="Outbound Connections" indicator="true"/&gt;

&lt;/service&gt;
&lt;/server&gt;

&lt;!--
 ==================== Plugin Help ===========================
--&gt;
&lt;help name="SendMail"&gt;
  &lt;p&gt;
  &lt;h3&gt;Configure HQ for monitoring SendMail&lt;/h3&gt;
  &lt;/p&gt;
  &lt;p&gt;
  This plugin needs sudo access as root in order to access the appropriate
  &lt;br&gt;
  SendMail dirs.
  &lt;br&gt;
  To configure sudo (in /etc/sudoers):
  &lt;br&gt;
  Cmnd_Alias HQ_SENDMAIL_STAT = &amp;lt;hqdir&amp;gt;/agent/pdk/work/scripts/sendmail/hq-sendmail-stat
  &lt;br&gt;
  &amp;lt;agentuser&amp;gt; ALL = NOPASSWD: HQ_SENDMAIL_STAT
  &lt;/p&gt;
  &lt;/help&gt;
&lt;/plugin&gt;</pre>
		</div>
</div></div>

<h2><a name="ScriptPluginTutorial-Step3.WhatThisPluginWillShowintheHQUI"></a>Step 3. What This Plugin Will Show in the HQ UI</h2>

<p>A plugin with the XML descriptor above will show in the HQ UI:</p>
<ul>
	<li>The existence of the Sendmail server and the three component processes ("services") &#8212; SendMail Message Submission Process, SendMail Root Daemon Process, and SMTP &#8212; that it hosts</li>
	<li>For each of these four resources (one server and three services), its availability.</li>
	<li>For the Sendmail server, these metrics:
	<ul>
		<li>Messages In Queue</li>
		<li>Messages Awaiting Preprocessing</li>
	</ul>
	</li>
	<li>For the SMTP service, these metrics:
	<ul>
		<li>Inbound Connections</li>
		<li>Outbound Connections</li>
	</ul>
	</li>
	<li>Configuration instructions for the Sendmail server, on the server's <b>Configuration Properties</b> page.</li>
</ul>



<h2><a name="ScriptPluginTutorial-Step4UnderstandandModifyEachPieceoftheSamplePluginXMLDescriptor"></a>Step 4 - Understand and Modify Each Piece of the Sample Plugin XML Descriptor</h2>

<p>The sample XML descriptor above is divided into parts, each of which is repeated and explained for your particular use below. Some of the more important parts of the XML descriptor are called out.</p>

<p>Learn more about <a href="Plugin Descriptors.html" title="Plugin Descriptors">Plugin Descriptors</a>.</p>

<h3><a name="ScriptPluginTutorial-IncludeorReferencetheScript"></a>Include or Reference the Script</h3>

<p>This is the actual script &#8212; <tt>hq-sendmail-stat</tt> &#8212; to be executed by the plugin.</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">&lt;plugin&gt;

&lt;script name="hq-sendmail-stat"&gt;
#!/bin/sh
# linux
[ -d "/var/spool/mqueue" ] &amp;&amp;
    msgdir="/var/spool/mqueue" &amp;&amp;
    premsgdir="/var/spool/clientmqueue"
# solaris
[ -d "/usr/spool/mqueue" ] &amp;&amp;
    msgdir="/usr/spool/mqueue" &amp;&amp;
    premsgdir="/usr/spool/clientmqueue"
[ -z "$msgdir" ] &amp;&amp;
    exit 1
cd $msgdir
[ $? != 0 ] &amp;&amp;
    exit 1
messfiles=`find * -print 2&gt;/dev/null | wc -w`
cd $premsgdir
[ $? != 0 ] &amp;&amp;
    exit 1
premessfiles=`find * -print 2&gt;/dev/null | wc -w`
echo MessagesInQueue=$messfiles
echo MessagesAwaitingPreprocessing=$premessfiles
&lt;/script&gt;</pre>
		</div>
</div></div>

<p>You can embed your script in the XML descriptor as is done here, or you can keep it in a separate file and reference it by putting this line before the config options, like so:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">&lt;plugin&gt;

&lt;server name="SendMail"&gt;
&lt;filter name="script" value="pdk/scripts/hq-sendmail-stat.pl"/&gt;
&lt;config&gt;
&lt;option name="process.query"
...</pre>
		</div>
</div></div>

<p>where you would replace "hq-sendmail-stat.pl" with the name of your script. It must always be in the <tt>pdk/scripts</tt> directory, and HQ assumes that that is in the Agent directory.</p>

<p>This code identifies the server being monitored by the plugin.</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">&lt;server name="SendMail"&gt;</pre>
		</div>
</div></div>

<p>This value will be displayed in the UI for the server, so while you <em>can</em> name it anything you want, we recommend naming it something meaningful. If you want to monitor only a service, change <tt>server</tt> to <tt>service</tt> and name the service.</p>

<h3><a name="ScriptPluginTutorial-IdentifytheExactProcessesYouWanttoMonitor"></a>Identify the Exact Processes You Want to Monitor</h3>

<p>This code specifically identifies the exact process(es) of interest.</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">&lt;config&gt;
&lt;option name="process.query" description="Process Query"
default="State.Name.eq=sendmail,CredName.User.eq=root"/&gt;</pre>
		</div>
</div></div>

<p><tt>State.Name.eq=sendmail</tt> makes sure the query returns only sendmail processes, and <tt>CredName.User.eq=root</tt> makes sure the query returns only those Sendmail processes with root access. In this case, we need root access to access the (Sendmail) server. The query is written in Sigar PTQL, which isn't necessary to understand for this tutorial, but would be useful to understand for future, custom plugins.</p>

<p>If you are interested in a different application or different Sendmail processes, replace <tt>sendmail</tt> with a different server name or <tt>CredName.User.eq=root</tt> with a different filter that will get you the desired set of processes.</p>

<p>\This code isn't strictly necessary for the operation of the plugin. It is used in conjunction with  later lines to use sudo instead of root access in order to tidy the console display while the plugin is running.</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">&lt;option name="exec"
description="Type &amp;quot;sudo$quot; To Avoid Having Agent As Root"
default=""/&gt;
&lt;/config&gt;</pre>
		</div>
</div></div>

<p>You can remove it or keep as-is.</p>
<h3><a name="ScriptPluginTutorial-AutoDiscovertheServerandServices"></a>Auto-Discover the Server and Services</h3>
<p>This code implements auto-discovery.</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">&lt;property name="HAS_BUILTIN_SERVICES" value="true"/&gt;
&lt;property name="PROC_QUERY" value="State.Name.eq=sendmail"/&gt;
&lt;plugin type="autoinventory" class="org.hyperic.hq.product.DaemonDetector"/&gt;</pre>
		</div>
</div></div>

<p>The first line tells HQ that the Sendmail server has component services, so please auto-discover them, too. Keep it as-is if your server contains services you want to discover and manage. The second line tells HQ to discovery if the Sendmail process is running or not. In a different plugin, to determine the existence of a different product, replace <tt>sendmail</tt> with the name of the application you're writing the plugin for (and <a href="#ScriptPluginTutorial-processquery">the one you just queried for</a>). The third line invokes HQ's already defined auto-discovery process; Keep it as is.<br/>
In a plugin targeted at a service (not at the server level), there does not exist a similarly simple way to conduct auto-discovery. A simple workaround is to write the plugin at the server level anyway and then include that one service you're interested in. That way, you can use this code as-is.</p>

<div class='panelMacro'><table class='warningMacro'><colgroup><col width='24'><col></colgroup><tr><td valign='top'><img src="images/icons/emoticons/forbidden.gif" width="16" height="16" align="absmiddle" alt="" border="0"></td><td><b>My Services Aren't Being Auto-Discovered</b><br />If your services are not being auto-discovered via your plugin (and you are relying on HQ's built-in auto-discovery process, as above), the most likely culprit is that you left out this line:
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">&lt;property name="HAS_BUILTIN_SERVICES" value="true"/&gt;</pre>
		</div>
</div></div></td></tr></table></div>

<p>This code simply tells HQ what type of plugin this is &#8212; Measurement &#8212; so that HQ will know how to execute the plugin.</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">&lt;plugin type="measurement" class="org.hyperic.hq.product.MeasurementPlugin"/&gt;</pre>
		</div>
</div></div>

<p>For all Measurement plugins, keep it as-is. </p>

<h3><a name="ScriptPluginTutorial-DefineandGatherServerMetrics"></a>Define and Gather Server Metrics</h3>

<p>This code collects the requisite Availability metric, this time at the Sendmail-server level. (It is later collected for all Sendmail's component services.)</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: xml; gutter: false">&lt;metric name="Availability"
alias="Availability"
template="sigar:Type=ProcState,Arg=%process.query%:State"
category="AVAILABILITY" indicator="true" units="percentage" collectionType="dynamic"/&gt;</pre>
		</div>
</div></div>

<p>The variable %process.query% gets assigned the value from the above process.query (which determined whether or not the server exists), and so then the plugin can determine whether or not the service is available. Keep it as-is.</p>

<p>For each metric you collect, you must specify at least the following attributes:</p>
<div class='table-wrap'>
<table class='confluenceTable'><tbody>
<tr>
<th class='confluenceTh'> Metric Attribute </th>
<th class='confluenceTh'> Description </th>
<th class='confluenceTh'> Req'd </th>
<th class='confluenceTh'> Possible Values </th>
</tr>
<tr>
<td class='confluenceTd'> <tt>name</tt> </td>
<td class='confluenceTd'> Name of the metric to be displayed in the GUI </td>
<td class='confluenceTd'> Y </td>
<td class='confluenceTd'>&nbsp;</td>
</tr>
<tr>
<td class='confluenceTd'> <tt>indicator</tt> </td>
<td class='confluenceTd'> Whether or not this metric should be treated as an <a href="http://support.hyperic.com/display/DOCS46/Hyperic+Glossary#HypericGlossary-indicatormetric">indicator metric</a> in HQ </td>
<td class='confluenceTd'> Y </td>
<td class='confluenceTd'> true, false </td>
</tr>
<tr>
<td class='confluenceTd'> <tt>template</tt> </td>
<td class='confluenceTd'>&nbsp;</td>
<td class='confluenceTd'>&nbsp;</td>
</tr>
</tbody></table>
</div>


<h3><a name="ScriptPluginTutorial-IdentifyandGatherMetricsfromtheServer%27sHostedServices"></a>Identify and Gather Metrics from the Server's Hosted Services</h3>

<p>Now that we've established the minimum requirements at the Sendmail server level (auto-discovery and the Availability metric), we can proceed to the component Sendmail processes. The next many lines of code deal with each individual Sendmail service (process) under the Sendmail server: SendMail Message Submission Process, SendMail Root Daemon Process, and SMTP. If your server contains services, break them out here just as this code does.</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">&lt;service name="SendMail Message Submission Process"&gt;
&lt;config&gt;
&lt;option name="process.query"
default="State.Name.eq=sendmail,CredName.User.ne=root"
description="PTQL for SendMail Message Submission Process"/&gt;
&lt;/config&gt;
&lt;metric name="Availability"
template="sigar:Type=ProcState,Arg=%process.query%:State"
indicator="true"/&gt;
&lt;/service&gt;</pre>
		</div>
</div></div>
<p>First the existence of the exact Sendmail process &#8212; SendMail Message Submission Process &#8212; is determined with a <tt>process.query</tt>. In this case, this process can be uniquely identified by asking for a Sendmail process that does <em>not</em> have root access (<tt>CredName.User.ne=root</tt>). If you are working with another process, then replace <tt>sendmail</tt> with the appropriate server name or <tt>CredName.User.ne</tt> with the appropriate filtering criterion.  Then the requisite Availability metric (of the specific process we just identified) is gathered. Keep it as-is.</p>

<p>To find the exact names of the processes you are interested in so that you can name them in your plugin:<br/>
In the HQ Agent directory, start SIGAR:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">java -jar &lt;Agent dir&gt;/pdfk/lib/sigar.jar.</pre>
		</div>
</div></div>
<p>At the SIGAR prompt, run:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">sigar&gt; ps State.Name.eq=sendmail</pre>
		</div>
</div></div>
<p>where, instead of <tt>sendmail</tt> you type the name of the application you're running the script against. The results of this command are equivalent to those returned by <tt>ps</tt>: a list of Sendmail processes running.</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">In the XML descriptor, you would use one of these process names like this:
&lt;service name="process_name_here"&gt;</pre>
		</div>
</div></div>
<p>where <tt>process_name_here</tt> can be, for example, <tt>SendMail Message Submission Process</tt>.</p>

<p> Now the second Sendmail process &#8212; SendMail Root Daemon Process &#8212; is identified with another <tt>process.query</tt>.</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">&lt;service name="SendMail Root Daemon Process"&gt;

&lt;config&gt;
&lt;option name="process.query"
default="State.Name.eq=sendmail,CredName.User.eq=root"
description="PTQL for SendMail Root Daemon Process"/&gt;
&lt;/config&gt;

&lt;metric name="Availability"
template="sigar:Type=ProcState,Arg=%process.query%:State"
indicator="true"/&gt;
&lt;/service&gt;</pre>
		</div>
</div></div>
<p>Unlike with the first process, this time we want a Sendmail process <em>with</em> root access (<tt>CredName.User.eq=root</tt>). If you are working with another process (service), then replace <tt>sendmail</tt> with the appropriate server name and <tt>CredName.User.eq</tt> with the appropriate filtering criterion. Then the requisite Availability metric (of the specific process we just identified) is gathered. Keep it as-is.</p>

<p>This code collects two metrics for the Sendmail server.</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">&lt;filter name="template"
value="exec:timeout=10,file=pdk/work/scripts/sendmail/hq-sendmail-stat,exec=%exec%:${alias}"/&gt;

&lt;metric name="Messages In Queue"
indicator="true"/&gt;

&lt;metric name="Messages Awaiting Preprocessing"
indicator="true"/&gt;</pre>
		</div>
</div></div>
<p>The code is not defined within a service object, therefore it applies to the server.</p>

<p>In this case, the filter applies the template to all the following metrics. </p>

<p>To get each of the two metrics, HQ will run the <tt>hq-sendmail-stat</tt> script, with a 10-second timeout, using the <tt>exec</tt> value <a href="#ScriptPluginTutorial-exec">previously established</a>, which is prepended to whatever it is you're executing (here, instructions to use "sudo" are prepended to the script). The use of <tt>$(alias)</tt> means that the <tt>alias</tt> value will assume the metric <tt>name</tt> specified just below. Learn more about the <a href="Measurement Plugin.html#MeasurementPlugin-metrictag">alias attribute</a>.</p>

<div class='panelMacro'><table class='infoMacro'><colgroup><col width='24'><col></colgroup><tr><td valign='top'><img src="images/icons/emoticons/information.gif" width="16" height="16" align="absmiddle" alt="" border="0"></td><td><b>It's a Good Habit to Specify a Timeout Value</b><br />When HQ runs a script, it will use a default timeout value. However, it is a good practice to make the timeout value explicit (implicit unit of measure is seconds) when using the <tt>exec</tt> command so that, if the script fails, that is one fewer variable you have to figure out in your troubleshooting.</td></tr></table></div>
<p>Now we address the last Sendmail process of interest: SMTP.</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">&lt;service name="SMTP"&gt;

&lt;config&gt;
&lt;option name="hostname"
description="SMTP Hostname"
default="localhost"/&gt;
&lt;/config&gt;

&lt;filter name="template"
value="SMTP:hostname=%hostname%:${alias}"/&gt;

&lt;metric name="Availability"
indicator="true"/&gt;

&lt;metric name="Inbound Connections"
indicator="true"/&gt;

&lt;metric name="Outbound Connections"
indicator="true"/&gt;

&lt;/service&gt;
&lt;/server&gt;</pre>
		</div>
</div></div>
<p>This code takes advantage of a pre-existing "protocol checker" for SMTP, which knows how to get SMTP metrics. You must first declare SMTP as a service and then simply pass to the checker the hostname and the metric name, as is done here. If you are interested in additional SMTP metrics, simply add another line specifying the metric name. </p>

<h3><a name="ScriptPluginTutorial-ProvideConfigurationInstructions"></a>Provide Configuration Instructions</h3>

<p>This code includes the configuration instructions that show up at the bottom of the resource "<a href="ui-Inventory.Configuration.html" title="ui-Inventory.Configuration">Resource Configuration</a>" screen.</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: xml; gutter: false">&lt;!--
 ==================== Plugin Help ===========================
--&gt;
&lt;help name="SendMail"&gt;
  &lt;p&gt;
  &lt;h3&gt;Configure HQ for monitoring SendMail&lt;/h3&gt;
  &lt;/p&gt;
  &lt;p&gt;
  This plugin needs sudo access as root in order to access the appropriate SendMail dirs.
  &lt;br&gt;
  To configure sudo (in /etc/sudoers):
  &lt;br&gt;
  Cmnd_Alias HQ_SENDMAIL_STAT = &amp;lt;hqdir&amp;gt;/agent/pdk/work/scripts/sendmail/hq-sendmail-stat
  &lt;br&gt;
  &amp;lt;agentuser&amp;gt; ALL = NOPASSWD: HQ_SENDMAIL_STAT
  &lt;/p&gt;
  &lt;/help&gt;
&lt;/plugin&gt;</pre>
		</div>
</div></div>
<p>For your plugin, replace this help with whatever configuration instructions are necessary for getting the plugin running in your environment (prerequisites, etc.). </p>


<h2><a name="ScriptPluginTutorial-Step5TestthePlugin"></a>Step 5 - Test the Plugin</h2>

<p>For instructions, see <a href="Running and Testing Plugins from Command Line.html" title="Running and Testing Plugins from Command Line">Running and Testing Plugins from Command Line</a></p>

<h2><a name="ScriptPluginTutorial-Step6DeploythePlugin"></a>Step 6 - Deploy the Plugin</h2>

<p>Before deploying your complete and successfully tested plugin, if your script is not already embedded in the plugin, make sure the script is in <tt>&lt;Agent dir&gt;/pdk/scripts</tt> and that it's executable.</p>

<p>For instructions, see <a href="Deploy Plugin.html" title="Deploy Plugin">Deploy Plugin</a>.</p>

<p>Your plugin should now kick into action the next time the Agent runs (assuming it's been rebooted since the plugin was added to it), and you should see all the desired metrics in the HQ UI.</p>


				    
                                            <div class="tabletitle">
                            <a name="comments">
                                <h2>Comments:</h2>
                            </a>
                        </div>

                        <table border="0" width="100%">
                                                        <tr>
                                <td >
                                    <a name="comment-77465017"></a>
                                    <font class="smallfont"><p>I think the single command doesn't test your plugin and output the metrics:</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">java -jar &lt;Agent Directory&gt;/pdk/lib/hq-product.jar -Dplugins.include=yourPluginName -m metric</pre>
		</div>
</div></div>

<p>You have to follow the Wiki page <a href="http://support.hyperic.com/display/DOCS46/Invoking+Plugins+Standalone" title="Invoking Plugins Standalone">Invoking Plugins Standalone</a> and create a plugin properties file. Based on this properties you can collect metrics:</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">java -jar pdk/lib/hq-product.jar -m discover -p yourPluginName -a properties
java -jar &lt;Agent Directory&gt;/pdk/lib/hq-product.jar -Dplugins.include=yourPluginName -m metric plugin-properties/yourServername</pre>
		</div>
</div></div>

</font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by excowboy at Nov 12, 2008 15:03
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-77465014"></a>
                                    <font class="smallfont"><p>Thank you, Mirko - I was going crazy trying to figure out how to get my server plugin to run, and your comment saved my sanity.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by timcharper at Jan 12, 2009 15:58
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-77465013"></a>
                                    <font class="smallfont"><p>The autoinventory magic (having a plugin automatically recognize that it's applicable for a server) is in these two tags:</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">&lt;property name="PROC_QUERY" value="State.Name.eq=sendmail"/&gt;
  &lt;plugin type="autoinventory" class="org.hyperic.hq.product.DaemonDetector"/&gt;</pre>
		</div>
</div></div>

<p>It appears that the DaemonDetector (a java class shipped with the hq-agent) will look automatically for the PROC_QUERY property, and run the query.  The query is in sigar syntax, and is the equivalent of running "ps State.Name.eq=sendmail" from the sigar console.  If the query returns one or more rows, DaemonDetector considers it to be true.</p>

<p>You can learn all about the sigar query language over here.</p>

<p><a href="http://support.hyperic.com/display/SIGAR/PTQL">http://support.hyperic.com/display/SIGAR/PTQL</a></p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by timcharper at Jan 13, 2009 15:15
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-77465015"></a>
                                    <font class="smallfont"><p>I actually found you can invoke a service within a server by using the -t command.  If you want to run the metrics for the service (and assuming the plugin example is saved as /opt/hq-plugins/sendmail-plugin.xml, the hyperic agent is installed to /opt/hyperic-agent/, and you're using the bundled jre):</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">cd /opt/hyperic-agent &amp;&amp; jre/bin/java -jar bundles/agent-4.0.2-939/pdk/lib/hq-product.jar -p sendmail -t "SendMail"</pre>
		</div>
</div></div>

<p>To run the metrics for one of SendMail's services, you concatenate the server name and service name, separated by a space:</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">cd /opt/hyperic-agent &amp;&amp; jre/bin/java -jar bundles/agent-4.0.2-939/pdk/lib/hq-product.jar -p sendmail -t "SendMail SendMail Message Submission Process"</pre>
		</div>
</div></div>

<p>The service name "SendMail Message Submission Process" should probably be "Message Submission Process" to remove the redundancy, but that's how the example provides the name.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by timcharper at Jan 13, 2009 15:21
                                    </div>
                                </td>
                            </tr>
                                                    </table>
                    			    </td>
		    </tr>
	    </table>
	    <table border="0" cellpadding="0" cellspacing="0" width="100%">
			<tr>
				<td height="12" background="http://support.hyperic.com/images/border/border_bottom.gif"><img src="images/border/spacer.gif" width="1" height="1" border="0"/></td>
			</tr>
		    <tr>
			    <td align="center"><font color="grey">Document generated by Confluence on Jun 28, 2011 15:26</font></td>
		    </tr>
	    </table>
    </body>
</html>
