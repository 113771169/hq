<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <b><a href="vFabric Hyperic 4.6.html" title="vFabric Hyperic 4.6 Documentation Home">vFabric Hyperic 4.6 Documentation Home (Internal)</a> - <a href="https://www.vmware.com/support/pubs/vfabric-hyperic.html">vFabric Hyperic 4.6 Documentation Home (Online)</a> -  <a href="https://www.vmware.com/support/vfabric-hyperic/doc/vfabric-hyperic-rn-4.6.0.html">Hyperic 4.6 Release Notes</a> </b>
<p>      
<p>
        <title>vFabric Hyperic 4.6 : Script Plugin</title>
	    <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">	    
    </head>

    <body>
	    <table class="pagecontent" border="0" cellpadding="0" cellspacing="0" width="100%" bgcolor="#ffffff">
		    <tr>
			    <td valign="top" class="pagebody">
				    <div class="pageheader">
					    <span class="pagetitle">
                            vFabric Hyperic 4.6 : Script Plugin
                                                    </span>
				    </div>
				    <div class="pagesubheading">
					    This page last changed on Jun 29, 2011 by <font color="#0050B2">mmcgarry</font>.
				    </div>

				    <h1><a name="ScriptPlugin-ScriptPlugin"></a>Script Plugin</h1>

<p>The Hyperic Agent can run script-based plugins. You create monitoring logic in a script, configure a platform service as a proxy resource under which script results are reported.</p>


<h2><a name="ScriptPlugin-ScriptPluginMetrics"></a>Script Plugin Metrics</h2>


<p>Each instance of a <b>Script</b> service provides the following metrics:</p>
<ul>
	<li><b>Availability</b> &#8212; Uses process exit code:
	<ul>
		<li>0 == <span class="image-wrap" style=""><img src="attachments/77464162/77660744.gif" style="border: 0px solid black"/></span> OK</li>
		<li>1 == <span class="image-wrap" style=""><img src="attachments/77464162/77660747.gif" style="border: 0px solid black"/></span> Warning</li>
		<li>2 == <span class="image-wrap" style=""><img src="attachments/77464162/77660751.gif" style="border: 0px solid black"/></span> Critical</li>
		<li>3 == <span class="image-wrap" style=""><img src="attachments/77464162/77660746.gif" style="border: 0px solid black"/></span> Unknown</li>
		<li>4 == <span class="image-wrap" style=""><img src="attachments/77464162/77660745.gif" style="border: 0px solid black"/></span> Paused</li>
	</ul>
	</li>
</ul>


<ul>
	<li><b>Execution Time</b> &#8212; Milliseconds it took to execute the script</li>
</ul>


<ul>
	<li><b>Result Value</b> &#8212; If the script returns results, the first number in the output stream, for example:<br/>
<tt>"Number of Transactions: 234"</tt></li>
</ul>


<h1><a name="ScriptPlugin-ConfigureaScriptService%26nbsp%3B"></a>Configure a Script Service&nbsp;</h1>

<p>To create script service.</p>

<ol>
	<li>Navigate to the platform where the script runs.</li>
	<li>Select <b>New Platform Service</b> from the <b>Tools</b> menu.&nbsp;</li>
	<li>Name the script.</li>
	<li>Select "Script" from the <b>Service Type</b> pull-down.</li>
	<li>Click <b>Edit</b> in the "Configuration Properties" section of the new service's Inventory page. &nbsp;</li>
	<li>On the&nbsp;<b>Configuration Properties</b> page, supply at least the required properties, described in the table below.</li>
</ol>


<div class='table-wrap'>
<table class='confluenceTable'><tbody>
<tr>
<th class='confluenceTh'> Name </th>
<th class='confluenceTh'> Description </th>
<th class='confluenceTh'> Required </th>
<th class='confluenceTh'> Example </th>
<th class='confluenceTh'> Notes </th>
</tr>
<tr>
<td class='confluenceTd'> prefix </td>
<td class='confluenceTd'> Space delimited prefix argument(s) </td>
<td class='confluenceTd'> No </td>
<td class='confluenceTd'> sudo </td>
</tr>
<tr>
<td class='confluenceTd'> path </td>
<td class='confluenceTd'> Path to the script or program </td>
<td class='confluenceTd'> Yes </td>
<td class='confluenceTd'> /usr/local/nagios/libexec/check_http </td>
<td class='confluenceTd'> HQ will check that the path exists </td>
</tr>
<tr>
<td class='confluenceTd'> arguments </td>
<td class='confluenceTd'> Space delimited script arguments </td>
<td class='confluenceTd'> No </td>
<td class='confluenceTd'> &#45;H 209.237.227.36 </td>
<td class='confluenceTd'> Use quotes for arguments with spaces </td>
</tr>
<tr>
<td class='confluenceTd'> timeout </td>
<td class='confluenceTd'> Timeout in seconds </td>
<td class='confluenceTd'> Yes </td>
<td class='confluenceTd'> 120 </td>
<td class='confluenceTd'> Execution is aborted if &gt; timeout </td>
</tr>
</tbody></table>
</div>

<p>Another option is to click the "New Server" link and choose <b>Nagios</b> from the drop-down.  You can optionally import an existing nagios configuration file by checking the <b>Auto-Discover Plugins</b> check box or create them by clicking the "New Service" link and selecting <b>Nagios Plugin</b> from the drop-down.  The <b>Nagios Plugin</b> service type has the same functionality as the platform <b>Script</b> service.  Note that HQ has several built-in services for network protocols that do not require any Nagios plugins to use. See <a href="Network Platform Services.html" title="Network Platform Services">Network Platform Services</a>.</p>

<p><font color="#000000"><b>Script-Based Plugins</b></font></p>

<p>While the <b>Script</b> service can be useful, the metrics are very limited. The Script concept can be expanded to include any number of metrics by implementing an XML plugin.</p>

<p>A script plugin includes an XML descriptor and at least one script, which can be defined externally or embedded in the XML file. The plugin can use multiple scripts or a single script; the script must output <em>key=value</em> pairs. These pairs are parsed by the script executor and are collected as metrics using the keys within the metric templates. The scripts can be written in any language. You can even use Nagios plugins out of the box.</p>

<p>For information about XML descriptors, see <a href="Plugin Descriptors.html" title="Plugin Descriptors">Plugin Descriptors</a>.</p>

<p>As an example, we will create an I/O Device service which uses an iostate script wrapper to format the data.  Most Linux admins are familar with the <b>iostat</b> command which reports CPU and I/O stats for devices and partitions:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">% iostat -d -x
Linux 2.6.9-22.EL (hammer)      06/23/2006

Device:    rrqm/s wrqm/s   r/s   w/s   rsec/s   wsec/s avgrq-sz avgqu-sz   await  svctm  %util
hdc          0.00   0.00  0.00  0.00     0.00     0.00    96.94     0.00  129.82 113.47   0.00
sda          0.02   0.59  0.07  0.54     2.00     9.06    17.95     0.00    4.21   1.75   0.11</pre>
		</div>
</div></div>
<p>Each device (<em>hdc</em>, <em>sda</em>) will be an instance of the <em>I/O Device</em> service, so we want the wrapper script to only collect metrics for a given device:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">% iostat -d -x sda

Linux 2.6.9-22.EL (hammer)      06/23/2006

Device:    rrqm/s wrqm/s   r/s   w/s   rsec/s   wsec/s avgrq-sz avgqu-sz   await  svctm  %util
sda          0.02   0.59  0.07  0.54     2.00     9.06    17.95     0.00    4.21   1.75   0.11</pre>
		</div>
</div></div>
<p>The wrapper script will invoke <b>iostat</b> with the arguments given above and parse the tabular output into key value pairs like so:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">% ./pdk/scripts/device_iostat.pl sda
rrqm/s=0.02
wrqm/s=0.59
r/s=0.07
w/s=0.54
rsec/s=2.00
wsec/s=9.06
avgrq-sz=17.95
avgqu-sz=0.00
await=4.21
svctm=1.75
%util=0.11</pre>
		</div>
</div></div>
<p>The plugin defines configuration properties for the script path and the device name:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: xml; gutter: false">&lt;config&gt;
  &lt;option name="script"
          description="Collector script"
          default="pdk/scripts/device_iostat.pl"/&gt;
  &lt;option name="device"
          description="Device name"
          default="sda"/&gt;
&lt;/config&gt;</pre>
		</div>
</div></div>
<p>The properties are then applied to a filter template:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: xml; gutter: false">&lt;filter name="template"
        value="exec:file=%script%,args=%device%"/&gt;</pre>
		</div>
</div></div>
<p>Where <b>exec</b> will route collection of the metric to the script executor plugin and the properties will be expanded to:</p>

<p><em>exec:file=pdk/scripts/device_iostat.pl,args=sda</em>.</p>

<p>The filter is then used in each <b>metric</b> <b>template</b> with the key it is to collect:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: xml; gutter: false">&lt;metric name="Write Requests per Second"
        category="PERFORMANCE"
        indicator="true"
        template="${template}:w/s"/&gt;</pre>
		</div>
</div></div>
<p>Which is expanded to:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">template="exec:file=pdk/scripts/device_iostat.pl,args=sda:w/s"</pre>
		</div>
</div></div>
<p><a name="ScriptPlugin-iodevicetest"></a></p>

<h4><a name="ScriptPlugin-CommandLineTest"></a>Command Line Test</h4>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">% java -jar pdk/lib/hq-pdk.jar -Dplugins.include=io-device -Ddevice=sda -t "I/O Device"

I/O Device Availability:
   I/O Device:exec:file=pdk/scripts/device_iostat.pl,args=sda:Availability
   =&gt;100.0%&lt;=

I/O Device Read Requests Merged per Second:
   I/O Device:exec:file=pdk/scripts/device_iostat.pl,args=sda:rrqm/s
   =&gt;0.0&lt;=

I/O Device Write Requests Merged per Second:
   I/O Device:exec:file=pdk/scripts/device_iostat.pl,args=sda:wrqm/s
   =&gt;0.6&lt;=

I/O Device Read Requests per Second:
   I/O Device:exec:file=pdk/scripts/device_iostat.pl,args=sda:r/s
   =&gt;0.1&lt;=

I/O Device Write Requests per Second:
   I/O Device:exec:file=pdk/scripts/device_iostat.pl,args=sda:w/s
   =&gt;0.6&lt;=

I/O Device Sectors Read per Second:
   I/O Device:exec:file=pdk/scripts/device_iostat.pl,args=sda:rsec/s
   =&gt;2.0&lt;=

I/O Device Sectors Writen per Second:
   I/O Device:exec:file=pdk/scripts/device_iostat.pl,args=sda:wsec/s
   =&gt;9.1&lt;=

I/O Device Average Sector Request Size:
   I/O Device:exec:file=pdk/scripts/device_iostat.pl,args=sda:avgrq-sz
   =&gt;18.0&lt;=

I/O Device Average Queue Length:
   I/O Device:exec:file=pdk/scripts/device_iostat.pl,args=sda:avgqu-sz
   =&gt;0.0&lt;=

I/O Device Average Wait Time:
   I/O Device:exec:file=pdk/scripts/device_iostat.pl,args=sda:await
   =&gt;0.004s&lt;=

I/O Device Average Service Time:
   I/O Device:exec:file=pdk/scripts/device_iostat.pl,args=sda:svctm
   =&gt;0.001s&lt;=

I/O Device CPU Usage:
   I/O Device:exec:file=pdk/scripts/device_iostat.pl,args=sda:%util
   =&gt;0.1%&lt;=</pre>
		</div>
</div></div>
<p><a name="ScriptPlugin-iodeviceservice"></a></p>

<h4><a name="ScriptPlugin-CreateanIODeviceservice"></a>Create an IO Device service</h4>

<p>After you have deployed the iodevice plugin, instances of the service must be created manually.  Using the HQ GUI:</p>
<ul>
	<li>Navigate to the platform view of choice and click the "New Platform Service" link</li>
	<li>Enter a <b>Name</b> of your choice</li>
	<li>Select <b>I/O Device</b> from the drop-down list</li>
	<li>Click the <b>OK</b> button</li>
	<li>From the Inventory tab, click the <b>Edit</b> button</li>
	<li>Change any properties if needed</li>
	<li>Click the <b>OK</b> button</li>
</ul>


<p>Your service and now configured and metric data will be viewable from the <b>Monitor</b> tab.</p>

<h3><a name="ScriptPlugin-HowOftenScriptsareExecuted"></a>How Often Scripts are Executed</h3>

<p>The script collector caches the results to avoid executing the script for each individual metric.  The cache key is properties of the metric template.</p>

<p>In the iostat example, where the template is:</p>
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>exec:file=pdk/scripts/device_iostat.pl,args=sda:Availability



</pre>
</div></div>
<p>The properties/cache-key would be:</p>
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>file=pdk/scripts/device_iostat.pl,args=sda



</pre>
</div></div>
<p>If you wanted the script to collect data for all resources in a single round, you could just change the template like so:</p>
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>exec:file=pdk/scripts/device_iostat.pl:sda_Availability



</pre>
</div></div>
<p>Which makes the properties/cache-key the same for all resources:</p>
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>file=pdk/scripts/device_iostat.pl



</pre>
</div></div>
<p>The io-device-plugin.xml would change to:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: xml; gutter: false">&lt;filter name="template"
             value="exec:file=%script%:%device%"/&gt;

     &lt;metric name="Availability"
             template="${template}:Availability"
             indicator="true"/&gt;</pre>
		</div>
</div></div>
<p>And <b>device_iostat.pl</b> would just format the output keys with device name in the key:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">print "${device}_$labels[$i]=$values[$i]\n";</pre>
		</div>
</div></div>
<p>The lifetime of the cache is defined by the metric intervals, whose defaults are defined by the plugin and can be changed later per-resource or globally per-type in the UI.  So, if your metric intervals were configured to collect every 5 minutes, the script would only be run once every 5 minutes regardless of how many resources the script output applies to.</p>

				    					    <br/>
                        <div class="tabletitle">
                            <a name="attachments">
                                <h2>Attachments:</h2>
                            </a>
                        </div>

                        <div class="greybox" align="left">
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/77464162/77660747.gif">icon_available_yellow.gif</a> (image/gif)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/77464162/77660746.gif">icon_available_error.gif</a> (image/gif)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/77464162/77660745.gif">icon_available_orange.gif</a> (image/gif)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/77464162/77660744.gif">icon_available_green.gif</a> (image/gif)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/77464162/77660751.gif">icon_available_red.gif</a> (image/gif)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/77464162/77660750.vbs">windows_updates.vbs</a> (application/octet-stream)
                                <br/>
                                                    </div>
				    
                    			    </td>
		    </tr>
	    </table>
	    <table border="0" cellpadding="0" cellspacing="0" width="100%">
			<tr>
				<td height="12" background="http://support.hyperic.com/images/border/border_bottom.gif"><img src="images/border/spacer.gif" width="1" height="1" border="0"/></td>
			</tr>
		    <tr>
			    <td align="center"><font color="grey">Document generated by Confluence on Jul 29, 2011 14:44</font></td>
		    </tr>
	    </table>
    </body>
</html>
