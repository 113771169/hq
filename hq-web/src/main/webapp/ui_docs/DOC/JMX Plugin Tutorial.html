<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
    <head>
        <title>Hyperic 4.6 Documentation : JMX Plugin Tutorial</title>
	    <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">	    
    </head>

    <body>
	    <table class="pagecontent" border="0" cellpadding="0" cellspacing="0" width="100%" bgcolor="#ffffff">
		    <tr>
			    <td valign="top" class="pagebody">
				    <div class="pageheader">
					    <span class="pagetitle">
                            Hyperic 4.6 Documentation : JMX Plugin Tutorial
                                                    </span>
				    </div>
				    <div class="pagesubheading">
					    This page last changed on May 19, 2011 by <font color="#0050B2">mmcgarry</font>.
				    </div>

				    <style type='text/css'>/*<![CDATA[*/
div.rbtoc1305830861825 {margin-left: 1.5em;padding: 0px;}
div.rbtoc1305830861825 ul {list-style: disc;margin-left: 0px;padding-left: 20px;}
div.rbtoc1305830861825 li {margin-left: 0px;padding-left: 0px;}

/*]]>*/</style><div class='rbtoc1305830861825'>
<ul>
    <li><a href='#JMXPluginTutorial-JMXMeasurementPlugin'>JMX Measurement Plugin</a></li>
    <li><a href='#JMXPluginTutorial-DevelopSampleJMXPlugin'>Develop Sample JMX Plugin</a></li>
<ul>
    <li><a href='#JMXPluginTutorial-Step1UnderstandhowthePluginFitsintoInventoryModel'>Step 1 - Understand how the Plugin Fits into Inventory Model</a></li>
    <li><a href='#JMXPluginTutorial-Step2ConfiguretheJMXEnabledApplicationforRemoteConnection'>Step 2 - Configure the JMX-Enabled Application for Remote Connection</a></li>
    <li><a href='#JMXPluginTutorial-Step3DetermineWhichMetricstoCollectinthePlugin'>Step 3 - Determine Which Metrics to Collect in the Plugin</a></li>
    <li><a href='#JMXPluginTutorial-Step4ReviewtheSampleJMXMeasurementPluginDescriptor'>Step 4 - Review the Sample JMX Measurement Plugin Descriptor</a></li>
    <li><a href='#JMXPluginTutorial-Step5WhatPluginWillShowintheHQUI'>Step 5 - What Plugin Will Show in the HQ UI</a></li>
    <li><a href='#JMXPluginTutorial-Step6UnderstandandModifyEachPieceoftheSamplePluginXMLDescriptor'>Step 6 - Understand and Modify Each Piece of the Sample Plugin XML Descriptor</a></li>
<ul>
    <li><a href='#JMXPluginTutorial-IncludeStandardProcessMetrics'>Include Standard Process Metrics</a></li>
    <li><a href='#JMXPluginTutorial-IncludeJMXLibraries'>Include JMX Libraries</a></li>
    <li><a href='#JMXPluginTutorial-DefineMetrics'>Define Metrics</a></li>
    <li><a href='#JMXPluginTutorial-SpecifyServerResource'>Specify Server Resource</a></li>
    <li><a href='#JMXPluginTutorial-TellthePluginAboutServicestheServerHosts'>Tell the Plugin About Services the Server Hosts</a></li>
    <li><a href='#JMXPluginTutorial-EnablethePlugintoConnecttotheMBeanServer'>Enable the Plugin to Connect to the MBean Server</a></li>
    <li><a href='#JMXPluginTutorial-IdentifytheProcessesYouWanttoCollectMetricsFrom'>Identify the Processes You Want to Collect Metrics From</a></li>
    <li><a href='#JMXPluginTutorial-GatherMetrics'>Gather Metrics</a></li>
    <li><a href='#JMXPluginTutorial-AutoDiscovertheServer'>Auto-Discover the Server</a></li>
    <li><a href='#JMXPluginTutorial-IdentifyandGatherMetricsfromtheServer%27sHostedServices'>Identify and Gather Metrics from the Server's Hosted Services</a></li>
    <li><a href='#JMXPluginTutorial-ProvideConfigurationInstructions'>Provide Configuration Instructions</a></li>
</ul>
    <li><a href='#JMXPluginTutorial-Step7TestthePlugin.'>Step 7 - Test the Plugin.</a></li>
    <li><a href='#JMXPluginTutorial-Step8DeploythePlugin.'>Step 8 - Deploy the Plugin.</a></li>
</ul>
</ul></div>


<h1><a name="JMXPluginTutorial-JMXMeasurementPlugin"></a>JMX Measurement Plugin</h1>

<p>This tutorial will lead you through writing, testing, and deploying a simple JMX measurement plugin that auto-discovers and collects several metrics from Sun JVM. We hope that you will be able to extrapolate from this simple example to your own needs for discovering and monitoring a remote JMX-enabled application.</p>

<p>JMX plugins target remote JMX-enabled applications. They extract metrics from the Java services via MBeans. One of the main tasks of writing a JMX plugin is determining which metrics to monitor via those MBeans. JMX plugins are templatized and so you will not need to write any Java code. All you need to do is write an XML descriptor.</p>

<p>Learn more about <a href="JMX Plugin.html" title="JMX Plugin">JMX plugins</a> and <a href="Measurement Plugin.html" title="Measurement Plugin">measurement plugins</a>.</p>

<p>See the <a href="Plugins Tutorial.html" title="Plugins Tutorial">Plugins Tutorial</a> overview for general plugin information.</p>

<h1><a name="JMXPluginTutorial-DevelopSampleJMXPlugin"></a>Develop Sample JMX Plugin</h1>

<h2><a name="JMXPluginTutorial-Step1UnderstandhowthePluginFitsintoInventoryModel"></a>Step 1 - Understand how the Plugin Fits into Inventory Model</h2>

<p>This plugin fits into the HQ inventory model by starting at the (Sun JVM) server level and organizing services (in this case, only one: Garbage Collector) under it. Other plugins targeting only a service could bypass the server and be organized directly under the platform on which it is run.</p>

<h2><a name="JMXPluginTutorial-Step2ConfiguretheJMXEnabledApplicationforRemoteConnection"></a>Step 2 - Configure the JMX-Enabled Application for Remote Connection</h2>

<p>In order to manage a JMX-enabled application from HQ, it must be configured to accept remote connections. Many such applications have the remote connector enabled by default; those which do not often require changing a line or two of their configuration.</p>

<p>Learn more about <a href="JMX Plugin.html#JMXPlugin-remote">configuring for remote connection</a>.</p>

<h2><a name="JMXPluginTutorial-Step3DetermineWhichMetricstoCollectinthePlugin"></a>Step 3 - Determine Which Metrics to Collect in the Plugin</h2>

<p>You can find appropriate metrics to collect from MBeans in several ways:</p>
<ul>
	<li><a href="http://java.sun.com/j2se/1.5.0/docs/guide/management/jconsole.html">JConsole</a></li>
	<li><a href="http://mc4j.org/">MC4J</a></li>
	<li><a href="JMX Plugin.html#JMXPlugin-tools">Command line tool</a> provided by HQ JMX support classes. It dumps MBeans in text format.</li>
</ul>


<p><b>To find metrics using JConsole:</b></p>
<ol>
	<li>Run JConsole.<br/>
JConsole will discover all Java processes on a host that has JMX enabled and will enumerate all the available MBeans.</li>
	<li>Find the MBean attribute of interest and its value.<br/>
A numeric value indicates that the attribute is capable of being returned as a metric. This includes two statistic types:
	<ul>
		<li>javax.management.j2ee.statistics.CountStatistic (gets the count)</li>
		<li>javax.management.j2ee.statistics.RangeStatistic (gets the current value)<br/>
A non-numeric value indicates that the attribute is not appropriate for collection by the plugin.</li>
	</ul>
	</li>
	<li>Record the MBean name, for use in the XML descriptor.</li>
</ol>


<h2><a name="JMXPluginTutorial-Step4ReviewtheSampleJMXMeasurementPluginDescriptor"></a>Step 4 - Review the Sample JMX Measurement Plugin Descriptor</h2>

<p>The sample JMX plugin XML descriptor below collects several metrics and auto-discovers a Sun JVM server and a single component service. The sample provides the structure of the plugin, and you should start with it when writing your own plugin. You will need to change certain values &#8212; which we'll point out &#8212; within the descriptor. That's it. All you need for a JMX measurement plugin is an XML descriptor.</p>
<div class="code panel" style="border-width: 1px;"><div class="codeHeader panelHeader" style="border-bottom-width: 1px;"><b>JMX Measurement Plugin</b></div><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: xml; gutter: false">&lt;?xml version="1.0"?&gt;

&lt;!DOCTYPE plugin [&lt;!ENTITY process-metrics SYSTEM "/pdk/plugins/process-metrics.xml"&gt;]&gt;

&lt;plugin package="org.hyperic.hq.plugin.java"&gt;

&lt;classpath&gt;
&lt;include name="pdk/lib/mx4j"/&gt;
&lt;/classpath&gt;

&lt;filter name="template" value="${OBJECT_NAME}:${alias}"/&gt;

&lt;metrics name="Class Loading Metrics"&gt;
&lt;metric name="Loaded Class Count" indicator="false" category="THROUGHPUT"/&gt;
&lt;metric name="Total Loaded Class Count" indicator="false" category="THROUGHPUT"/&gt;
&lt;metric name="Unloaded Class Count" indicator="false" category="THROUGHPUT"/&gt;
&lt;/metrics&gt;

&lt;metrics name="Compilation"&gt;
&lt;metric name="Total Compilation Time" indicator="false" category="THROUGHPUT" collectionType="trendsup" units="ms"/&gt;
&lt;/metrics&gt;

&lt;metrics name="Garbage Collector"&gt;
&lt;metric name="Collection Count" indicator="false" category="THROUGHPUT" collectionType="trendsup"/&gt;
&lt;metric name="Collection Time" indicator="false" category="THROUGHPUT" collectionType="trendsup"/&gt;
&lt;/metrics&gt;

&lt;metrics name="Memory"&gt;
&lt;metric name="Object Pending Finalization Count" category="THROUGHPUT" indicator="false"/&gt;
&lt;/metrics&gt;

&lt;metrics name="Threading"&gt;
&lt;metric name="Thread Count" category="UTILIZATION" indicator="false"/&gt;
&lt;metric name="Daemon Thread Count" category="UTILIZATION" indicator="false"/&gt;
&lt;/metrics&gt;

&lt;server name="Java" version="1.5.x"&gt;
&lt;property name="HAS_BUILTIN_SERVICES" value="true"/&gt;
&lt;property name="VERSION_FILE" value="jre/lib/fontconfig.Sun.2003.bfc"/&gt;
&lt;property name="DEFAULT_PROGRAM" value="bin/java"/&gt;
&lt;property name="domain" value="Java"/&gt;

&lt;config&gt;
&lt;option name="jmx.url" description="JMX URL to MBeanServer"  default="service:jmx:rmi:///jndi/rmi://localhost:6969/jmxrmi"/&gt;
&lt;option name="jmx.username" description="JMX username" optional="true" default=""/&gt;
&lt;option name="jmx.password" description="JMX password" optional="true" default="" type="secret"/&gt;
&lt;option name="process.query" description="PTQL for Java Process" default="State.Name.eq=java,Args.*.ct=proc.java.home"/&gt;
&lt;/config&gt;

&lt;metric name="Availability" template="sigar:Type=ProcState,Arg=%process.query%:State" indicator="true"/&gt;
&amp;process-metrics;

&lt;property name="OBJECT_NAME" value="java.lang:type=ClassLoading"/&gt;

&lt;metrics include="Class Loading Metrics"/&gt;
&lt;property name="OBJECT_NAME" value="java.lang:type=Compilation"/&gt;

&lt;metrics include="Compilation"/&gt;
&lt;property name="OBJECT_NAME" value="java.lang:type=Memory"/&gt;

&lt;plugin type="log_track" class="org.hyperic.hq.product.jmx.MxNotificationPlugin"/&gt;

&lt;property name="OBJECT_NAME" value="java.lang:type=Threading"/&gt;
&lt;metrics include="Threading"/&gt;

&lt;!-- derive installpath from JAVA_HOME env prop... --&gt;
&lt;property name="PROC_HOME_ENV" value="JAVA_HOME"/&gt;

&lt;!-- derive installpath from -Dproc.java.home=... --&gt;
&lt;property name="PROC_HOME_PROPERTY" value="proc.java.home"/&gt;
&lt;plugin type="autoinventory" class="org.hyperic.hq.product.jmx.MxServerDetector"/&gt;
&lt;plugin type="measurement" class="org.hyperic.hq.product.jmx.MxMeasurementPlugin"/&gt;

&lt;service name="Java GC"&gt;
&lt;plugin type="autoinventory"/&gt;
&lt;property name="OBJECT_NAME" value="java.lang:type=GarbageCollector,name=*"/&gt;
&lt;metrics include="Garbage Collector"/&gt;
&lt;/service&gt;
&lt;/server&gt;

&lt;server name="Java" version="1.6.x" include="1.5.x"&gt;
&lt;property name="VERSION_FILE" value="jre/lib/management-agent.jar"/&gt;
&lt;/server&gt;

&lt;!--
 ==================== Plugin Help ===========================
--&gt;
&lt;help name="Java"&gt;
&lt;![CDATA[
  &lt;p&gt;
  &lt;h3&gt;Configure HQ for monitoring Java&lt;/h3&gt;
  &lt;/p&gt;
  &lt;p&gt;
  1) Add this line to the java options when executing the binary.
  &lt;br&gt;
  "-Dcom.sun.management.jmxremote \
  &lt;br&gt;
  -Dcom.sun.management.jmxremote.port=6969 \
  &lt;br&gt;
  -Dcom.sun.management.jmxremote.ssl=false \
  &lt;br&gt;
  -Dcom.sun.management.jmxremote.authenticate=false"
  &lt;br&gt;
  &lt;/p&gt;
]]&gt;
&lt;/help&gt;
&lt;help name="Java 1.5.x" include="Java"/&gt;
&lt;help name="Java 1.6.x" include="Java"/&gt;
&lt;/plugin&gt;</pre>
		</div>
</div></div>
<p><a name="JMXPluginTutorial-output"></a></p>

<h2><a name="JMXPluginTutorial-Step5WhatPluginWillShowintheHQUI"></a>Step 5 - What Plugin Will Show in the HQ UI</h2>

<p>After this plugin is successfully run by an Agent, the HQ UI will show:</p>
<ul>
	<li>The existence of the JMX-enabled application (Sun JVM server) and its one hosted service: Java GC (Garbage Collector)</li>
	<li>For that server, these metrics:
	<ul>
		<li>Availability of the server</li>
		<li>Loaded Class Count</li>
		<li>Total Loaded Class Count</li>
		<li>Unloaded Class Count</li>
		<li>Total Compilation Time</li>
		<li>Object Pending Finalization Count</li>
		<li>Thread Count</li>
		<li>Daemon Thread Count</li>
	</ul>
	</li>
	<li>For that server, log-tracking data for the Threading MBean (displayed on the "<a href="ui-Monitor.CurrentHealth.html#ui-Monitor.CurrentHealth-EventsLogsTrack">Current Health</a>" screen)</li>
	<li>For the service, these metrics:
	<ul>
		<li>Collection Count</li>
		<li>Collection Time</li>
	</ul>
	</li>
	<li>Configuration instructions for the JMX-enabled server, on the server's "<a href="ui-Inventory.Configuration.html" title="ui-Inventory.Configuration">Resource Configuration</a>" screen</li>
</ul>


<p>Learn more about <a href="http://support.hyperic.com/display/EVO/Monitoring+Overview" title="Monitoring Overview">viewing resources and metrics in HQ</a>.</p>


<h2><a name="JMXPluginTutorial-Step6UnderstandandModifyEachPieceoftheSamplePluginXMLDescriptor"></a>Step 6 - Understand and Modify Each Piece of the Sample Plugin XML Descriptor</h2>

<p>The sample XML descriptor above is divided into parts, each of which is repeated and explained for your particular use below. Some of the more important parts of the XML descriptor are called out.</p>

<p>For details on each element and attribute you can use in a descriptor, see <a href="Plugin Descriptors.html" title="Plugin Descriptors">Plugin Descriptors</a>.</p>

<div class='panelMacro'><table class='infoMacro'><colgroup><col width='24'><col></colgroup><tr><td valign='top'><img src="images/icons/emoticons/information.gif" width="16" height="16" align="absmiddle" alt="" border="0"></td><td><b>Order Matters</b><br />If a part of the XML descriptor references or includes another part of the XML Descriptor, the <em>referenced</em> part must come before the part doing the referencing. This can be seen in this tutorial with the inclusion of metrics parameters, for example.</td></tr></table></div>

<h3><a name="JMXPluginTutorial-IncludeStandardProcessMetrics"></a>Include Standard Process Metrics</h3>

<p>This code retrieves the standard process metrics for the process obtained by a later process query.</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: xml; gutter: false">&lt;!DOCTYPE plugin [&lt;!ENTITY process-metrics SYSTEM "/pdk/plugins/process-metrics.xml"&gt;]&gt;</pre>
		</div>
</div></div>

<p>It is a very simple way to retrieve such useful metrics as StartTime, Memory Utilization, and CPU System Time. Keep it as-is.</p>

<p>This code works when a <em>single</em> process is retrieved by the query; if the query retrieves multiple processes, then simply add <tt>multi&#45;</tt> just in front of the two occurrences of <tt>process-metrics</tt> here, and there will be an equivalent change in the later line:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: xml; gutter: false">&lt;!DOCTYPE plugin [&lt;!ENTITY multi-process-metrics SYSTEM "/pdk/plugins/multi-process-metrics.xml"&gt;]&gt;
# This code provides the path for the Java package.
{code:xml}
&lt;plugin package="org.hyperic.hq.plugin.java"&gt;</pre>
		</div>
</div></div>
<p>Replace it with the path in your environment.</p>

<h3><a name="JMXPluginTutorial-IncludeJMXLibraries"></a>Include JMX Libraries</h3>

<p>This code enables JMX classes for which HQ has already set up libraries.</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: xml; gutter: false">&lt;classpath&gt;
&lt;include name="pdk/lib/mx4j"/&gt;
&lt;/classpath&gt;</pre>
		</div>
</div></div>
<p>Keep it as-is.</p>

<h3><a name="JMXPluginTutorial-DefineMetrics"></a>Define Metrics</h3>
<p>This code assigns a <tt>template</tt> value to each of the metrics defined just after it.</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: xml; gutter: false">&lt;filter name="template" value="${OBJECT_NAME}:${alias}"/&gt;</pre>
		</div>
</div></div>

<p>In this case, the filter applies the template to all the following metrics. </p>

<p>In this case, the Loaded Class Count, Total Loaded Class Count, Unloaded Class Count, Total Compilation Time, Collection Count, Collection Time, Object Pending Finalization Count, Thread Count, and Daemon Thread Count metrics all have a template, with the value specified, applied to it, without having to repeat the template parameter for each metric. Keep it as-is.</p>

<p>This code collects in one place, for readability, all the metrics that will be gathered, later, from MBeans.</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: xml; gutter: false">&lt;metrics name="Class Loading Metrics"&gt;
&lt;metric name="Loaded Class Count" indicator="false" category="THROUGHPUT"/&gt;
&lt;metric name="Total Loaded Class Count" indicator="false" category="THROUGHPUT"/&gt;
&lt;metric name="Unloaded Class Count" indicator="false" category="THROUGHPUT"/&gt;
&lt;/metrics&gt;

&lt;metrics name="Compilation"&gt;
&lt;metric name="Total Compilation Time" indicator="false" category="THROUGHPUT" collectionType="trendsup" units="ms"/&gt;
&lt;/metrics&gt;

&lt;metrics name="Garbage Collector"&gt;
&lt;metric name="Collection Count" indicator="false" category="THROUGHPUT" collectionType="trendsup"/&gt;
&lt;metric name="Collection Time" indicator="false" category="THROUGHPUT" collectionType="trendsup"/&gt;
&lt;/metrics&gt;

&lt;metrics name="Memory"&gt;
&lt;metric name="Object Pending Finalization Count" category="THROUGHPUT" indicator="false"/&gt;
&lt;/metrics&gt;

&lt;metrics name="Threading"&gt;
&lt;metric name="Thread Count" category="UTILIZATION" indicator="false"/&gt;
&lt;metric name="Daemon Thread Count" category="UTILIZATION" indicator="false"/&gt;
&lt;/metrics&gt;</pre>
		</div>
</div></div>

<p>The Garbage Collector metrics are handled separately from the other metrics. Replace these metrics with the metrics you want to collect. However you name the group of metrics here (Memory, Compilation, etc.), that's the name you will explicitly "include" later.</p>

<p>For each metric you collect, you can must specify at least the following attributes:</p>
<div class='table-wrap'>
<table class='confluenceTable'><tbody>
<tr>
<th class='confluenceTh'> Metric Attribute </th>
<th class='confluenceTh'> Description </th>
<th class='confluenceTh'> Req'd </th>
<th class='confluenceTh'> Possible Values </th>
</tr>
<tr>
<td class='confluenceTd'> <tt>name</tt> </td>
<td class='confluenceTd'> Name of the metric to be displayed in the GUI </td>
<td class='confluenceTd'> Y </td>
<td class='confluenceTd'>&nbsp;</td>
</tr>
<tr>
<td class='confluenceTd'> <tt>indicator</tt> </td>
<td class='confluenceTd'> Whether or not this metric should be treated as an <a href="http://support.hyperic.com/display/EVO/Hyperic+Glossary#HypericGlossary-indicatormetric">indicator metric</a> in HQ </td>
<td class='confluenceTd'> Y </td>
<td class='confluenceTd'> true, false </td>
</tr>
<tr>
<td class='confluenceTd'> <tt>template</tt> </td>
<td class='confluenceTd'>  <a href="Measurement Plugin.html#MeasurementPlugin-template">Learn more</a>. </td>
<td class='confluenceTd'> Y </td>
<td class='confluenceTd'> <a href="Measurement Plugin.html#MeasurementPlugin-template">See examples</a> </td>
</tr>
</tbody></table>
</div>


<h3><a name="JMXPluginTutorial-SpecifyServerResource"></a>Specify Server Resource</h3>
<p>This code specifies the name and version of the process against which the plugin will be run.</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: xml; gutter: false">&lt;server name="Java" version="1.5.x"&gt;</pre>
		</div>
</div></div>
<p>These values will be displayed in the UI for the server, so while you <em>can</em> name it anything you want, we recommend naming it something meaningful.</p>

<h3><a name="JMXPluginTutorial-TellthePluginAboutServicestheServerHosts"></a>Tell the Plugin About Services the Server Hosts</h3>

<p>This code tells HQ that the server has component services, which tells the later-invoked auto-discovery function to please auto-discover the services, too.</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: xml; gutter: false">&lt;property name="HAS_BUILTIN_SERVICES" value="true"/&gt;</pre>
		</div>
</div></div>
<p>Keep it as-is if your server contains services you want to discover and manage. Otherwise, replace <tt>true</tt> with <tt>false</tt>.<br/>
This code enables the plugin to identify different versions of Java.</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: xml; gutter: false">&lt;property name="VERSION_FILE" value="jre/lib/fontconfig.Sun.2003.bfc"/&gt;</pre>
		</div>
</div></div>
<p>The file <tt>jre/lib/fontconfig.Sun.2003.bfc</tt> exists only in version 1.5, not in 1.6, and therefore enables the plugin to identify a version as 1.5, which is necessary to determine what parts of the overall plugin to run against the server. If necessary, replace this with a file that uniquely identifies the version of your server.<br/>
This code specifies the actual program name being run from the default path.</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: xml; gutter: false">&lt;property name="DEFAULT_PROGRAM" value="bin/java"/&gt;</pre>
		</div>
</div></div>
<p>If Java is being run from <tt>/usr/jdk/latest/bin/java</tt>, then <tt>/bin/java</tt> is the value you should put here.<br/>
This code uniquely identifies the plugin's domain.</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">&lt;property name="domain" value="Java"/&gt;</pre>
		</div>
</div></div>
<p>It it typically the name of the server, specified earlier, but can be anything. If desired, replaced "Java" with your unique identifier.</p>

<h3><a name="JMXPluginTutorial-EnablethePlugintoConnecttotheMBeanServer"></a>Enable the Plugin to Connect to the MBean Server</h3>
<p>This code provides the configuration properties HQ needs to connect to the MBean server.</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: xml; gutter: false">&lt;config&gt;
&lt;option name="jmx.url" description="JMX URL to MBeanServer" default="service:jmx:rmi:///jndi/rmi://localhost:6969/jmxrmi"/&gt;
&lt;option name="jmx.username" description="JMX username" optional="true" default=""/&gt;
&lt;option name="jmx.password" description="JMX password" optional="true" default="" type="secret"/&gt;</pre>
		</div>
</div></div>
<p>All the configuration options specified here are the ones that show up in the server's "<a href="ui-Inventory.Configuration.html" title="ui-Inventory.Configuration">Resource Configuration</a>" screen. The default values for each of these options can be specified here, but users can change the default values on that screen. You can leave most of the default values in this code as-is but should change the default username and password.<br/>
For a JMX plugin, this list of configuration options suffices, but you can add other options. Learn more about how to <a href="http://support.hyperic.com/display/EVO/Plugin+XML+Descriptor#PluginXMLDescriptor-option">write an option</a>. Learn more about <a href="JMX Plugin.html#JMXPlugin-loginconfig">login configuration properties</a> or <a href="JMX Plugin.html#JMXPlugin-config">configuration properties</a> in general.</p>


<h3><a name="JMXPluginTutorial-IdentifytheProcessesYouWanttoCollectMetricsFrom"></a>Identify the Processes You Want to Collect Metrics From</h3>
<p>This last of configuration options specifically identifies the exact process(es) of interest.</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">&lt;option name="process.query" description="PTQL for Java Process" default="State.Name.eq=java,Args.*.ct=proc.java.home"/&gt;
&lt;/config&gt;</pre>
		</div>
</div></div>
<p><tt>ct.=proc.java.home</tt> narrows the query to only the salient processes (those with "proc.java.home" in the names). The query is written in <a href="http://support.hyperic.com/display/SIGAR/PTQL" title="PTQL">PTQL</a>, which isn't necessary to understand for this tutorial, but would be useful to understand for future, custom plugins.<br/>
If you are interested in different processes, replace <tt>proc.java.home</tt> with another partial name that will narrow the search. The <tt>process.query</tt> value is used later on when gathering metrics.</p>

<h3><a name="JMXPluginTutorial-GatherMetrics"></a>Gather Metrics</h3>
<p>This code collects the requisite Availability metric.</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: xml; gutter: false">&lt;metric name="Availability" template="sigar:Type=ProcState,Arg=%process.query%:State" indicator="true"/&gt;</pre>
		</div>
</div></div>
<p>The variable <tt>%process.query%</tt> gets assigned the value from the above process query (which determined whether or not the Java server exists), and so then the plugin can determine whether or not the server is available. Keep it as-is.</p>

<div class='panelMacro'><table class='infoMacro'><colgroup><col width='24'><col></colgroup><tr><td valign='top'><img src="images/icons/emoticons/information.gif" width="16" height="16" align="absmiddle" alt="" border="0"></td><td><b>You Must Always Collect the Availability Metric</b><br />The Availability metric indicates whether a Resource is up or down.

<p>A metrics-gathering plugin must determine Availability for <em>every</em> server and <em>every</em> service it monitors. A single plugin will likely gather Availability for multiple Resources. If Availability is not gathered for a Resource, HQ will consider the Resource to be unavailable, and will not show any metrics for it in the Portal.</p>

<p>A plugin sets the value of Availability to 1 if the Resource is up, and 0 if it is down.&nbsp; These values are displayed in the Portal as "available" or "not available".</p>

<p>Verifying the existence of a Resource's process is a common technique for determining its Availability. However, the method a plugin uses to determine Availability can vary depending on the Resource Type and the plugin developer's judgment. There might be alternative techniques for determining the Availability of a Resource. For instance, a plugin might determine the Availability of a web server based on whether its process is up, its port is listening, it is responsive to a request, or by some combination of these conditions.&nbsp; </p>
<p>Some mBeans do not have an "Availability" attribute. Even if this is the case, you must still specify an "Availability" metric as this sample plugin does.</p></td></tr></table></div>

<p>This line completes the earlier code that retrieves the standard process metrics for the process just obtained by the above {process.query}}.</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: xml; gutter: false">&amp;process-metrics;</pre>
		</div>
</div></div>
<p>Keep it as-is.<br/>
This code works when a <em>single</em> process is retrieved by the query; if the query retrieves multiple processes, then simply add <tt>multi&#45;</tt> just in front of <tt>process-metrics</tt> here, as there was an equivalent change in the earlier code.</p>

<p>This code gathers the metric values.</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">&lt;property name="OBJECT_NAME" value="java.lang:type=ClassLoading"/&gt;
&lt;metrics include="Class Loading Metrics"/&gt;
&lt;property name="OBJECT_NAME" value="java.lang:type=Compilation"/&gt;
&lt;metrics include="Compilation"/&gt;
&lt;property name="OBJECT_NAME" value="java.lang:type=Memory"/&gt;
&lt;metrics include="Memory"/&gt;
...
&lt;property name="OBJECT_NAME" value="java.lang:type=Threading"/&gt;
&lt;metrics include="Threading"/&gt;</pre>
		</div>
</div></div>
<p>It references the <a href="#JMXPluginTutorial-metrics">previously defined metrics</a>, which are grouped earlier for easier reference. If you want to gather other metrics, you should:</p>
<ol>
	<li>Replace the <tt>java.lang:type</tt> value (for example, ClassLoading) with the associated MBean "objectName" (which you can find, for example, in JConsole).</li>
	<li><tt>Include</tt> a section that you would define <a href="#JMXPluginTutorial-metrics">earlier</a>. If you <tt>include="Foobar Metrics"</tt> here, then you would define <tt>metrics name="Foobar Metrics"</tt> earlier, with all its component metrics.<br/>
Learn more about <a href="JMX Plugin.html#JMXPlugin-metrics">defining metrics</a>, including the use of <a href="JMX Plugin.html#JMXPlugin-objectname"><tt>OBJECT_NAME</tt></a>, and about <a href="JMX Plugin.html#JMXPlugin-custom">defining properties</a>.<a name="JMXPluginTutorial-logtrack"></a></li>
</ol>


<p>This code implements log tracking of the Threading MBeans (the metrics declared just after invoking log tracking).</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: xml; gutter: false">&lt;plugin type="log_track" class="org.hyperic.hq.product.jmx.MxNotificationPlugin"/&gt;</pre>
		</div>
</div></div>
<p>Keep it as-is. Learn more about <a href="JMX Plugin.html#JMXPlugin-logtrack">log tracking in JMX plugins</a>.</p>

<p>This code provides two methods &#8212; of which you must use one &#8212; for defining the install (base) path for the process.</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: xml; gutter: false">&lt;!-- derive installpath from JAVA_HOME env prop... --&gt;
&lt;property name="PROC_HOME_ENV" value="JAVA_HOME"/&gt;
&lt;!-- derive installpath from -Dproc.java.home=... --&gt;
&lt;property name="PROC_HOME_PROPERTY" value="proc.java.home"/&gt;</pre>
		</div>
</div></div>
<p>If using the first method, replace <tt>JAVA_HOME</tt> with the environmental property of the process. If using the second method, replace <tt>proc.java.home</tt> with the defined name-value pair argument of the process; the MxServer Detector class uses this variable to perform auto-discovery.<br/>
You could instead use a third method:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: xml; gutter: false">&lt;property name="PROC_MAIN_CLASS" value="proc.java.home"/&gt;</pre>
		</div>
</div></div>
<p>As with <tt>PROC_HOME_PROPERTY</tt>, this variable tells the MxServerDetector class to autodiscover the process with this PTQL: <tt>State.Name.eq=java,Args.*.sw=-D&lt;value of proc main class&gt;</tt>.<br/>
Any of these methods will set the installpath config variable to be the current working directory of the process in question. And while this is particularly useful for log-tracking and control plugins (which are outside the scope of this tutorial), this value is also used <a href="#JMXPluginTutorial-version">later</a> in this XML descriptor.</p>

<h3><a name="JMXPluginTutorial-AutoDiscovertheServer"></a>Auto-Discover the Server</h3>

<p>This one line of code, in conjunction with the results of the earlier <tt>process.query</tt>, implements auto-discovery in this plugin.</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: xml; gutter: false">&lt;plugin type="autoinventory" class="org.hyperic.hq.product.jmx.MxServerDetector"/&gt;</pre>
		</div>
</div></div>
<p>Keep it as-is. Autoinventory for a server must also include this class. Learn more about <a href="JMX Plugin.html#JMXPlugin-autodiscovery">auto-discovery in JMX plugins</a>.</p>

<p>This one line of code tells HQ what type of plugin this is &#8212; Measurement &#8212; and therefore how it should be run.</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: xml; gutter: false">&lt;plugin type="measurement" class="org.hyperic.hq.product.jmx.MxMeasurementPlugin"/&gt;</pre>
		</div>
</div></div>
<p>Keep it as-is.</p>

<h3><a name="JMXPluginTutorial-IdentifyandGatherMetricsfromtheServer%27sHostedServices"></a>Identify and Gather Metrics from the Server's Hosted Services</h3>

<p>This code defines the Garbage Collector as a service and collects its metrics.</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: xml; gutter: false">&lt;service name="Java GC"&gt;
&lt;plugin type="autoinventory"/&gt;
&lt;property name="OBJECT_NAME" value="java.lang:type=GarbageCollector,name=*"/&gt;
&lt;metrics include="Garbage Collector"/&gt;
&lt;/service&gt;
&lt;/server&gt;</pre>
		</div>
</div></div>
<p>If you want to collect GarbageCollector metrics, then keep as-is. Autoinventory for a service does not need a class (whereas a server does).<br/>
This code looks slightly different than the earlier <a href="#JMXPluginTutorial-metrics2">metrics-collection code</a> because there are multiple types of Garbage Collection, each of which collects the same metrics. In cases where there are numerous types, calling out each type and its respective metrics (which are identical to the other types'), is onerous and unnecessary. Using</p>
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>name=*

</pre>
</div></div>
<p>makes sure that every type of GarbageCollector gets measured. The <tt>&lt;plugin type="autoinventory"/&gt;</tt> line tells HQ to resolve the <tt>&#42;</tt>. If you want to collect metrics of another objectName that similarly has multiple types, replace <tt>Java GC</tt> with a meaningful name and <tt>GarbageCollector</tt> with the objectName, and accordingly modify the earlier <a href="#JMXPluginTutorial-metrics">metrics enumeration</a>.
<br class="atl-forced-newline" /></p>
<div class='panelMacro'><table class='infoMacro'><colgroup><col width='24'><col></colgroup><tr><td valign='top'><img src="images/icons/emoticons/information.gif" width="16" height="16" align="absmiddle" alt="" border="0"></td><td><b>Declaring Services as Metrics for Convenient Viewing</b><br />This plugin declares the Garbage Collector as a service of the Java server. It is also possible to treat it simply as a metric of the server. Why would you do that? Then all the metrics of the would be displayed in the UI on one level &#8212; the server level &#8212; and you wouldn't have to drill down from the server to the service to access the metrics.</td></tr></table></div>
<p>This code determines which part of the plugin to use depending on the version of the Java process. Just as we did <a href="#JMXPluginTutorial-server">before</a>, we provide a file &#8212; <tt>jre/lib/management-agent.jar</tt> &#8212; that only exists in Java v1.6 so that HQ can distinguish between v1.5 and v1.6. For version 1.6, the plugin includes everything that's been written for v1.5 plus anything additional we write specifically for v1.6 (in this sample, we haven't written anything additional). The install path that we specified <a href="#JMXPluginTutorial-path">above</a> is used here: the file name is resolved within that path <tt>(JAVA_HOME/jre/lib/management-agent.jar</tt>).</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: xml; gutter: false">&lt;server name="Java" version="1.6.x" include="1.5.x"&gt;
&lt;property name="VERSION_FILE" value="jre/lib/management-agent.jar"/&gt;
&lt;/server&gt;</pre>
		</div>
</div></div>

<h3><a name="JMXPluginTutorial-ProvideConfigurationInstructions"></a>Provide Configuration Instructions</h3>

<p>This code includes the configuration instructions that show up at the bottom of the resource's <b>Configuration Properties</b> page. </p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: xml; gutter: false">&lt;!--
 ==================== Plugin Help ===========================
--&gt;
&lt;help name="Java"&gt;

  &lt;p&gt;
  &lt;h3&gt;Configure HQ for monitoring Java&lt;/h3&gt;
  &lt;/p&gt;
  &lt;p&gt;
  1) Add this line to the java options when executing the binary.
  &lt;br&gt;
  "-Dcom.sun.management.jmxremote \
  &lt;br&gt;
  -Dcom.sun.management.jmxremote.port=6969 \
  &lt;br&gt;
  -Dcom.sun.management.jmxremote.ssl=false \
  &lt;br&gt;
  -Dcom.sun.management.jmxremote.authenticate=false"
  &lt;br&gt;
  &lt;/p&gt;

&lt;/help&gt;
&lt;help name="Java 1.5.x" include="Java"/&gt;
&lt;help name="Java 1.6.x" include="Java"/&gt;
&lt;/plugin&gt;</pre>
		</div>
</div></div>
<p>This help text &#8212; which are instructions for exposing MBeans &#8212; should suffice for any plugins gathering JMX metrics. If you are dealing with more than two versions, the <tt>&lt;help name="Java 1.5.x" include="Java"/&gt;</tt> lines can be augmented to include other versions. Additional lines should have the same content but with the server and version replaced with the format: <tt>server version</tt>.<br/>
If necessary, replace this help with whatever configuration instructions are necessary for getting the plugin running in your environment (prerequisites, etc.). Learn more about using the <a href="http://support.hyperic.com/display/EVO/Plugin+XML+Descriptor#PluginXMLDescriptor-helptag">help tag</a>.</p>

<h2><a name="JMXPluginTutorial-Step7TestthePlugin."></a>Step 7 - Test the Plugin.</h2>

<p>For this JMX plugin, you need to include in these commands your JMX credentials: URL, username, and password, like this:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">... -Dplugins.include=yourPluginName -Djmx.url=&lt;URL&gt; -Djmx.username=&lt;username&gt; -Djmx.password=&lt;password&gt; ...</pre>
		</div>
</div></div>

<p>For instructions, see <a href="Running and Testing Plugins from Command Line.html" title="Running and Testing Plugins from Command Line">Running and Testing Plugins from Command Line</a>.</p>

<h2><a name="JMXPluginTutorial-Step8DeploythePlugin."></a>Step 8 - Deploy the Plugin.</h2>

<p>See <a href="Deploy Plugin.html" title="Deploy Plugin">Deploy Plugin</a> for instructions.</p>

<p>Your plugin should now kick into action the next time the Agent runs (assuming it's been rebooted since the plugin was added to it), and you should see all the desired metrics in the HQ UI.</p>


<div class="scroll-pagebreak"></div>

				    
                    			    </td>
		    </tr>
	    </table>
	    <table border="0" cellpadding="0" cellspacing="0" width="100%">
			<tr>
				<td height="12" background="http://support.hyperic.com/images/border/border_bottom.gif"><img src="images/border/spacer.gif" width="1" height="1" border="0"/></td>
			</tr>
		    <tr>
			    <td align="center"><font color="grey">Document generated by Confluence on May 31, 2011 13:10</font></td>
		    </tr>
	    </table>
    </body>
</html>
