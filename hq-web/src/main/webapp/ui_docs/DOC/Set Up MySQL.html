<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
    <head>
        <title>Hyperic 4.6 Documentation : Set Up MySQL</title>
	    <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">	    
    </head>

    <body>
	    <table class="pagecontent" border="0" cellpadding="0" cellspacing="0" width="100%" bgcolor="#ffffff">
		    <tr>
			    <td valign="top" class="pagebody">
				    <div class="pageheader">
					    <span class="pagetitle">
                            Hyperic 4.6 Documentation : Set Up MySQL
                                                    </span>
				    </div>
				    <div class="pagesubheading">
					    This page last changed on Jun 07, 2011 by <font color="#0050B2">mmcgarry</font>.
				    </div>

				    <p><font color="gray"><em>Topics marked with</em></font> <font color="red">*</font> <font color="gray"><em>relate to features available only in vFabric Hyperic.</em></font></p>


<style type='text/css'>/*<![CDATA[*/
div.rbtoc1307466673249 {margin-left: 1.5em;padding: 0px;}
div.rbtoc1307466673249 ul {list-style: disc;margin-left: 0px;padding-left: 20px;}
div.rbtoc1307466673249 li {margin-left: 0px;padding-left: 0px;}

/*]] >*/</style><div class='rbtoc1307466673249'>
<ul>
    <li><a href='#SetUpMySQL-SetUpHypericDatabaseonMySQL'>Set Up Hyperic Database on MySQL</a></li>
<ul>
    <li><a href='#SetUpMySQL-Step1CreateaMySQLDatabaseInstance'>Step 1 - Create a MySQL Database Instance</a></li>
    <li><a href='#SetUpMySQL-Step2ConfigureMySQLStartupOptionsandSystemVariables'>Step 2 - Configure MySQL Startup Options and System Variables</a></li>
    <li><a href='#SetUpMySQL-Step3InstalltheHypericServer'>Step 3 - Install the Hyperic Server</a></li>
    <li><a href='#SetUpMySQL-Step4TunetheBatchAggregateInserterforMySQL'>Step 4 - Tune the Batch Aggregate Inserter for MySQL</a></li>
</ul>
    <li><a href='#SetUpMySQL-SolveProblemswithMySQLConfiguration'>Solve Problems with MySQL Configuration</a></li>
    <li><a href='#SetUpMySQL-MySQLMaintenanceExamples'>MySQL Maintenance Examples</a></li>
</ul></div>



<h1><a name="SetUpMySQL-SetUpHypericDatabaseonMySQL"></a>Set Up Hyperic Database on MySQL</h1>

<p>This section provides instructions for setting up MySQL as your external Hyperic database.  It is assumed that you have already installed MySQL and are either familiar with MySQL or have the support of someone who is.</p>

<p><b>Note:</b> If you are installing Hyperic for evaluation, you can use Hyperic's built-in PostgreSQL database, rather than set up an external database.</p>

<p>If you are new to MySQL, the introduction to MySQL at <a href="http://dev.mysql.com/tech-resources/articles/mysql_intro.html">http://dev.mysql.com/tech-resources/articles/mysql_intro.html</a> may be of interest.</p>

<h2><a name="SetUpMySQL-Step1CreateaMySQLDatabaseInstance"></a>Step 1 - Create a MySQL Database Instance</h2>

<p>Run these commands at the mysql prompt, as the root user:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">mysql&gt; create user 'hqadmin'@'&lt;hq_server_host&gt;' identified by '&lt;passwd&gt;';
mysql&gt; create database HQ CHARACTER SET utf8 COLLATE utf8_bin;
mysql&gt; grant all on HQ.* to 'hqadmin'@'&lt;hq_server_host&gt;';</pre>
		</div>
</div></div>

<p>UTF8 is required for encoding.</p>

<h2><a name="SetUpMySQL-Step2ConfigureMySQLStartupOptionsandSystemVariables"></a>Step 2 - Configure MySQL Startup Options and System Variables</h2>

<p>In this step, you configure the MySQL database, by editing the settings in its configuration file.  In Unix and Linux, the file is  /etc/my.cnf. In Windows the file is  my.ini, located in the MySQL installation base directory.</p>

<p>For more information about InnoDB startup options and system variables, see <a href="http://dev.mysql.com/doc/refman/5.0/en/innodb-parameters.html">http://dev.mysql.com/doc/refman/5.0/en/innodb-parameters.html</a></p>

<ol>
	<li>Enable the full query log. Every query (even ones with incorrect syntax) that the database server receives will be logged. This is useful for debugging, but it is usually disabled in production use. Be sure to change the paths given here to match your environment.
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">[mysqld]
log-error = /home/mysql/log/mysqld.err
log = /home/mysql/log/mysql_general.log</pre>
		</div>
</div></div></li>
	<li>Print warnings to the error log file. If you have any problem with MySQL, you should enable logging of warnings and examine the error log for possible explanations.
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">log_warnings
server-id       = 1</pre>
		</div>
</div></div></li>
	<li>Configure buffer pool size. The size of the MySQL buffer pool is has a significant impact on MySQL performance. If your database is on a dedicated machine, make the buffer pool about 80% of total memory.
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">innodb_buffer_pool_size = 256M</pre>
		</div>
</div></div></li>
	<li>Configure the frequency with which the log buffer is written to the log, and the the point at which the log is flushed to the disk. Setting <tt>innodb_flush_log_at_trx_commit</tt> to 0 dramatically increases MySQL performance, but with this setting, you are likely to lose data in the event of a server crash. If loss of data is unacceptable, set <tt>innodb_flush_log_at_trx_commit</tt> to 2. Hyperic does not recommend setting the value to 1.
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">innodb_flush_log_at_trx_commit = 2
innodb_log_buffer_size = 64M
innodb_log_file_size = 256M</pre>
		</div>
</div></div></li>
	<li>Configure innodb as the default storage engine. (Required.)
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">default-storage_engine=innodb
bulk_insert_buffer_size = 32M
join_buffer_size = 8M
max_heap_table_size = 256M
tmp_table_size = 256M
max_tmp_tables = 48
myisam_sort_buffer_size = 256M</pre>
		</div>
</div></div></li>
	<li>Configure the sort buffer size. MySQL recommends a sort_buffer_size larger than the one suggested her.
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">sort_buffer_size = 64K</pre>
		</div>
</div></div>
<div class='panelMacro'><table class='tipMacro'><colgroup><col width='24'><col></colgroup><tr><td valign='top'><img src="images/icons/emoticons/check.gif" width="16" height="16" align="absmiddle" alt="" border="0"></td><td>An article on experimenting with sort buffer size is available at <a href="http://www.mysqlperformanceblog.com/2007/08/18/how-fast-can-you-sort-data-with-mysql">http://www.mysqlperformanceblog.com/2007/08/18/how-fast-can-you-sort-data-with-mysql</a>.</td></tr></table></div></li>
	<li>Configure the read buffer size.  Because Hyperic does a significant volume of sequential reads, a large read buffer improve performance.
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">read_buffer_size = 1M
read_rnd_buffer_size = 10M
table_cache = 2048
set-variable = max_connections=400
key_buffer_size = 256M
thread_cache_size = 32</pre>
		</div>
</div></div></li>
	<li>Configure the number of threads that can run in the InnoDB kernel. A starting point for setting this value is to to set a value equal to 2 times the number of CPUs times the number of disks.
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">innodb_thread_concurrency = 8</pre>
		</div>
</div></div></li>
	<li>Set the method that is used to flush data and log files.*= For battery-backed-up storage with write-back cache mode on Linux OSs, the O_DIRECT flush method is good. Learn about <a href="http://dev.mysql.com/doc/refman/5.0/en/innodb-parameters.html#option_mysqld_innodb_flush_method">other innodb flush methods</a>.
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">innodb_flush_method=O_DIRECT
innodb_rollback_on_timeout=1</pre>
		</div>
</div></div>
	<ul>
		<li>In this situation, tune your Linux OS (version 2.6 or higher) to favor the use of main memory rather than file caches with either:
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false"># sysctl -w vm.swappiness=30</pre>
		</div>
</div></div></li>
		<li>or
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false"># echo 30 &gt;/proc/sys/vm/swappiness</pre>
		</div>
</div></div></li>
	</ul>
	</li>
	<li>Set query cache size. Generally, the higher this value, the better the performance. However, in MySQL versions older than 5.0.50, beware of setting this variable too high, as it may cause the database to pause. For more information, see the bug description at <a href="http://bugs.mysql.com/bug.php?id=21074">http://bugs.mysql.com/bug.php?id=21074</a>.
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">query_cache_size = 0</pre>
		</div>
</div></div></li>
	<li>Set query cache limit. The default value here is 1M. If the <tt>qcache_hits-to-qcache_inserts</tt> ratio is low, raise this value.
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">query_cache_limit = 8M</pre>
		</div>
</div></div></li>
	<li>Set character encoding. Hyperic requires a char encoding of utf-8*.
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">default-character-set=utf8
collation_server=utf8_bin</pre>
		</div>
</div></div></li>
</ol>


<h2><a name="SetUpMySQL-Step3InstalltheHypericServer"></a>Step 3 - Install the Hyperic Server</h2>

<p>For instructions, see <a href="Installing Hyperic.html" title="Installing Hyperic">Installing Hyperic</a>.</p>

<h2><a name="SetUpMySQL-Step4TunetheBatchAggregateInserterforMySQL"></a>Step 4 - Tune the Batch Aggregate Inserter for MySQL</h2>

<p><b>NOTE:</b>&nbsp; Perform these steps only after installing the Hyperic Server.</p>

<p>These tuning recommendations are based on a performance tuning exercise in an environment with 700 Hyperic Agents reporting to an Hyperic Server on an 8 way / 16 GB host with an MySQL database running on an 8 way / 8 GB host, each running CentOS 5, with</p>
<ul>
	<li>Workers: 4</li>
	<li>QueueSize: 4000000</li>
	<li>BatchSize: 2000</li>
</ul>


<p>With 7 hours of backfilled data the server peaked out at 2.2 million rows inserted.</p>

<p>This intent of the strategy was to keep the Batch Aggregate Inserter (BAI) on "cruise control", instead throwing threads at the queued metrics all at once and causing CPU spikes.</p>

<p>It was found that the BAI workers had no trouble keeping up with the "normal" incoming load, and in a catchup scenario (after backfilling) the high Queue Size allowed them plenty of time to catch up.</p>

<p>For a smaller deployment, consider only tweaking the number of workers down to 1 or 2. This will ease random CPU spikes and MySQL should have no problem keeping up with the incoming traffic.</p>

<p>Please NOTE these settings may not be applicable to PostgreSQL and Oracle since MySQL handles catchup scenarios much more gracefully.</p>

<p>To update the Batch Aggregate Inserter settings for MySQL run these commands at the mysql prompt as the hqadmin user:</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">mysql&gt; update HQ.EAM_CONFIG_PROPS set propvalue = 4 where propkey = 'BATCH_AGGREGATE_WORKERS';
mysql&gt; update HQ.EAM_CONFIG_PROPS set propvalue = 2000 where propkey = 'BATCH_AGGREGATE_BATCHSIZE';
mysql&gt; update HQ.EAM_CONFIG_PROPS set propvalue = 4000000 where propkey = 'BATCH_AGGREGATE_QUEUE';</pre>
		</div>
</div></div>

<h1><a name="SetUpMySQL-SolveProblemswithMySQLConfiguration"></a>Solve Problems with MySQL Configuration</h1>

<p>If MySQL fails to start and issues a message similar to this:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">InnoDB: Error: log file ./ib_logfile0 is of different size 0 5242880 bytes
InnoDB: than specified in the .cnf file 0 268435456 bytes!
080403  8:06:13 ERROR Default storage engine (InnoDB) is not available
080403  8:06:13 ERROR Aborting</pre>
		</div>
</div></div>
<p>the actual log size does not match the configured log size. &nbsp;&nbsp;</p>

<p>Delete the log files in /var/lib/mysql/ and restart MySQL.</p>

<h1><a name="SetUpMySQL-MySQLMaintenanceExamples"></a>MySQL Maintenance Examples</h1>

<p>Here are examples of regular maintenance for mysql</p>
<ol>
	<li>Simple MySQL Backup Script
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">#!/bin/sh

START=`date '+%A %Y/%m/%d %H:%M:%S'`
DAY=`date +%A`
MYSQLADMIN="/usr/bin/mysqladmin"
MYSQLDUMP="/usr/bin/mysqldump"
USER="root"
PASSWORD="mysql"
DBNAME="hqdb"
DEST="/home/mysql/dumps/$DBNAME-$DAY.sql.gz"
flushCmd="$MYSQLADMIN -u $USER -p$PASSWORD flush-logs"
dumpCmd="$MYSQLDUMP -u $USER -p$PASSWORD --quick --single-transaction $DBNAME"
gzip="gzip"
echo "Starting backup: $START"
echo "$flushCmd &amp;&amp; $dumpCmd | $gzip &gt; $DEST"
$flushCmd &amp;&amp; $dumpCmd | $gzip &gt; $DEST
END=`date '+%A %Y/%m/%d %H:%M:%S'`
echo "Backup completed: $END"</pre>
		</div>
</div></div></li>
	<li>Simple Log Rollover Scheme.  This may be done with error files, log files, etc.
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">cp /path/to/mysql/log/mysqld.err /path/to/mysql/log/mysqld-`date '+%w'`.err ;
cp /dev/null /path/to/mysql/log/mysqld.err</pre>
		</div>
</div></div></li>
	<li>Sample Unix Cron Entries (empty lines will fail in cron, beware)
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">#
#       Field 1: (0-59) minute
#       Field 2: (0-23) hour
#       Field 3: (1-31) day  of  the month
#       Field 4: (1-12) month of the year
#       Field 5: (0-6)  day of the week - 1=Monday
# ----------------------------------------------------------------------------
#
0 2 * * * backup.sh
0 1 * * * cp /path/to/mysql/log/mysqld.err /path/to/mysql/log/mysqld-`date '+%w'`.err ;
cp /dev/null /path/to/mysql/log/mysqld.err</pre>
		</div>
</div></div></li>
</ol>


<div class="scroll-pagebreak"></div>

				    
                    			    </td>
		    </tr>
	    </table>
	    <table border="0" cellpadding="0" cellspacing="0" width="100%">
			<tr>
				<td height="12" background="http://support.hyperic.com/images/border/border_bottom.gif"><img src="images/border/spacer.gif" width="1" height="1" border="0"/></td>
			</tr>
		    <tr>
			    <td align="center"><font color="grey">Document generated by Confluence on Jun 27, 2011 16:37</font></td>
		    </tr>
	    </table>
    </body>
</html>
