<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
    <head>
        <title>vFabric Hyperic 4.6.5 : Set Up MySQL</title>
	    <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">	    
    </head>

    <body>
<b><a href="vFabric Hyperic 4.6.5.html" title="vFabric Hyperic 4.6.5 Documentation Home">vFabric Hyperic 4.6.5 Documentation Home (Internal)</a>
 - <a href="https://www.vmware.com/support/pubs/vfabric-hyperic.html">vFabric Hyperic 4.6.5 Documentation Home (Online)</a>
 -  <a href="https://www.vmware.com/support/vfabric-hyperic/doc/vfabric-hyperic-rn-4.6.0.html">Hyperic 4.6.5 Release Notes</a> </b>
 <p>
 <p>
	    <table class="pagecontent" border="0" cellpadding="0" cellspacing="0" width="100%" bgcolor="#ffffff">
		    <tr>
			    <td valign="top" class="pagebody">
				    <div class="pageheader">
					    <span class="pagetitle">
                            vFabric Hyperic 4.6.5 : Set Up MySQL
                                                    </span>
				    </div>
				    <div class="pagesubheading">
					    This page last changed on Jan 04, 2012 by <font color="#0050B2">mmcgarry</font>.
				    </div>

				    <p><font color="gray"><em>Topics marked with</em></font> <font color="red">*</font> <font color="gray"><em>relate to features available only in vFabric Hyperic.</em></font></p>


<style type='text/css'>/*<![CDATA[*/
div.rbtoc1325706831362 {margin-left: 1.5em;padding: 0px;}
div.rbtoc1325706831362 ul {list-style: disc;margin-left: 0px;padding-left: 20px;}
div.rbtoc1325706831362 li {margin-left: 0px;padding-left: 0px;}

/*]]>*/</style><div class='rbtoc1325706831362'>
<ul>
    <li><a href='#SetUpMySQL-SetUpHypericDatabaseonMySQL'>Set Up Hyperic Database on MySQL</a></li>
<ul>
    <li><a href='#SetUpMySQL-Step1CreateaMySQLDatabaseInstance'>Step 1 - Create a MySQL Database Instance</a></li>
    <li><a href='#SetUpMySQL-Step2ConfigureMySQLStartupOptionsandSystemVariables'>Step 2 - Configure MySQL Startup Options and System Variables</a></li>
    <li><a href='#SetUpMySQL-Step3VerifyDatabaseSetup'>Step 3 - Verify Database Setup</a></li>
</ul>
    <li><a href='#SetUpMySQL-SolveProblemswithMySQLStartup'>Solve Problems with MySQL Startup</a></li>
    <li><a href='#SetUpMySQL-TunetheBatchAggregateInserterforMySQL'>Tune the Batch Aggregate Inserter for MySQL</a></li>
</ul></div>



<div class='panelMacro'><table class='tipMacro'><colgroup><col width='24'><col></colgroup><tr><td valign='top'><img src="images/icons/emoticons/check.gif" width="16" height="16" align="absmiddle" alt="" border="0"></td><td>For information about maintaining a MySQL Hyperic database, see <a href="MySQL Maintenance Examples.html" title="MySQL Maintenance Examples">MySQL Maintenance Examples</a>.</td></tr></table></div>

<h1><a name="SetUpMySQL-SetUpHypericDatabaseonMySQL"></a>Set Up Hyperic Database on MySQL</h1>

<p>This section has instructions for setting up MySQL as your external Hyperic database. </p>

<p>This task corresponds to <a href="Hyperic Installation and Startup Process.html#HypericInstallationandStartupProcess-SetUpDatabase">Step 2 â€“ Set Up Hyperic Database</a> of <a href="Hyperic Installation and Startup Process.html" title="Hyperic Installation and Startup Process">Hyperic Installation and Startup Process</a>. </p>

<p>It is assumed that you have already installed MySQL and are either familiar with MySQL or have the support of someone who is.</p>

<p><b>Note:</b> If you are installing Hyperic for evaluation, you can use Hyperic's built-in PostgreSQL database, rather than set up an external database.</p>


<h2><a name="SetUpMySQL-Step1CreateaMySQLDatabaseInstance"></a>Step 1 - Create a MySQL Database Instance</h2>

<p>Run these commands at the mysql prompt, as the root user:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">mysql&gt; create user 'hqadmin'@'&lt;hq_server_host&gt;' identified by '&lt;passwd&gt;';
mysql&gt; create database HQ CHARACTER SET utf8 COLLATE utf8_bin;
mysql&gt; grant all on HQ.* to 'hqadmin'@'&lt;hq_server_host&gt;';</pre>
		</div>
</div></div>

<p>UTF8 is required for encoding.</p>

<h2><a name="SetUpMySQL-Step2ConfigureMySQLStartupOptionsandSystemVariables"></a>Step 2 - Configure MySQL Startup Options and System Variables</h2>

<p>In this step, you configure the MySQL database by editing the settings in its configuration file. For Unix-like environments, the file is <tt>/etc/my.cnf</tt>. On Windows the file is <tt>my.ini</tt>, located in the MySQL installation base directory.</p>

<p>For more information about InnoDB startup options and system variables, see <a href="http://dev.mysql.com/doc/refman/5.0/en/innodb-parameters.html">http://dev.mysql.com/doc/refman/5.0/en/innodb-parameters.html</a>.</p>

<ol>
	<li>Enable the full query log. Every query (even ones with incorrect syntax) that the database server receives will be logged. This is useful for debugging, but it is usually disabled in production use. Be sure to change the paths given here to match your environment.
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">[mysqld]
log-error = mysqld.err
log = mysql_general.log</pre>
		</div>
</div></div></li>
	<li>Print warnings to the error log file. If you have any problem with MySQL, you should enable logging of warnings and examine the error log for possible explanations.
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">log_warnings</pre>
		</div>
</div></div></li>
	<li>Configure buffer pool size. The size of the MySQL buffer pool is has a significant impact on MySQL performance. If your database is on a dedicated machine, make the buffer pool about 80% of total memory.
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">innodb_buffer_pool_size = 256M</pre>
		</div>
</div></div></li>
	<li>Configure the frequency with which the log buffer is written to the log, and the the point at which the log is flushed to the disk. Setting <tt>innodb_flush_log_at_trx_commit</tt> to 0 dramatically increases MySQL performance, but with this setting, you are likely to lose data in the event of a server crash. If loss of data is unacceptable, set <tt>innodb_flush_log_at_trx_commit</tt> to 2. Hyperic does not recommend setting the value to 1.
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">innodb_flush_log_at_trx_commit = 2
innodb_log_buffer_size = 64M
innodb_log_file_size = 256M</pre>
		</div>
</div></div></li>
	<li>Configure innodb as the default storage engine. (Required.)
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">default-storage-engine=innodb
bulk_insert_buffer_size = 32M
join_buffer_size = 8M
max_heap_table_size = 256M
tmp_table_size = 256M
max_tmp_tables = 48
myisam_sort_buffer_size = 256M</pre>
		</div>
</div></div></li>
	<li>Configure the sort buffer size. MySQL recommends a <tt>sort_buffer_size</tt> larger than the one suggested her.
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">sort_buffer_size = 64K</pre>
		</div>
</div></div>
<div class='panelMacro'><table class='tipMacro'><colgroup><col width='24'><col></colgroup><tr><td valign='top'><img src="images/icons/emoticons/check.gif" width="16" height="16" align="absmiddle" alt="" border="0"></td><td>An article on experimenting with sort buffer size is available at <a href="http://www.mysqlperformanceblog.com/2007/08/18/how-fast-can-you-sort-data-with-mysql">http://www.mysqlperformanceblog.com/2007/08/18/how-fast-can-you-sort-data-with-mysql</a>.</td></tr></table></div></li>
	<li>Configure the read buffer size.Because Hyperic does a significant volume of sequential reads, a large read buffer improves performance.
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">read_buffer_size = 1M
read_rnd_buffer_size = 10M
table_cache = 2048
set-variable = max_connections=400
key_buffer_size = 256M
thread_cache_size = 32</pre>
		</div>
</div></div></li>
	<li>Configure the number of threads that can run in the InnoDB kernel. A starting point for setting this value is to set a value equal to 2 times the number of CPUs times the number of disks.
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">innodb_thread_concurrency = 8</pre>
		</div>
</div></div></li>
	<li>Set the method that is used to flush data and log files. For battery-backed-up storage with write-back cache mode on Linux systems, the <tt>O_DIRECT</tt> flush method is good. For information other other innodb flush methods see <a href="http://dev.mysql.com/doc/refman/5.0/en/innodb-parameters.html#option_mysqld_innodb_flush_method">http://dev.mysql.com/doc/refman/5.0/en/innodb-parameters.html#option_mysqld_innodb_flush_method</a>.
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">innodb_flush_method=O_DIRECT
innodb_rollback_on_timeout=1</pre>
		</div>
</div></div>
<div class='panelMacro'><table class='tipMacro'><colgroup><col width='24'><col></colgroup><tr><td valign='top'><img src="images/icons/emoticons/check.gif" width="16" height="16" align="absmiddle" alt="" border="0"></td><td>On Windows the flush method is always <tt>async_unbuffered</tt>. You do not need to set <tt>innodb_flush_method=O_DIRECT</tt> on Windows platforms.</td></tr></table></div> 
	<ul>
		<li>In this situation, tune your Linux OS (version 2.6 or higher) to favor the use of main memory rather than file caches with either:
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false"># sysctl -w vm.swappiness=30</pre>
		</div>
</div></div></li>
		<li>or
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false"># echo 30 &gt;/proc/sys/vm/swappiness</pre>
		</div>
</div></div></li>
	</ul>
	</li>
	<li>Set query cache size. Generally, the higher this value, the better the performance. However, in MySQL versions older than 5.0.50, beware of setting this variable too high, as it may cause the database to pause. For more information, see the bug description at <a href="http://bugs.mysql.com/bug.php?id=21074">http://bugs.mysql.com/bug.php?id=21074</a>.
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">query_cache_size = 0</pre>
		</div>
</div></div></li>
	<li>Set query cache limit. The default value here is 1M. If the <tt>qcache_hits-to-qcache_inserts</tt> ratio is low, raise this value.
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">query_cache_limit = 8M</pre>
		</div>
</div></div></li>
	<li>Set character encoding. Hyperic requires a char encoding of utf-8.
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">default-character-set=utf8
collation_server=utf8_bin
character_set_system=utf8</pre>
		</div>
</div></div></li>
</ol>


<h2><a name="SetUpMySQL-Step3VerifyDatabaseSetup"></a>Step 3 - Verify Database Setup</h2>

<p>instructions tbd</p>


<div class='panelMacro'><table class='tipMacro'><colgroup><col width='24'><col></colgroup><tr><td valign='top'><img src="images/icons/emoticons/check.gif" width="16" height="16" align="absmiddle" alt="" border="0"></td><td>After the database is created, you can set up Hyperic Server following the instructions in <a href="Hyperic Installation and Startup Process.html#HypericInstallationandStartupProcess-SetUpServer">Step 3 - Set Up Hyperic Server</a> of the <a href="Hyperic Installation and Startup Process.html" title="Hyperic Installation and Startup Process">Hyperic Installation and Startup Process</a>.</td></tr></table></div>

<h1><a name="SetUpMySQL-SolveProblemswithMySQLStartup"></a>Solve Problems with MySQL Startup</h1>

<p>If MySQL fails to start and issues a message similar to this:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">InnoDB: Error: log file ./ib_logfile0 is of different size 0 5242880 bytes
InnoDB: than specified in the .cnf file 0 268435456 bytes!
080403  8:06:13 ERROR Default storage engine (InnoDB) is not available
080403  8:06:13 ERROR Aborting</pre>
		</div>
</div></div>
<p>the actual log size does not match the configured log size. &nbsp;&nbsp;</p>

<p>Delete the log files in <tt>/var/lib/mysql/</tt> and restart MySQL.</p>

<h1><a name="SetUpMySQL-TunetheBatchAggregateInserterforMySQL"></a>Tune the Batch Aggregate Inserter for MySQL</h1>
<p><a name="SetUpMySQL-BatchAgg"></a></p>
<div class='panelMacro'><table class='warningMacro'><colgroup><col width='24'><col></colgroup><tr><td valign='top'><img src="images/icons/emoticons/forbidden.gif" width="16" height="16" align="absmiddle" alt="" border="0"></td><td>Do this tuning <em>after</em> installing the Hyperic Server.</td></tr></table></div>

<p>These tuning recommendations are based on a performance tuning exercise in an environment with 700 Hyperic Agents reporting to an Hyperic Server on an 8 way / 16 GB host with an MySQL database running on an 8 way / 8 GB host, each running CentOS 5, with</p>
<ul>
	<li>Workers: 4</li>
	<li>QueueSize: 4000000</li>
	<li>BatchSize: 2000</li>
</ul>


<p>With 7 hours of backfilled data the server peaked out at 2.2 million rows inserted.</p>

<p>This intent of the strategy was to keep the Batch Aggregate Inserter (BAI) on "cruise control", instead throwing threads at the queued metrics all at once and causing CPU spikes.</p>

<p>It was found that the BAI workers had no trouble keeping up with the "normal" incoming load, and in a catchup scenario (after backfilling) the high Queue Size allowed them plenty of time to catch up.</p>

<p>For a smaller deployment, consider only tweaking the number of workers down to 1 or 2. This will ease random CPU spikes and MySQL should have no problem keeping up with the incoming traffic.</p>

<p>Please NOTE these settings may not be applicable to PostgreSQL and Oracle since MySQL handles catchup scenarios much more gracefully.</p>

<p>To update the Batch Aggregate Inserter settings for MySQL run these commands at the mysql prompt as the hqadmin user:</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">mysql&gt; update HQ.EAM_CONFIG_PROPS set propvalue = 4 where propkey = 'BATCH_AGGREGATE_WORKERS';
mysql&gt; update HQ.EAM_CONFIG_PROPS set propvalue = 2000 where propkey = 'BATCH_AGGREGATE_BATCHSIZE';
mysql&gt; update HQ.EAM_CONFIG_PROPS set propvalue = 4000000 where propkey = 'BATCH_AGGREGATE_QUEUE';</pre>
		</div>
</div></div>



				    
                    			    </td>
		    </tr>
	    </table>
	    <table border="0" cellpadding="0" cellspacing="0" width="100%">
			<tr>
				<td height="12" background="http://support.hyperic.com/images/border/border_bottom.gif"><img src="images/border/spacer.gif" width="1" height="1" border="0"/></td>
			</tr>
		    <tr>
			    <td align="center"><font color="grey">Document generated by Confluence on Feb 06, 2012 14:52</font></td>
		    </tr>
	    </table>
    </body>
</html>
