<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
    <head>
        <title>Hyperic 4.6 Documentation : Sample Plugin</title>
	    <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">	    
    </head>

    <body>
	    <table class="pagecontent" border="0" cellpadding="0" cellspacing="0" width="100%" bgcolor="#ffffff">
		    <tr>
			    <td valign="top" class="pagebody">
				    <div class="pageheader">
					    <span class="pagetitle">
                            Hyperic 4.6 Documentation : Sample Plugin
                                                    </span>
				    </div>
				    <div class="pagesubheading">
					    This page last changed on Jun 07, 2011 by <font color="#0050B2">mmcgarry</font>.
				    </div>

				    <p>This section describes HQ's Currently Down view, an HQU Plugin, and provides a listing of its controller file.</p>
<h1><a name="SamplePlugin-CurrentlyDownView"></a><b>Currently Down View</b> </h1>
<p>This screen allows users to centrally view all the managed resources (platforms, servers, and services) that are currently unavailable and when they went down. The screen automatically refreshes every minute, but users can also refresh it manually.</p>
<ul>
	<li>Resource Types—Presents down resources by inventory level and resource type. Users can expand or collapse the view, and listall down resources of a particular resource type by clicking the type here.</li>
	<li>Availability—Lists the down resources of the resource type selected in "Resource Types." The default sort order is by Down Time (from longest to shortest). Users cannot page through the list of down resources; they must instead select a number of resources to be displayed. This section also provides a link to the resource's alerts (where any alerts triggered by the resource's unavailability will be listed).</li>
	<li>Resource: Name of the down resource</li>
	<li>Type: The resource's platform, server, or service type</li>
	<li>Down Since: The time at which the resource became unavailable</li>
	<li>Down Time: The length of time the resource has been unavailable</li>
	<li>Alerts: The icon links to a list of alerts for this resource</li>
</ul>


<p><span class="image-wrap" style=""><img src="attachments/77464119/77660726.png" height="396" width="664" style="border: 0px solid black"/></span></p>
<h1><a name="SamplePlugin-SystemsdownController.groovy"></a><b>SystemsdownController.groovy</b></h1>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div id="root">
		<pre class="theme: Confluence; brush: java; gutter: false">import java.text.DateFormat
import java.util.Locale
import org.hyperic.util.units.FormatSpecifics
import org.hyperic.util.units.UnitsConstants
import org.hyperic.util.units.UnitsFormat
import org.hyperic.util.units.UnitNumber
import org.hyperic.hq.hqu.rendit.html.DojoUtil
import org.hyperic.hq.hqu.rendit.BaseController
import org.hyperic.hq.appdef.server.session.DownResSortField

class SystemsdownController extends BaseController 
{
    private final DateFormat df = 
        DateFormat.getDateTimeInstance(DateFormat.SHORT, DateFormat.MEDIUM)

    private getAlertListImg() {
        def imgUrl = urlFor(asset:'images') +
            "/icon_zoom.gif"
        """&lt;img src="${imgUrl}" width="16" height="16" border="0"
                class="alertListIcon" title="Click to go to the alert list for this resource"&gt;"""
    }

    private final SYSTEMSDOWN_SCHEMA = [
        getData: {pageInfo, params -&gt; 
            resourceHelper.getDownResources(params.getOne('typeId'), pageInfo)
        },
        defaultSort: DownResSortField.DOWNTIME,
        defaultSortOrder: 1,  // descending
        columns: [
            [field:DownResSortField.RESOURCE, width:'37%',
             label:{linkTo(it.name,
                           [resource:it.resource.entityId])}],
            [field:DownResSortField.TYPE, width:'30%',
             label:{it.type}],
            [field:DownResSortField.SINCE, width:'15%',
             label:{df.format(it.timestamp)}],
            [field:DownResSortField.DOWNTIME, width:'13%',
             //label:{formatDuration(it.duration)}
              label:{formatDuration(it.duration)}
              ],
            [field:DownResSortField.ALERTS, width:'5%',
             label:{
             linkTo(getAlertListImg(), [resource:it,rawLabel:true])
             }],
        ]
    ]
   
   def SystemsdownController() {
        setTemplate('standard')
    }
    
    def getNow() {
        System.currentTimeMillis()
    }

    def formatDuration(d) {
        return UnitsFormat.format(new UnitNumber(d, UnitsConstants.UNIT_DURATION,
                                                 UnitsConstants.SCALE_MILLI),
                                  Locale.getDefault(), null).toString()
    }

    def index(params) {
     render(locals:[ systemsDownSchema : SYSTEMSDOWN_SCHEMA, numRows : params.numRows])
    }

    def data(params) {
        def json = DojoUtil.processTableRequest(SYSTEMSDOWN_SCHEMA , params)
  render(inline:"/* ${json} */", contentType:'text/json-comment-filtered')
    }

    def getTypeJSON(type, count) {
        def json = ""
        if (type != null) {
            json += "{name: \"" + type.name + "\", id: \""
            json += type.appdefType + ":" + type.id + "\", count: " + count + "}"
        }
        return json
    }

    def summary(params) {
        def map = resourceHelper.downResourcesMap.entrySet()

        def json = "[\n"

        def appdefType = 1
        def first = true
        map.each { entry -&gt;
            def list = entry.value

            if (list.size() &gt; 0) {
             if (first) {
              first = false
             }
             else {
                 json += ",\n"
             }
 
                json += "{parent: \"" + entry.key + "\",\n" +
                        "id: " + appdefType + ",\n" +
                        "count: " + list.size() + ",\n" +
                        "children:[\n"
    
                def previous = null
                def count = 0
    
                list.each { type -&gt;
                    if (previous == null || previous.name != type.name) {
                        json += getTypeJSON(previous, count)

                        if (previous != null) {
                            json += ",\n"
                        }

                        previous = type
                        count = 0
                    }
    
                    count++
                }

                json += getTypeJSON(previous, count)
                json += "]\n}"
            }
            appdefType++
        }

        json += "]"
  render(inline:"/* ${json} */", contentType:'text/json-comment-filtered')
    }
}</pre>
		</div>
</div></div>

				    					    <br/>
                        <div class="tabletitle">
                            <a name="attachments">
                                <h2>Attachments:</h2>
                            </a>
                        </div>

                        <div class="greybox" align="left">
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/77464119/77660726.png">worddavb3778b872a564e95c0430e24e5508208.png</a> (image/png)
                                <br/>
                                                    </div>
				    
                    			    </td>
		    </tr>
	    </table>
	    <table border="0" cellpadding="0" cellspacing="0" width="100%">
			<tr>
				<td height="12" background="http://support.hyperic.com/images/border/border_bottom.gif"><img src="images/border/spacer.gif" width="1" height="1" border="0"/></td>
			</tr>
		    <tr>
			    <td align="center"><font color="grey">Document generated by Confluence on Jun 28, 2011 15:25</font></td>
		    </tr>
	    </table>
    </body>
</html>
